<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحدي التداول - اربح 5$</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .section { display: none; animation: fadeIn 0.5s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            animation: fadeIn 0.3s ease-in-out;
        }
        .modal-content {
            animation: slideIn 0.3s ease-in-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .task-progress-bar div { transition: width 0.5s ease-in-out; }
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="container mx-auto p-4 max-w-5xl">

        <!-- Header -->
        <header class="text-center mb-10 md:relative bg-gray-800/50 p-4 rounded-xl border-b border-gray-700">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">تحدي التداول اليومي</h1>
            <p class="text-gray-300 mt-2">أكمل المهام لمدة 3 أيام واربح 5$ حقيقية!</p>
            <div id="user-info" class="hidden relative mt-4 md:absolute md:top-4 md:right-4 md:mt-0 bg-gray-900/50 p-2 rounded-lg text-sm flex items-center justify-center">
                <span id="username-display"></span>
                <button id="withdrawal-btn" class="text-cyan-400 hover:text-cyan-500 mx-4 font-bold">[السحب]</button>
                <button id="logout-btn" class="text-red-400 hover:text-red-500 font-bold">[خروج]</button>
            </div>
        </header>
        
        <!-- Loading Spinner -->
        <div id="app-loader" class="section active">
            <div class="loader"></div>
            <p class="text-center text-gray-400">جاري التحميل...</p>
        </div>

        <!-- Auth Section -->
        <section id="auth-section" class="section bg-gray-800 p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <div id="register-form-container" class="auth-form active">
                <h2 class="text-3xl font-semibold mb-4 text-center">إنشاء حساب جديد</h2>
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-username" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white" placeholder="اسم المستخدم (باللغة الإنجليزية)" required>
                    <input type="email" id="register-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white" placeholder="البريد الإلكتروني" required>
                    <input type="password" id="register-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white" placeholder="كلمة المرور" required>
                    <button type="submit" id="register-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg text-lg">إنشاء حساب</button>
                </form>
                <p class="text-center mt-4 text-gray-400">لديك حساب بالفعل؟ <a href="#" id="show-login" class="text-cyan-400 hover:underline">سجل الدخول</a></p>
            </div>
            <div id="login-form-container" class="auth-form">
                <h2 class="text-3xl font-semibold mb-4 text-center">تسجيل الدخول</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white" placeholder="البريد الإلكتروني" required>
                    <input type="password" id="login-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white" placeholder="كلمة المرور" required>
                    <button type="submit" id="login-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg">دخول</button>
                </form>
                <p class="text-center mt-4 text-gray-400">ليس لديك حساب؟ <a href="#" id="show-register" class="text-cyan-400 hover:underline">أنشئ حساباً جديداً</a></p>
            </div>
            <div id="auth-message" class="text-center text-red-400 mt-4 h-5"></div>
        </section>

        <!-- Welcome Section -->
        <section id="welcome-section" class="section text-center bg-gray-800 p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-4">مرحباً بك في التحدي!</h2>
            <p class="text-lg text-gray-300 mb-6 max-w-2xl mx-auto">أنت على وشك بدء تحدي تداول مثير. أكمل المهام اليومية لمدة 3 أيام متتالية لتحصل على 5$.</p>
            <button id="start-challenge-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg text-lg">ابدأ التحدي الآن</button>
        </section>

        <!-- KYC SECTION -->
        <section id="kyc-section" class="section bg-gray-800 p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-2 text-center">الخطوة الأولى: توثيق الهوية (KYC)</h2>
            <p class="text-center text-gray-400 mb-6">لإكمال عملية التوثيق، الرجاء اتباع الخطوات التالية بدقة.</p>
            
            <div class="bg-gray-700 p-6 rounded-lg text-center">
                <h3 class="text-xl font-bold mb-4 text-cyan-400">تعليمات التوثيق</h3>
                <p class="mb-4">الرجاء إرسال المستندات التالية إلى حساب التيليجرام الخاص بالتوثيق:</p>
                <ul class="list-disc list-inside text-right mb-4 inline-block">
                    <li>صورة أمامية للهوية</li>
                    <li>صورة خلفية للهوية</li>
                    <li>صورة شخصية (سيلفي) وأنت تحمل الهوية</li>
                    <li>فيديو قصير (13 ثانية) وأنت تحمل الهوية</li>
                </ul>
                <p class="mb-4">**مهم:** لا تنس إرسال البريد الإلكتروني الذي سجلت به في الموقع مع المستندات.</p>
                <a id="telegram-link" href="https://t.me/kycverifice" target="_blank" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg mb-6 transition-transform transform hover:scale-105">
                    إرسال المستندات عبر تيليجرام
                </a>
                <p class="text-sm text-gray-400">بعد الضغط على الرابط أعلاه، سيتم تفعيل الزر أدناه لتأكيد الإرسال.</p>
            </div>

            <button id="kyc-submitted-btn" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>
                لقد أرسلت المستندات، حسابي في انتظار المراجعة
            </button>
            <div id="kyc-pending-message" class="hidden text-center mt-4 p-4 bg-yellow-900/50 rounded-lg">
                <p>شكراً لك. طلبك الآن قيد المراجعة.</p>
                <p class="text-sm text-gray-400">سيتم تفعيل حسابك بعد التحقق من المستندات. يمكنك إغلاق الصفحة والعودة لاحقًا للتحقق.</p>
            </div>
        </section>

        <!-- TRADING SECTION -->
        <section id="trading-section" class="section">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Trading Panel -->
                <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                    <h3 class="text-xl font-bold mb-6 border-b border-gray-700 pb-3">لوحة التداول</h3>
                    <div class="flex-grow space-y-6">
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">الرصيد الافتراضي</p>
                            <p id="balance" class="text-4xl font-bold text-cyan-400">$1,000.00</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-400 text-sm">سعر الأصل (BTC/USD)</p>
                            <p id="asset-price" class="text-5xl font-bold price-up">$60,000.00</p>
                        </div>
                        <div class="space-y-4 pt-4">
                            <input type="number" id="trade-amount" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3 text-center text-lg" placeholder="أدخل المبلغ">
                            <button id="buy-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg text-lg">شراء</button>
                            <button id="sell-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg text-lg">بيع</button>
                        </div>
                    </div>
                    <div id="trade-message" class="mt-4 text-center h-6"></div>
                </div>
                <!-- Task Panel -->
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">تقدمك في التحدي</h3>
                    <div class="bg-gray-700 p-4 rounded-lg mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">اليوم الحالي: <span id="current-day">1</span> / 3</span>
                            <span id="days-progress-text" class="text-sm text-cyan-400">0%</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-4 task-progress-bar">
                            <div id="days-progress-bar" class="bg-cyan-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="task-container" class="bg-gray-900 p-6 rounded-lg">
                        <!-- Task content will be injected by JS -->
                    </div>
                    
                    <button id="next-day-btn" class="hidden mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">انتقل لليوم التالي</button>
                </div>
            </div>
        </section>
        
        <!-- WITHDRAWAL SECTION -->
        <section id="withdrawal-section" class="section bg-gray-800 p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-6 text-center">سحب الأرباح</h2>
            <div id="withdrawal-form-container"></div>
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">سجل السحوبات</h3>
                <div id="withdrawal-history-container"></div>
            </div>
            <button id="back-to-trade-from-withdrawal-btn" class="mt-8 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">العودة إلى التداول</button>
        </section>

        <section id="success-section" class="section text-center bg-gray-800 p-8 rounded-xl shadow-lg">
             <h2 class="text-3xl font-semibold mb-4 text-cyan-400">✅ تم استلام طلبك بنجاح!</h2>
             <p class="text-lg text-gray-300">ستتم مراجعة طلبك وتحويل 5$ إلى حسابك خلال 24-48 ساعة. يمكنك متابعة حالة الطلب من صفحة السحب.</p>
             <button id="back-to-trade-btn" class="mt-6 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">العودة للتداول</button>
        </section>

    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 text-center max-w-sm mx-auto modal-content">
            <div class="text-green-400 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-2xl font-bold mb-2">أحسنت!</h3>
            <p id="modal-message" class="text-gray-300 mb-6">لقد أكملت المهمة بنجاح.</p>
            <button id="close-modal-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-8 rounded-lg">متابعة</button>
        </div>
    </div>

    <script type="module">
        /*
        [مهم جداً] قواعد أمان Firestore المطلوبة
        =========================================
        هذا التطبيق يتطلب تحديث قواعد الأمان في مشروع Firebase الخاص بك ليعمل بشكل صحيح.

        1. اذهب إلى مشروعك في Firebase Console.
        2. اختر "Firestore Database" من قائمة "Build".
        3. اضغط على تبويب "Rules".
        4. احذف القواعد الموجودة والصق هذه القواعد بدلاً منها:

        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            
            match /usernames/{username} {
              allow read: if true;
              allow write: if request.auth != null;
            }

            match /users/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }

            match /withdrawals/{withdrawalId} {
              allow read: if request.auth != null && resource.data.userId == request.auth.uid;
              allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
            }
          }
        }

        5. اضغط على "Publish".
        */

        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCg8-1mCCdJm_5a3920D9q3IOjezg3-D_Y",
            authDomain: "trading-56231.firebaseapp.com",
            projectId: "trading-56231",
            storageBucket: "trading-56231.firebasestorage.app",
            messagingSenderId: "158943830558",
            appId: "1:158943830558:web:951042cf11154a3745440f",
            measurementId: "G-0SYT3WP306"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & VARS ---
        let state = {};
        let currentUserId = null;
        let countdownInterval = null;
        let priceInterval = null;

        const defaultState = {
            kycVerified: false,
            kycPending: false,
            currentDay: 1,
            balance: 1000,
            withdrawalRequested: false,
            days: [
                { // Day 1
                    tasks: [
                        { description: "شراء بيتكوين بقيمة 50$", action: 'buy', amount: 50, completed: false },
                        { description: "بيع بيتكوين بقيمة 75$", action: 'sell', amount: 75, completed: false },
                        { description: "شراء بيتكوين بقيمة 100$", action: 'buy', amount: 100, completed: false }
                    ],
                    allTasksCompleted: false,
                    completionTimestamp: null
                },
                { // Day 2
                    tasks: [
                        { description: "شراء بيتكوين بقيمة 125$", action: 'buy', amount: 125, completed: false },
                        { description: "شراء بيتكوين بقيمة 150$", action: 'buy', amount: 150, completed: false },
                        { description: "بيع بيتكوين بقيمة 200$", action: 'sell', amount: 200, completed: false }
                    ],
                    allTasksCompleted: false,
                    completionTimestamp: null
                },
                { // Day 3
                    tasks: [
                        { description: "بيع بيتكوين بقيمة 250$", action: 'sell', amount: 250, completed: false },
                        { description: "شراء بيتكوين بقيمة 300$", action: 'buy', amount: 300, completed: false },
                        { description: "بيع بيتكوين بقيمة 350$", action: 'sell', amount: 350, completed: false }
                    ],
                    allTasksCompleted: false,
                    completionTimestamp: null
                }
            ]
        };
        
        // --- DOM ELEMENTS ---
        const allSections = document.querySelectorAll('.section');
        const appLoader = document.getElementById('app-loader');
        const userInfoEl = document.getElementById('user-info');
        const usernameDisplayEl = document.getElementById('username-display');
        const logoutBtn = document.getElementById('logout-btn');
        const withdrawalBtn = document.getElementById('withdrawal-btn');
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const showLoginLink = document.getElementById('show-login');
        const showRegisterLink = document.getElementById('show-register');
        const registerContainer = document.getElementById('register-form-container');
        const loginContainer = document.getElementById('login-form-container');
        const authMessageEl = document.getElementById('auth-message');
        const startChallengeBtn = document.getElementById('start-challenge-btn');
        const kycSubmittedBtn = document.getElementById('kyc-submitted-btn');
        const kycPendingMessage = document.getElementById('kyc-pending-message');
        const telegramLink = document.getElementById('telegram-link');
        const balanceEl = document.getElementById('balance');
        const assetPriceEl = document.getElementById('asset-price');
        const tradeAmountInput = document.getElementById('trade-amount');
        const buyBtn = document.getElementById('buy-btn');
        const sellBtn = document.getElementById('sell-btn');
        const tradeMessageEl = document.getElementById('trade-message');
        const currentDayEl = document.getElementById('current-day');
        const taskContainer = document.getElementById('task-container');
        const nextDayBtn = document.getElementById('next-day-btn');
        const daysProgressBar = document.getElementById('days-progress-bar');
        const daysProgressText = document.getElementById('days-progress-text');
        const withdrawalFormContainer = document.getElementById('withdrawal-form-container');
        const withdrawalHistoryContainer = document.getElementById('withdrawal-history-container');
        const backToTradeBtn = document.getElementById('back-to-trade-btn');
        const backToTradeFromWithdrawalBtn = document.getElementById('back-to-trade-from-withdrawal-btn');
        const successModal = document.getElementById('success-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalMessage = document.getElementById('modal-message');

        // --- CORE FUNCTIONS ---
        function showSection(sectionId) {
            allSections.forEach(s => s.classList.toggle('active', s.id === sectionId));
        }
        async function saveData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            await setDoc(userDocRef, state, { merge: true });
        }
        function renderUI() {
            if (!currentUserId) return;
            balanceEl.innerText = `$${state.balance.toFixed(2)}`;
            currentDayEl.innerText = state.currentDay;
            updateOverallProgress();
            renderTasks();
        }

        // --- AUTH FUNCTIONS ---
        async function handleRegister(e) {
            e.preventDefault();
            registerBtn.disabled = true; registerBtn.textContent = 'جاري الإنشاء...'; authMessageEl.textContent = '';
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            if (!username || !/^[a-zA-Z0-9]+$/.test(username)) { authMessageEl.textContent = "اسم المستخدم يجب أن يحتوي على حروف وأرقام إنجليزية فقط."; registerBtn.disabled = false; registerBtn.textContent = 'إنشاء حساب'; return; }
            const usernameLower = username.toLowerCase();
            const usernameRef = doc(db, "usernames", usernameLower);
            try {
                const usernameSnap = await getDoc(usernameRef);
                if (usernameSnap.exists()) { authMessageEl.textContent = "اسم المستخدم هذا مستخدم بالفعل."; registerBtn.disabled = false; registerBtn.textContent = 'إنشاء حساب'; return; }
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username });
                const userDocRef = doc(db, "users", user.uid);
                const initialUserData = JSON.parse(JSON.stringify(defaultState));
                initialUserData.username = username;
                await setDoc(userDocRef, initialUserData);
                await setDoc(usernameRef, { userId: user.uid });
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') { authMessageEl.textContent = "هذا البريد الإلكتروني مسجل بالفعل."; }
                else if (error.code === 'permission-denied') { authMessageEl.textContent = "خطأ في الأذونات. الرجاء تحديث قواعد الأمان في Firebase."; }
                else { authMessageEl.textContent = "حدث خطأ غير متوقع."; console.error("Registration Error:", error); }
            } finally {
                registerBtn.disabled = false; registerBtn.textContent = 'إنشاء حساب';
            }
        }
        async function handleLogin(e) {
            e.preventDefault();
            loginBtn.disabled = true; loginBtn.textContent = 'جاري الدخول...'; authMessageEl.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) { authMessageEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة."; }
            finally { loginBtn.disabled = false; loginBtn.textContent = 'دخول'; }
        }
        function handleLogout() { 
            if (priceInterval) clearInterval(priceInterval);
            signOut(auth); 
        }

        // --- TASK LOGIC ---
        function renderTasks() {
            const dayIndex = state.currentDay - 1;
            if (!state || !state.days || !state.days[dayIndex]) { taskContainer.innerHTML = `<p>جاري تحميل المهام...</p>`; return; }
            const currentDayData = state.days[dayIndex];
            if (currentDayData.allTasksCompleted) { checkDayCompletion(); return; }
            const taskToDisplay = currentDayData.tasks.find(t => !t.completed);
            if (taskToDisplay) {
                taskContainer.innerHTML = `
                    <h4 class="text-lg font-semibold mb-4 text-center">المهمة الحالية (اليوم ${state.currentDay})</h4>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-xl">${taskToDisplay.description}</p>
                        <p class="text-sm text-gray-400 mt-2">نفذ الصفقة المطلوبة في لوحة التداول لإكمالها.</p>
                    </div>
                `;
            } else {
                checkDayCompletion();
            }
        }
        async function handleTrade(event) {
            const dayIndex = state.currentDay - 1;
            const currentDayData = state.days[dayIndex];
            const taskToComplete = currentDayData.tasks.find(t => !t.completed);
            if (!taskToComplete) { showTradeMessage('لقد أكملت جميع مهام اليوم بالفعل.', 'info'); return; }
            const amount = parseFloat(tradeAmountInput.value);
            const action = event.target.id === 'buy-btn' ? 'buy' : 'sell';
            if (isNaN(amount) || amount <= 0) { showTradeMessage('مبلغ غير صالح.', 'error'); return; }
            if (amount > state.balance) { showTradeMessage('رصيدك غير كافٍ.', 'error'); return; }
            if (action === taskToComplete.action && amount === taskToComplete.amount) {
                taskToComplete.completed = true;
                state.balance -= amount * 0.001; // Simulate fee
                await saveData();
                renderUI();
                showSuccessModal(); // Show success modal instead of small message
            } else {
                showTradeMessage('صفقة خاطئة! المهمة الحالية تتطلب إجراء مختلف.', 'error');
            }
        }
        function showTradeMessage(message, type) {
            let colorClass = 'text-gray-400';
            if (type === 'success') colorClass = 'text-green-400';
            if (type === 'error') colorClass = 'text-red-400';
            tradeMessageEl.textContent = message;
            tradeMessageEl.className = `mt-4 text-center h-6 ${colorClass}`;
            setTimeout(() => tradeMessageEl.textContent = '', 2000);
        }
        async function checkDayCompletion() {
            const dayIndex = state.currentDay - 1;
            if (!state.days || !state.days[dayIndex]) return;
            const currentDayData = state.days[dayIndex];
            const allDone = currentDayData.tasks.every(t => t.completed);
            if (allDone && !currentDayData.allTasksCompleted) {
                currentDayData.allTasksCompleted = true;
                currentDayData.completionTimestamp = Date.now();
                await saveData();
            }
            if (currentDayData.allTasksCompleted) {
                nextDayBtn.classList.add('hidden');
                const twentyFourHours = 24 * 60 * 60 * 1000;
                const timePassed = Date.now() - currentDayData.completionTimestamp;
                const timeRemaining = twentyFourHours - timePassed;
                if (timeRemaining <= 0) {
                    taskContainer.innerHTML = `<h4 class="text-lg font-semibold mb-2 text-green-400">✅ اكتمل اليوم ${state.currentDay}!</h4><p>يمكنك الآن الانتقال إلى اليوم التالي.</p>`;
                    if (state.currentDay < 3) {
                        nextDayBtn.classList.remove('hidden');
                        nextDayBtn.innerText = `انتقل لليوم ${state.currentDay + 1}`;
                    } else {
                         nextDayBtn.classList.remove('hidden');
                         nextDayBtn.innerText = 'إنهاء التحدي وطلب السحب';
                    }
                } else {
                    displayCountdown(timeRemaining);
                }
            } else {
                 nextDayBtn.classList.add('hidden');
            }
        }
        function displayCountdown(ms) {
            clearInterval(countdownInterval);
            taskContainer.innerHTML = `<h4 class="text-lg font-semibold mb-2 text-cyan-400">اليوم مكتمل!</h4><p>سيتم فتح اليوم التالي خلال:</p><div id="countdown" class="text-3xl font-bold my-2"></div>`;
            const countdownEl = document.getElementById('countdown');
            countdownInterval = setInterval(() => {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                ms -= 1000;
                if (ms < 0) {
                    clearInterval(countdownInterval);
                    renderTasks();
                }
            }, 1000);
        }
        async function handleNextDay() {
            if (state.currentDay < 3) {
                state.currentDay++;
                await saveData();
                renderUI();
            } else {
                showSection('withdrawal-section');
                renderWithdrawalSection();
            }
        }
        function updateOverallProgress() {
            if (!state.days) return;
            const completedDays = state.days.filter(d => d.allTasksCompleted).length;
            const progress = (completedDays / 3) * 100;
            daysProgressBar.style.width = `${progress}%`;
            daysProgressText.innerText = `${Math.round(progress)}% مكتمل`;
        }
        async function handleKycSubmission(e) {
            e.preventDefault();
            state.kycPending = true;
            await saveData();
            kycSubmittedBtn.classList.add('hidden');
            kycPendingMessage.classList.remove('hidden');
        }

        // --- WITHDRAWAL LOGIC ---
        async function renderWithdrawalSection() {
            const challengeCompleted = state.days && state.days[2] && state.days[2].allTasksCompleted;
            if (challengeCompleted && !state.withdrawalRequested) {
                withdrawalFormContainer.innerHTML = `
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-bold text-green-400">🎉 تهانينا! أنت مؤهل للسحب 🎉</h3>
                        <div class="bg-gray-700 inline-block p-4 rounded-lg mt-2">
                            <p class="text-gray-400">المكافأة المستحقة</p>
                            <p class="text-4xl font-bold text-green-400">$5.00</p>
                        </div>
                    </div>
                    <form id="request-withdrawal-form" class="max-w-md mx-auto space-y-4">
                        <select id="payment-method" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3"><option value="paypal">PayPal</option><option value="usdt">محفظة رقمية (USDT)</option></select>
                        <input type="text" id="payment-details" class="w-full bg-gray-700 border-gray-600 rounded-lg p-3" placeholder="أدخل بريد PayPal أو عنوان المحفظة" required>
                        <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg text-lg">طلب سحب المكافأة</button>
                    </form>
                `;
                document.getElementById('request-withdrawal-form').addEventListener('submit', handleWithdrawalRequest);
            } else if (state.withdrawalRequested) {
                 withdrawalFormContainer.innerHTML = `<p class="text-center text-yellow-400">لقد قمت بالفعل بتقديم طلب سحب. يمكنك متابعة حالته في الأسفل.</p>`;
            } else {
                withdrawalFormContainer.innerHTML = `<p class="text-center text-gray-400">يجب عليك إكمال تحدي الـ 3 أيام أولاً لتكون مؤهلاً لسحب الأرباح.</p>`;
            }
            const q = query(collection(db, "withdrawals"), where("userId", "==", currentUserId));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                withdrawalHistoryContainer.innerHTML = `<p class="text-center text-gray-500">لا توجد طلبات سحب سابقة.</p>`;
            } else {
                let historyHtml = '<ul class="space-y-3">';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.timestamp?.toDate().toLocaleDateString('ar-EG') || 'غير محدد';
                    const statusText = data.status === 'pending' ? 'قيد المراجعة' : 'مكتمل';
                    const statusColor = data.status === 'pending' ? 'text-yellow-400' : 'text-green-400';
                    historyHtml += `
                        <li class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                            <div>
                                <p class="font-bold">${data.method.toUpperCase()}: $${data.amount}</p>
                                <p class="text-sm text-gray-400">التاريخ: ${date}</p>
                            </div>
                            <span class="font-bold ${statusColor}">${statusText}</span>
                        </li>
                    `;
                });
                historyHtml += '</ul>';
                withdrawalHistoryContainer.innerHTML = historyHtml;
            }
        }
        async function handleWithdrawalRequest(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            const request = {
                userId: currentUserId,
                username: state.username,
                amount: 5,
                method: document.getElementById('payment-method').value,
                paymentDetails: document.getElementById('payment-details').value,
                status: 'pending',
                timestamp: serverTimestamp()
            };
            try {
                await setDoc(doc(collection(db, "withdrawals")), request);
                state.withdrawalRequested = true;
                await saveData();
                showSection('success-section');
            } catch (error) {
                console.error("Error submitting withdrawal request: ", error);
                alert("حدث خطأ أثناء تقديم طلبك. الرجاء المحاولة مرة أخرى.");
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        // --- MODAL FUNCTIONS ---
        function showSuccessModal() {
            const dayIndex = state.currentDay - 1;
            const allTasksDone = state.days[dayIndex].tasks.every(t => t.completed);
            if (allTasksDone) {
                modalMessage.textContent = `لقد أكملت جميع مهام اليوم ${state.currentDay} بنجاح!`;
            } else {
                modalMessage.textContent = 'لقد أكملت المهمة الحالية بنجاح. استعد للمهمة التالية!';
            }
            successModal.classList.remove('hidden');
        }

        // --- MAIN APP LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    currentUserId = user.uid;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        state = userDocSnap.data();
                        if (state.tasks) {
                            state.days = JSON.parse(JSON.stringify(defaultState.days));
                            delete state.tasks;
                            await setDoc(userDocRef, state, { merge: true });
                        }
                    } else {
                        state = JSON.parse(JSON.stringify(defaultState));
                        state.username = user.displayName || 'مستخدم';
                        await setDoc(userDocRef, state);
                    }
                    userInfoEl.classList.remove('hidden');
                    usernameDisplayEl.textContent = `مرحباً، ${state.username || 'مستخدم'}`;
                    if (state.kycVerified) { showSection('trading-section'); }
                    else if (state.kycPending) { showSection('kyc-section'); kycSubmittedBtn.classList.add('hidden'); kycPendingMessage.classList.remove('hidden'); }
                    else { showSection('welcome-section'); }
                    renderUI();
                } else {
                    currentUserId = null;
                    state = {};
                    userInfoEl.classList.add('hidden');
                    showSection('auth-section');
                }
            } catch (error) {
                console.error("Firestore initialization failed:", error);
                authMessageEl.textContent = 'فشل الاتصال بقاعدة البيانات. تحقق من قواعد الأمان في Firebase.';
                showSection('auth-section');
            } finally {
                appLoader.classList.remove('active');
            }
        });

        // --- EVENT LISTENERS ---
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerContainer.classList.remove('active'); loginContainer.classList.add('active'); authMessageEl.textContent = ''; });
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginContainer.classList.remove('active'); registerContainer.classList.add('active'); authMessageEl.textContent = ''; });
        registerForm.addEventListener('submit', handleRegister);
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        withdrawalBtn.addEventListener('click', () => {
            showSection('withdrawal-section');
            renderWithdrawalSection();
        });
        startChallengeBtn.addEventListener('click', () => { kycSubmittedBtn.disabled = true; showSection('kyc-section'); });
        telegramLink.addEventListener('click', () => { kycSubmittedBtn.disabled = false; });
        kycSubmittedBtn.addEventListener('click', handleKycSubmission);
        buyBtn.addEventListener('click', handleTrade);
        sellBtn.addEventListener('click', handleTrade);
        nextDayBtn.addEventListener('click', handleNextDay);
        backToTradeBtn.addEventListener('click', () => showSection('trading-section'));
        backToTradeFromWithdrawalBtn.addEventListener('click', () => showSection('trading-section'));
        closeModalBtn.addEventListener('click', () => successModal.classList.add('hidden'));

        // --- Price Simulation ---
        let assetPrice = 60000.00;
        setInterval(() => {
            const change = (Math.random() - 0.5) * 100;
            assetPrice += change;
            assetPriceEl.innerText = `$${assetPrice.toFixed(2)}`;
            assetPriceEl.className = change >= 0 ? 'text-4xl font-bold price-up' : 'text-4xl font-bold price-down';
        }, 2000);

    </script>
</body>
</html>
