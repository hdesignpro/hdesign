<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحدي التداول - اربح 5$</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and required adapters -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Candlestick Chart Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #0f0c29;
            color: #e5e7eb;
            overflow-x: hidden;
        }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background-color: rgba(10, 5, 20, 0.75);
            border: 1px solid rgba(192, 132, 252, 0.2);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        }
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        
        #toast-container { position: fixed; bottom: 60px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: translateX(-120%); animation: slideInToast 0.5s forwards, slideOutToast 0.5s 4.5s forwards; }
        .toast.success { background-color: #22c55e; border-left: 5px solid #16a34a; }
        .toast.error { background-color: #ef4444; border-left: 5px solid #dc2626; }
        @keyframes slideInToast { from { transform: translateX(-120%); } to { transform: translateX(0); } }
        @keyframes slideOutToast { from { transform: translateX(0); } to { transform: translateX(-120%); } }

        .glowing-divider { height: 1px; background: linear-gradient(to right, transparent, rgba(192, 132, 252, 0.5), transparent); margin: 1rem 0; }
        @keyframes text-flicker { 0%, 100% { opacity: 1; text-shadow: 0 0 2px currentColor; } 50% { opacity: 0.8; text-shadow: 0 0 5px currentColor; } }
        .flicker { animation: text-flicker 0.2s ease-in-out; }
        .trade-widget button:active { transform: scale(0.95); }
        .market-activity-table { font-size: 0.8rem; }
        .market-activity-table tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.03); }
        .market-activity-table td { padding: 4px 8px; }

        #news-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.5); white-space: nowrap; overflow: hidden; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 999; }
        #news-ticker-content { display: inline-block; padding-left: 100%; animation: ticker-scroll 40s linear infinite; }
        #news-ticker-content span { margin: 0 2rem; color: #a78bfa; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        /* Reward Modal Styles */
        .modal-backdrop { animation: fadeIn 0.3s ease-in-out; }
        .modal-content { animation: slideIn 0.3s ease-in-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* New Auth Page Styles */
        .bg-grid-pattern {
            background-image:
                linear-gradient(rgba(192, 132, 252, 0.1) 1px, transparent 1px),
                linear-gradient(to right, rgba(192, 132, 252, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Video Background Styles */
        .video-background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Behind everything */
            overflow: hidden;
        }
        .video-background-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 12, 41, 0.7);
            z-index: -1;
        }
        #app {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="text-zinc-200">

    <!-- Video Background -->
    <div class="video-background-container">
        <video autoplay loop muted playsinline>
            <source src="https://videos.pexels.com/video-files/3214449/3214449-hd_1920_1080_25fps.mp4" type="video/mp4">
        </video>
    </div>
    <div class="video-overlay"></div>

    <div id="app" class="container mx-auto p-4 max-w-screen-xl pb-20">

        <!-- Header -->
        <header class="text-center mb-6 md:relative card p-4 rounded-xl">
             <h1 class="text-3xl md:text-4xl font-bold text-purple-400 flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M225.46,89.46l-32,32A8,8,0,0,1,184,124V104H155.31l-32-64a8,8,0,0,0-14.62,0l-32,64H48v20a8,8,0,0,1-9.46,7.46l-32-8A8,8,0,0,1,0,116V40a8,8,0,0,1,8-8H216a8,8,0,0,1,7.46,9.46ZM216,48H16V108.69l24,6V88a8,8,0,0,1,8-8H82.69l32-64,32,64H208a8,8,0,0,1,8,8Z M246.54,146.54a8,8,0,0,0-11.32,0L208,173.83V152a8,8,0,0,0-16,0v40a8,8,0,0,0,8,8h40a8,8,0,0,0,0-16H214.17l27.07-27.07A8,8,0,0,0,246.54,146.54Z M104,152v21.83l-27.07,27.07a8,8,0,0,0,11.32,11.32L116,185.17V208a8,8,0,0,0,16,0V168a8,8,0,0,0-8-8H88a8,8,0,0,0,0,16h16Z"></path></svg>
                محاكاة التداول المتقدمة
            </h1>
            <div id="user-info" class="hidden relative mt-4 md:absolute md:top-4 md:right-4 md:mt-0 bg-zinc-900/50 p-2 rounded-lg text-sm flex items-center justify-center">
                <span id="username-display"></span>
                <button id="referral-btn" class="text-amber-400 hover:text-amber-500 mx-4 font-bold">[الدعوات]</button>
                <button id="withdrawal-btn" class="text-purple-400 hover:text-purple-500 mx-4 font-bold">[السحب]</button>
                <button id="logout-btn" class="text-red-400 hover:text-red-500 font-bold">[خروج]</button>
            </div>
        </header>
        
        <div id="app-loader" class="section active"><div class="loader"></div></div>
        
        <!-- AUTH SECTION -->
        <section id="auth-section" class="section card p-0 rounded-xl shadow-lg max-w-4xl mx-auto overflow-hidden">
            <div class="grid md:grid-cols-2">
                <!-- Right side: Forms -->
                <div class="p-8 md:p-12">
                    <div id="register-form-container" class="auth-form active">
                        <h2 class="text-3xl font-semibold mb-6 text-center">إنشاء حساب جديد</h2>
                        <form id="register-form" class="space-y-4">
                            <input type="text" id="register-username" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="اسم المستخدم (باللغة الإنجليزية)" required>
                            <input type="email" id="register-email" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="البريد الإلكتروني" required>
                            <input type="password" id="register-password" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="كلمة المرور" required>
                            <input type="text" id="register-referral" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none" placeholder="كود الدعوة (اختياري)">
                            <button type="submit" class="w-full btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg">إنشاء حساب</button>
                        </form>
                        <p class="text-center mt-6 text-zinc-500">لديك حساب بالفعل؟ <a href="#" id="show-login" class="text-purple-400 hover:underline">سجل الدخول</a></p>
                    </div>
                    <div id="login-form-container" class="auth-form">
                        <h2 class="text-3xl font-semibold mb-6 text-center">تسجيل الدخول</h2>
                        <form id="login-form" class="space-y-4">
                            <input type="email" id="login-email" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" placeholder="البريد الإلكتروني" required>
                            <input type="password" id="login-password" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" placeholder="كلمة المرور" required>
                            <button type="submit" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">دخول</button>
                        </form>
                        <p class="text-center mt-6 text-zinc-500">ليس لديك حساب؟ <a href="#" id="show-register" class="text-purple-400 hover:underline">أنشئ حساباً جديداً</a></p>
                    </div>
                    <div id="auth-message" class="text-center text-red-400 mt-4 h-5"></div>
                </div>
                 <!-- Left side: Decorative Panel -->
                <div class="hidden md:flex flex-col justify-center p-8 bg-purple-900/20 relative">
                    <div class="absolute inset-0 bg-grid-pattern opacity-10"></div>
                    <h2 class="text-4xl font-bold text-white mb-4 z-10">انضم إلى التحدي</h2>
                    <p class="text-purple-200 z-10">أكمل مهام التداول اليومية واكسب مكافآت حقيقية. ابدأ رحلتك الآن!</p>
                </div>
            </div>
        </section>

        <!-- WELCOME SECTION -->
        <section id="welcome-section" class="section text-center card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-4">مرحباً بك في التحدي!</h2>
            <p class="text-lg text-zinc-300 mb-6 max-w-2xl mx-auto">أنت على وشك بدء تحدي تداول مثير. أكمل المهام اليومية لمدة 3 أيام متتالية لتحصل على 5$.</p>
            <button id="start-challenge-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg text-lg max-w-xs mx-auto">ابدأ التحدي الآن</button>
        </section>

        <!-- KYC SECTION -->
        <section id="kyc-section" class="section card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-2 text-center">الخطوة الأولى: توثيق الهوية (KYC)</h2>
            <p class="text-center text-zinc-400 mb-8">لإكمال عملية التوثيق، الرجاء اتباع الخطوات التالية بدقة.</p>
            <div class="space-y-4 max-w-lg mx-auto">
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">1</div><div><h3 class="font-bold text-lg">صور الهوية الشخصية</h3><p class="text-zinc-400">أرسل صورة أمامية وخلفية واضحة لهويتك.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">2</div><div><h3 class="font-bold text-lg">صورة شخصية (سيلفي)</h3><p class="text-zinc-400">التقط صورة لنفسك وأنت تحمل الهوية بجانب وجهك.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">3</div><div><h3 class="font-bold text-lg">فيديو قصير</h3><p class="text-zinc-400">سجل فيديو قصير (13 ثانية) وأنت تحمل الهوية.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">4</div><div><h3 class="font-bold text-lg">البريد الإلكتروني</h3><p class="text-zinc-400">لا تنس إرفاق البريد الإلكتروني الذي سجلت به في الموقع.</p></div></div>
            </div>
            <div class="text-center mt-8"><a id="telegram-link" href="https://t.me/kycverifice" target="_blank" class="inline-block btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg mb-4">إرسال المستندات</a><p class="text-sm text-zinc-500">بعد الضغط على الرابط، سيتم تفعيل الزر أدناه.</p></div>
            <button id="kyc-submitted-btn" class="w-full mt-6 btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>لقد أرسلت المستندات</button>
            <div id="kyc-pending-message" class="hidden text-center mt-4 p-4 bg-yellow-900/50 rounded-lg"><p>شكراً لك. طلبك الآن قيد المراجعة.</p></div>
        </section>

        <!-- TRADING DASHBOARD SECTION -->
        <section id="trading-section" class="section">
            <div class="grid grid-cols-12 gap-6">
                <!-- Left Panel -->
                <div class="col-span-12 lg:col-span-3 space-y-6">
                    <div class="card p-4 rounded-xl shadow-lg">
                        <h3 class="text-lg font-bold mb-2">ملخص الحساب</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-zinc-400">الرصيد:</span><span id="balance" class="text-xl font-bold text-purple-400"></span></div>
                            <div class="glowing-divider"></div>
                            <div class="flex justify-between items-center"><span class="text-zinc-400">تقدم التحدي:</span><span class="font-bold">اليوم <span id="current-day"></span> / 3</span></div>
                            <div class="w-full bg-zinc-700 rounded-full h-2.5"><div id="days-progress-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="card p-4 rounded-xl shadow-lg">
                        <h3 class="text-lg font-bold mb-3">تنفيذ صفقة</h3>
                        <div class="space-y-3">
                             <input type="number" id="trade-amount" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-3 text-center text-lg placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="أدخل المبلغ">
                             <div class="grid grid-cols-2 gap-3 trade-widget">
                                <button id="buy-btn" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">شراء</button>
                                <button id="sell-btn" class="w-full btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg text-lg">بيع</button>
                             </div>
                        </div>
                    </div>
                </div>
                <!-- Main Chart Panel (Center) -->
                <div class="col-span-12 lg:col-span-6 card p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="text-xl font-bold">BTC/USD</h3><p class="text-zinc-400 text-sm">مخطط الشموع اليابانية (2ث)</p></div>
                        <div class="text-right">
                            <div id="asset-price-container" class="text-3xl font-bold price-up flex items-center justify-end gap-2">
                                <span id="asset-price-arrow">▲</span><span id="asset-price"></span>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-96"><canvas id="priceChart"></canvas></div>
                </div>
                <!-- Right Panel -->
                <div class="col-span-12 lg:col-span-3 space-y-6">
                    <div class="card p-4 rounded-xl shadow-lg h-full flex flex-col">
                        <h3 class="text-lg font-bold mb-2">نشاط السوق</h3>
                        <div class="flex border-b border-zinc-700 mb-2">
                            <button id="order-book-tab" class="px-4 py-2 text-purple-400 border-b-2 border-purple-400">سجل الأوامر</button>
                            <button id="trade-history-tab" class="px-4 py-2 text-zinc-500">سجل صفقاتك</button>
                        </div>
                        <div class="flex-grow overflow-y-auto" style="max-height: 350px;">
                            <div id="order-book-content">
                                <table class="w-full market-activity-table">
                                    <thead><tr class="text-zinc-500"><th class="text-right">السعر</th><th class="text-right">الكمية</th></tr></thead>
                                    <tbody id="order-book-asks"></tbody>
                                </table>
                                <div class="glowing-divider my-1"></div>
                                <table class="w-full market-activity-table"><tbody id="order-book-bids"></tbody></table>
                            </div>
                            <div id="trade-history-content" class="hidden">
                                <table class="w-full market-activity-table">
                                    <thead><tr class="text-zinc-500"><th class="text-right">الوقت</th><th class="text-right">النوع</th><th class="text-right">السعر</th></tr></thead>
                                    <tbody id="trade-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Mission Log (Full Width Below) -->
                <div class="col-span-12 card p-4 sm:p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">سجل المهام - اليوم <span id="current-day-tasks"></span></h3>
                    <div id="task-container" class="space-y-3"></div>
                    <button id="next-day-btn" class="hidden mt-6 w-full btn btn-primary font-bold py-3 px-4 rounded-lg">انتقل لليوم التالي</button>
                </div>
            </div>
        </section>
        
        <!-- WITHDRAWAL SECTION -->
        <section id="withdrawal-section" class="section card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-6 text-center">سحب الأرباح</h2>
            <div id="withdrawal-form-container"></div>
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 border-b border-zinc-700 pb-2">سجل السحوبات</h3>
                <div id="withdrawal-history-container"></div>
            </div>
            <button id="back-to-trade-from-withdrawal-btn" class="mt-8 w-full btn bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-6 rounded-lg">العودة إلى التداول</button>
        </section>

        <!-- SUCCESS SECTION -->
        <section id="success-section" class="section text-center card p-8 rounded-xl shadow-lg">
             <h2 class="text-3xl font-semibold mb-4 text-purple-400">✅ تم استلام طلبك بنجاح!</h2>
             <p class="text-lg text-zinc-300">ستتم مراجعة طلبك وتحويل 5$ إلى حسابك خلال 24-48 ساعة.</p>
             <button id="back-to-trade-btn" class="mt-6 btn btn-primary font-bold py-2 px-6 rounded-lg">العودة للتداول</button>
        </section>

        <!-- REFERRAL SECTION -->
        <section id="referral-section" class="section card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-2 text-center text-amber-400">ادعُ أصدقاءك واكسب!</h2>
            <p class="text-center text-zinc-400 mb-8">مقابل كل 3 أصدقاء تقوم بدعوتهم ويكملون توثيق الهوية، ستحصل على مكافأة عشوائية تتراوح من 3$ إلى 50$!</p>
            
            <div class="text-center mb-8">
                <p class="text-zinc-400 mb-2">رابط الدعوة الخاص بك:</p>
                <div class="flex justify-center items-center gap-2">
                    <input id="referral-link-display" type="text" class="bg-zinc-800 border border-zinc-700 text-amber-400 font-bold text-lg text-center p-2 rounded-lg w-full" readonly>
                    <button id="copy-referral-btn" class="btn bg-amber-500 hover:bg-amber-600 text-white p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M216,32H88a8,8,0,0,0-8,8V80H40a8,8,0,0,0-8,8V216a8,8,0,0,0,8,8H168a8,8,0,0,0,8-8V176h40a8,8,0,0,0,8-8V40A8,8,0,0,0,216,32ZM160,208H48V96H160Zm48-48H176V88a8,8,0,0,0-8-8H96V48H208Z"></path></svg>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4">الأصدقاء الذين دعوتهم</h3>
                <div id="referral-list-container" class="space-y-3 max-h-64 overflow-y-auto"></div>
            </div>
            <button id="back-to-trade-from-referral-btn" class="mt-8 w-full btn bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-6 rounded-lg">العودة إلى التداول</button>
        </section>
    </div>

    <!-- Reward Modal -->
    <div id="reward-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="card rounded-xl shadow-2xl p-8 text-center max-w-sm mx-auto modal-content">
            <div class="text-amber-400 mb-4">
                <svg class="w-16 h-16 mx-auto" xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><path d="M224,104a32,32,0,0,1-32,32H64a32,32,0,0,1,0-64H192A32,32,0,0,1,224,104Zm-64-32H64a32.06,32.06,0,0,0-31.81,29.33L16,112v48a8,8,0,0,0,16,0V144H224v16a8,8,0,0,0,16,0V112l-16.19-10.67A32.06,32.06,0,0,0,192,72Zm-8,64H152a8,8,0,0,0,0,16h48a8,8,0,0,0,0-16Zm-24-32H128a8,8,0,0,0,0,16h24a8,8,0,0,0,0-16Zm-48,0H80a8,8,0,0,0,0,16h24a8,8,0,0,0,0-16Zm-40,32H56a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Z"></path></svg>
            </div>
            <h3 class="text-2xl font-bold mb-2">🎉 تهانينا! 🎉</h3>
            <p class="text-zinc-300 mb-6">لقد حصلت على مكافأة دعوة بقيمة:</p>
            <p id="reward-amount" class="text-5xl font-bold text-amber-400 mb-6">$0.00</p>
            <button id="close-reward-modal-btn" class="btn bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-8 rounded-lg">رائع!</button>
        </div>
    </div>

    <!-- Toast Notification & News Ticker -->
    <div id="toast-container"></div>
    <div id="news-ticker"><div id="news-ticker-content"></div></div>

    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCg8-1mCCdJm_5a3920D9q3IOjezg3-D_Y",
            authDomain: "trading-56231.firebaseapp.com",
            projectId: "trading-56231",
            storageBucket: "trading-56231.firebasestorage.app",
            messagingSenderId: "158943830558",
            appId: "1:158943830558:web:951042cf11154a3745440f",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & VARS ---
        let state = {};
        let currentUserId = null;
        let countdownInterval = null;
        let priceInterval = null;
        let marketActivityInterval = null;
        let priceChart = null;
        let assetPrice = 60000.00;
        let openPrice = assetPrice;
        let highPrice = assetPrice;
        let lowPrice = assetPrice;

        const defaultState = {
            kycVerified: false, kycPending: false, currentDay: 1, balance: 1000, referralBalance: 0, withdrawalRequested: false, tradeHistory: [], referralCode: '', referrals: {}
        };
        
        // --- DOM ELEMENTS ---
        const allSections = document.querySelectorAll('.section');
        const appLoader = document.getElementById('app-loader');
        const userInfoEl = document.getElementById('user-info');
        const usernameDisplayEl = document.getElementById('username-display');
        const logoutBtn = document.getElementById('logout-btn');
        const withdrawalBtn = document.getElementById('withdrawal-btn');
        const referralBtn = document.getElementById('referral-btn');
        const toastContainer = document.getElementById('toast-container');
        
        // --- SOUND ENGINE ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!audioContext || audioContext.state !== 'running') return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
            if (type === 'click') {
                oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.1);
            } else if (type === 'success') {
                oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(1046.50, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            } else if (type === 'error') {
                oscillator.type = 'square'; oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(110, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            }
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        // --- CORE FUNCTIONS ---
        function showSection(sectionId) { allSections.forEach(s => s.classList.toggle('active', s.id === sectionId)); }
        async function saveData() { if (currentUserId) await setDoc(doc(db, "users", currentUserId), state, { merge: true }); }
        
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            element.classList.add('flicker');
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.innerHTML = `$${(progress * (end - start) + start).toFixed(2)}`;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
            setTimeout(() => element.classList.remove('flicker'), 200);
        }
        
        // --- AUTH FUNCTIONS ---
        async function handleRegister(e) {
            e.preventDefault(); playSound('click');
            const btn = e.target.querySelector('button');
            const authMessageEl = document.getElementById('auth-message');
            btn.disabled = true; btn.textContent = 'جاري الإنشاء...'; authMessageEl.textContent = '';
            
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value.trim();

            if (!username || !/^[a-zA-Z0-9]+$/.test(username)) { authMessageEl.textContent = "اسم المستخدم يجب أن يحتوي على حروف وأرقام إنجليزية فقط."; btn.disabled = false; btn.textContent = 'إنشاء حساب'; playSound('error'); return; }
            
            try {
                const usernameSnap = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameSnap.exists()) { authMessageEl.textContent = "اسم المستخدم هذا مستخدم بالفعل."; throw new Error("Username taken"); }

                let referrerId = null;
                if (referralCode) {
                    const q = query(collection(db, "users"), where("referralCode", "==", referralCode));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        referrerId = querySnapshot.docs[0].id;
                    } else {
                        authMessageEl.textContent = "كود الدعوة غير صالح."; throw new Error("Invalid referral code");
                    }
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username });

                const newUserReferralCode = username.toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
                
                const batch = writeBatch(db);
                
                const newUserDocRef = doc(db, "users", user.uid);
                const newUserState = { ...JSON.parse(JSON.stringify(defaultState)), username, referralCode: newUserReferralCode };
                if (referrerId) {
                    newUserState.referredBy = referrerId;
                    const referrerDocRef = doc(db, "users", referrerId);
                    batch.update(referrerDocRef, {
                        [`referrals.${user.uid}`]: { username: username, status: 'registered' }
                    });
                }
                batch.set(newUserDocRef, newUserState);
                
                const usernameDocRef = doc(db, "usernames", username.toLowerCase());
                batch.set(usernameDocRef, { userId: user.uid });

                await batch.commit();

            } catch (error) {
                if (!authMessageEl.textContent) {
                    authMessageEl.textContent = error.code === 'auth/email-already-in-use' ? "هذا البريد الإلكتروني مسجل بالفعل." : "حدث خطأ غير متوقع.";
                }
                playSound('error');
            } finally {
                btn.disabled = false; btn.textContent = 'إنشاء حساب';
            }
        }
        async function handleLogin(e) {
            e.preventDefault(); playSound('click');
            const btn = e.target.querySelector('button');
            const authMessageEl = document.getElementById('auth-message');
            btn.disabled = true; btn.textContent = 'جاري الدخول...'; authMessageEl.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) { authMessageEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة."; playSound('error'); }
            finally { btn.disabled = false; btn.textContent = 'دخول'; }
        }
        function handleLogout() { playSound('click'); if (priceInterval) clearInterval(priceInterval); if(marketActivityInterval) clearInterval(marketActivityInterval); signOut(auth); }

        // --- TASK & TRADE LOGIC ---
        function renderTasks() { 
            const taskContainer = document.getElementById('task-container');
            if(!taskContainer) return;

            const dayIndex = state.currentDay - 1;
            if (!state?.days?.[dayIndex]) { taskContainer.innerHTML = `<p>جاري تحميل المهام...</p>`; return; }
            const currentDayData = state.days[dayIndex];
            if (currentDayData.allTasksCompleted) { checkDayCompletion(); return; }
            let tasksHtml = '';
            let isCurrentTaskFound = false;
            currentDayData.tasks.forEach(task => {
                let statusClass = '', icon;
                if (task.completed) {
                    statusClass = 'completed';
                    icon = `<div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,77.66l-128,128a8,8,0,0,1-11.32,0l-56-56a8,8,0,0,1,11.32-11.32L96,188.69,218.34,66.34a8,8,0,0,1,11.32,11.32Z"></path></svg></div>`;
                } else if (!isCurrentTaskFound) {
                    statusClass = 'current';
                    icon = `<div class="w-6 h-6 rounded-full bg-purple-500/20 border-2 border-purple-500 flex items-center justify-center"><div class="w-2 h-2 bg-purple-400 rounded-full"></div></div>`;
                    isCurrentTaskFound = true;
                } else {
                    icon = `<div class="w-6 h-6 rounded-full bg-zinc-700 border-2 border-zinc-500"></div>`;
                }
                tasksHtml += `<div class="task-item flex items-center gap-4 p-4 rounded-lg bg-zinc-800 border border-transparent transition-all duration-300 ${statusClass}">${icon}<p class="flex-grow ${task.completed ? 'line-through text-zinc-500' : ''}">${task.description}</p></div>`;
            });
            taskContainer.innerHTML = tasksHtml;
        }
        async function handleTrade(event) { 
            playSound('click');
            const tradeAmountInput = document.getElementById('trade-amount');
            const assetPriceEl = document.getElementById('asset-price');
            const balanceEl = document.getElementById('balance');
            
            const dayIndex = state.currentDay - 1;
            const taskToComplete = state.days[dayIndex].tasks.find(t => !t.completed);
            if (!taskToComplete) { showToast('لقد أكملت جميع مهام اليوم!', 'success'); return; }
            const amount = parseFloat(tradeAmountInput.value);
            const action = event.target.closest('button').id.includes('buy') ? 'buy' : 'sell';
            if (isNaN(amount) || amount <= 0) { showToast('مبلغ غير صالح.', 'error'); playSound('error'); return; }
            if (action === 'buy' && amount > state.balance) { showToast('رصيدك غير كافٍ.', 'error'); playSound('error'); return; }
            
            if (action === taskToComplete.action && amount === taskToComplete.amount) {
                taskToComplete.completed = true;
                const oldBalance = state.balance;
                state.balance -= amount * 0.001;
                animateValue(balanceEl, oldBalance, state.balance, 500);
                
                state.tradeHistory.unshift({ time: new Date().toLocaleTimeString('ar-EG'), type: action, price: parseFloat(assetPriceEl.innerText.replace(/[^0-9.]/g, '')), amount: amount });
                if(state.tradeHistory.length > 20) state.tradeHistory.pop();
                renderTradeHistory();

                await saveData();
                renderTasks();
                checkDayCompletion(); // Check for day completion after every successful trade
                playSound('success');
                showToast('أحسنت! تم إنجاز المهمة.');
            } else {
                showToast('صفقة خاطئة! المهمة تتطلب إجراءً مختلفًا.', 'error');
                playSound('error');
            }
        }
        async function checkDayCompletion() { 
            const taskContainer = document.getElementById('task-container');
            const nextDayBtn = document.getElementById('next-day-btn');
            if(!taskContainer || !nextDayBtn) return;

            const dayIndex = state.currentDay - 1;
            if (!state.days?.[dayIndex]) return;
            const currentDayData = state.days[dayIndex];
            const allDone = currentDayData.tasks.every(t => t.completed);
            if (allDone && !currentDayData.allTasksCompleted) {
                currentDayData.allTasksCompleted = true;
                currentDayData.completionTimestamp = Date.now();
                await saveData();
            }
            if (currentDayData.allTasksCompleted) {
                nextDayBtn.classList.add('hidden');
                const timeRemaining = (24 * 3600 * 1000) - (Date.now() - currentDayData.completionTimestamp);
                if (timeRemaining <= 0) {
                    taskContainer.innerHTML = `<div class="text-center p-4 bg-zinc-800 rounded-lg"><h4 class="text-lg font-semibold mb-2 text-green-400">✅ اكتمل اليوم ${state.currentDay}!</h4><p>يمكنك الآن الانتقال إلى اليوم التالي.</p></div>`;
                    nextDayBtn.classList.remove('hidden');
                    nextDayBtn.innerText = state.currentDay < 3 ? `انتقل لليوم ${state.currentDay + 1}` : 'إنهاء التحدي وطلب السحب';
                } else {
                    displayCountdown(timeRemaining);
                }
            } else {
                nextDayBtn.classList.add('hidden');
            }
        }
        function displayCountdown(ms) { 
            const taskContainer = document.getElementById('task-container');
            if(!taskContainer) return;
            clearInterval(countdownInterval);
            taskContainer.innerHTML = `<div class="text-center p-4 bg-zinc-800 rounded-lg"><h4 class="text-lg font-semibold mb-2 text-purple-400">اليوم مكتمل!</h4><p>سيتم فتح اليوم التالي خلال:</p><div id="countdown" class="text-3xl font-bold my-2"></div></div>`;
            const countdownEl = document.getElementById('countdown');
            countdownInterval = setInterval(() => {
                const totalSeconds = Math.floor(ms / 1000);
                const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(totalSeconds % 60).padStart(2, '0');
                countdownEl.textContent = `${h}:${m}:${s}`;
                ms -= 1000;
                if (ms < 0) { clearInterval(countdownInterval); renderTasks(); }
            }, 1000);
        }
        async function handleNextDay() { 
            playSound('click');
            if (state.currentDay < 3) {
                state.currentDay++;
                await saveData();
                showSection('trading-section');
            } else {
                renderWithdrawalSection();
                showSection('withdrawal-section');
            }
        }
        function updateOverallProgress() { 
            const daysProgressBar = document.getElementById('days-progress-bar');
            if(!daysProgressBar || !state.days) return;
            const completedDays = state.days.filter(d => d.allTasksCompleted).length;
            const progress = (completedDays / 3) * 100;
            daysProgressBar.style.width = `${progress}%`;
        }
        async function handleKycSubmission(e) { 
            e.preventDefault();
            playSound('click');
            state.kycPending = true;
            await saveData();
            document.getElementById('kyc-submitted-btn').classList.add('hidden');
            document.getElementById('kyc-pending-message').classList.remove('hidden');
        }

        // --- WITHDRAWAL LOGIC ---
        function renderWithdrawalSection() {
            const withdrawalFormContainer = document.getElementById('withdrawal-form-container');
            const withdrawalHistoryContainer = document.getElementById('withdrawal-history-container');
            const challengeCompleted = state.days?.[2]?.allTasksCompleted;

            if (challengeCompleted) {
                withdrawalFormContainer.innerHTML = `<div class="text-center mb-6"><h3 class="text-xl font-bold text-green-400">🎉 تهانينا! أنت مؤهل للسحب 🎉</h3><div class="bg-zinc-700 inline-block p-4 rounded-lg mt-2"><p class="text-zinc-400">مكافأة التحدي</p><p class="text-2xl font-bold text-green-400">$5.00</p></div><div class="bg-zinc-700 inline-block p-4 rounded-lg mt-2 ml-4"><p class="text-zinc-400">مكافأة الدعوات</p><p class="text-2xl font-bold text-amber-400">$${(state.referralBalance || 0).toFixed(2)}</p></div></div><form id="request-withdrawal-form" class="max-w-md mx-auto space-y-4"><select id="payment-method" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-3"><option value="paypal">PayPal</option><option value="usdt">محفظة رقمية (USDT)</option></select><input type="text" id="payment-details" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-3" placeholder="أدخل بريد PayPal أو عنوان المحفظة" required><button type="submit" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg text-lg">طلب سحب $${(5 + (state.referralBalance || 0)).toFixed(2)}</button></form>`;
                document.getElementById('request-withdrawal-form').addEventListener('submit', handleWithdrawalRequest);
            } else {
                withdrawalFormContainer.innerHTML = `<p class="text-center text-zinc-400">يجب عليك إكمال تحدي الـ 3 أيام أولاً لتكون مؤهلاً لسحب الأرباح.</p>`;
            }
            // ... history rendering logic
        }
        async function handleWithdrawalRequest(e) { /* ... Withdrawal request logic ... */ }
        
        // --- REFERRAL LOGIC ---
        function renderReferralSection() {
            const referralLinkDisplay = document.getElementById('referral-link-display');
            const referralListContainer = document.getElementById('referral-list-container');
            
            const baseUrl = window.location.origin + window.location.pathname;
            referralLinkDisplay.value = `${baseUrl}?ref=${state.referralCode}`;

            if (!state.referrals || Object.keys(state.referrals).length === 0) {
                referralListContainer.innerHTML = `<p class="text-zinc-500 text-center">لم تقم بدعوة أي شخص بعد.</p>`;
                return;
            }

            let listHtml = '';
            for (const uid in state.referrals) {
                const referral = state.referrals[uid];
                let statusText, statusColor;
                switch(referral.status) {
                    case 'verified':
                        statusText = 'تم التوثيق';
                        statusColor = 'text-green-400';
                        break;
                    case 'rewarded':
                        statusText = 'تمت المكافأة';
                        statusColor = 'text-amber-400';
                        break;
                    default:
                        statusText = 'مسجل';
                        statusColor = 'text-zinc-400';
                }
                listHtml += `
                    <div class="flex justify-between items-center bg-zinc-800 p-3 rounded-lg">
                        <p>${referral.username}</p>
                        <span class="font-bold ${statusColor}">${statusText}</span>
                    </div>
                `;
            }
            referralListContainer.innerHTML = listHtml;
        }
        async function checkReferralRewards() {
            if (!state.referrals || !currentUserId) return;

            const batch = writeBatch(db);
            const currentUserDocRef = doc(db, "users", currentUserId);
            let needsSave = false;

            for (const uid in state.referrals) {
                const referral = state.referrals[uid];
                if (referral.status === 'registered') {
                    const referredUserDoc = await getDoc(doc(db, "users", uid));
                    if (referredUserDoc.exists() && referredUserDoc.data().kycVerified) {
                        state.referrals[uid].status = 'verified';
                        batch.update(currentUserDocRef, { [`referrals.${uid}.status`]: 'verified' });
                        needsSave = true;
                    }
                }
            }

            const unrewardedVerifiedRefs = Object.keys(state.referrals).filter(uid => state.referrals[uid].status === 'verified');

            if (unrewardedVerifiedRefs.length >= 3) {
                const groupsOfThree = Math.floor(unrewardedVerifiedRefs.length / 3);
                
                for (let i = 0; i < groupsOfThree; i++) {
                    const rewardAmount = Math.floor(Math.random() * (5 - 1 + 1)) + 1;
                    
                    batch.update(currentUserDocRef, {
                        referralBalance: increment(rewardAmount)
                    });
                    state.referralBalance += rewardAmount;
                    
                    for (let j = 0; j < 3; j++) {
                        const refToRewardUid = unrewardedVerifiedRefs[i * 3 + j];
                        batch.update(currentUserDocRef, {
                            [`referrals.${refToRewardUid}.status`]: 'rewarded'
                        });
                        state.referrals[refToRewardUid].status = 'rewarded';
                    }
                    
                    needsSave = true;
                    setTimeout(() => {
                        showRewardModal(rewardAmount);
                    }, i * 200);
                }
            }

            if (needsSave) {
                await batch.commit();
            }
        }
        function showRewardModal(amount) {
            const modal = document.getElementById('reward-modal');
            const amountEl = document.getElementById('reward-amount');
            amountEl.innerText = `$${amount.toFixed(2)}`;
            modal.classList.remove('hidden');
        }

        // --- MARKET ACTIVITY LOGIC ---
        function renderTradeHistory() { 
            const tradeHistoryBody = document.getElementById('trade-history-body');
            if(!tradeHistoryBody) return;
            tradeHistoryBody.innerHTML = (state.tradeHistory || []).map(trade => `
                <tr>
                    <td>${trade.time}</td>
                    <td class="${trade.type === 'buy' ? 'text-green-500' : 'text-red-500'}">${trade.type === 'buy' ? 'شراء' : 'بيع'}</td>
                    <td>$${trade.price.toFixed(2)}</td>
                </tr>
            `).join('');
        }
        function updateOrderBook() { 
            const assetPriceEl = document.getElementById('asset-price');
            const orderBookAsks = document.getElementById('order-book-asks');
            const orderBookBids = document.getElementById('order-book-bids');
            if(!assetPriceEl || !orderBookAsks || !orderBookBids) return;
            const currentPriceText = assetPriceEl.innerText;
            if(!currentPriceText) return;
            const currentPrice = parseFloat(currentPriceText.replace(/[^0-9.]/g, ''));
            if(isNaN(currentPrice)) return;
            let asksHtml = '';
            let bidsHtml = '';
            for (let i = 0; i < 8; i++) {
                const askPrice = currentPrice + (Math.random() * 10) * (i + 1);
                const askAmount = (Math.random() * 0.5).toFixed(4);
                asksHtml = `<tr><td class="text-red-500">${askPrice.toFixed(2)}</td><td>${askAmount}</td></tr>` + asksHtml;
                
                const bidPrice = currentPrice - (Math.random() * 10) * (i + 1);
                const bidAmount = (Math.random() * 0.5).toFixed(4);
                bidsHtml += `<tr><td class="text-green-500">${bidPrice.toFixed(2)}</td><td>${bidAmount}</td></tr>`;
            }
            orderBookAsks.innerHTML = asksHtml;
            orderBookBids.innerHTML = bidsHtml;
        }

        // --- NEWS TICKER LOGIC ---
        function initNewsTicker() { 
            const newsItems = [ "البنك المركزي يلمح إلى رفع أسعار الفائدة الأسبوع المقبل.", "شركة تكنولوجيا كبرى تعلن عن قبول الدفع بالعملات الرقمية.", "بيانات التضخم تأتي أقل من المتوقع، مما يعزز الأسواق.", "تقارير عن تبني دولي واسع لتقنية البلوك تشين.", "مؤشر ثقة المستهلك يسجل أعلى مستوى له في عامين.", "تحذيرات من تقلبات حادة في أسواق الطاقة العالمية." ];
            document.getElementById('news-ticker-content').innerHTML = newsItems.map(item => `<span>⚡</span> ${item}`).join('');
        }

        // --- CHART LOGIC (CANDLESTICK) ---
        function generateInitialData(count, initialPrice, intervalSeconds) {
            const data = [];
            let price = initialPrice;
            let time = new Date();
            time.setSeconds(time.getSeconds() - count * intervalSeconds);

            for (let i = 0; i < count; i++) {
                const open = price;
                const close = open + (Math.random() - 0.5) * 50;
                const high = Math.max(open, close) + Math.random() * 20;
                const low = Math.min(open, close) - Math.random() * 20;
                data.push({ x: time.getTime(), o: open, h: high, l: low, c: close });
                price = close;
                time.setSeconds(time.getSeconds() + intervalSeconds);
            }
            assetPrice = price;
            openPrice = price;
            highPrice = price;
            lowPrice = price;
            return data;
        }
        function initPriceChart() { 
            const chartCanvas = document.getElementById('priceChart');
            if(!chartCanvas) return;
            if(priceChart) priceChart.destroy(); // Destroy old chart instance if exists
            const initialData = generateInitialData(39, 60000, 2);
            const ctx = chartCanvas.getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'candlestick',
                data: { 
                    datasets: [{ 
                        label: 'BTC/USD', 
                        data: initialData,
                        color: {
                            up: '#22c55e',
                            down: '#ef4444',
                            unchanged: '#9ca3af',
                        }
                    }] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        x: { type: 'time', time: { unit: 'second' }, display: false }, 
                        y: { ticks: { color: 'rgba(255,255,255,0.3)' }, grid: { color: 'rgba(255,255,255,0.1)' } } 
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: true } }
                }
            });
        }
        
        // --- URL PARAM HANDLER ---
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const refCode = params.get('ref');
            if (refCode) {
                const referralInput = document.getElementById('register-referral');
                if (referralInput) {
                    referralInput.value = refCode;
                }
            }
        }

        // --- MAIN APP LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    currentUserId = user.uid;
                    const userDocSnap = await getDoc(doc(db, "users", user.uid));
                    if (userDocSnap.exists()) {
                        state = userDocSnap.data();
                    } else {
                        state = { ...JSON.parse(JSON.stringify(defaultState)), username: user.displayName || 'مستخدم' };
                        await setDoc(doc(db, "users", user.uid), state);
                    }
                    if (!state.tradeHistory) state.tradeHistory = [];
                    if (!state.referrals) state.referrals = {};
                    if (!state.referralBalance) state.referralBalance = 0;

                    usernameDisplayEl.textContent = `مرحباً، ${state.username || 'مستخدم'}`;
                    userInfoEl.classList.remove('hidden');

                    await checkReferralRewards();

                    if (state.kycVerified) {
                        showSection('trading-section');
                        initPriceChart();
                        renderTasks();
                        updateOverallProgress();
                        renderTradeHistory();
                        document.getElementById('balance').innerText = `$${(state.balance + (state.referralBalance || 0)).toFixed(2)}`;
                        document.getElementById('current-day').innerText = state.currentDay;
                        document.getElementById('current-day-tasks').innerText = state.currentDay;
                    } else if (state.kycPending) {
                        document.getElementById('kyc-submitted-btn').classList.add('hidden');
                        document.getElementById('kyc-pending-message').classList.remove('hidden');
                        showSection('kyc-section');
                    } else {
                        showSection('welcome-section');
                    }
                } else {
                    currentUserId = null; state = {};
                    userInfoEl.classList.add('hidden');
                    showSection('auth-section');
                }
            } catch (error) {
                console.error("Firestore initialization failed:", error);
                const authMessageEl = document.getElementById('auth-message');
                if(authMessageEl) authMessageEl.textContent = 'فشل الاتصال بقاعدة البيانات.';
                showSection('auth-section');
            } finally {
                appLoader.classList.remove('active');
            }
        });

        // --- GLOBAL EVENT LISTENERS ---
        document.body.addEventListener('click', (e) => { if (audioContext && audioContext.state === 'suspended') audioContext.resume(); });
        logoutBtn.addEventListener('click', handleLogout);
        withdrawalBtn.addEventListener('click', () => { playSound('click'); renderWithdrawalSection(); showSection('withdrawal-section'); });
        referralBtn.addEventListener('click', () => {
            playSound('click');
            renderReferralSection();
            showSection('referral-section');
        });
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); playSound('click'); document.getElementById('register-form-container').classList.remove('active'); document.getElementById('login-form-container').classList.add('active'); document.getElementById('auth-message').textContent = ''; });
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); playSound('click'); document.getElementById('login-form-container').classList.remove('active'); document.getElementById('register-form-container').classList.add('active'); document.getElementById('auth-message').textContent = ''; });
        document.getElementById('start-challenge-btn').addEventListener('click', () => { playSound('click'); showSection('kyc-section'); });
        document.getElementById('telegram-link').addEventListener('click', () => { playSound('click'); document.getElementById('kyc-submitted-btn').disabled = false; });
        document.getElementById('kyc-submitted-btn').addEventListener('click', handleKycSubmission);
        document.getElementById('buy-btn').addEventListener('click', handleTrade);
        document.getElementById('sell-btn').addEventListener('click', handleTrade);
        document.getElementById('next-day-btn').addEventListener('click', handleNextDay);
        document.getElementById('back-to-trade-btn').addEventListener('click', () => { playSound('click'); showSection('trading-section'); });
        document.getElementById('back-to-trade-from-withdrawal-btn').addEventListener('click', () => { playSound('click'); showSection('trading-section'); });
        document.getElementById('back-to-trade-from-referral-btn').addEventListener('click', () => { playSound('click'); showSection('trading-section'); });
        document.getElementById('order-book-tab').addEventListener('click', () => { /* tab logic */ });
        document.getElementById('trade-history-tab').addEventListener('click', () => { /* tab logic */ });
        document.getElementById('copy-referral-btn').addEventListener('click', () => {
            playSound('click');
            const referralLinkDisplay = document.getElementById('referral-link-display');
            referralLinkDisplay.select();
            document.execCommand('copy');
            showToast("تم نسخ الرابط بنجاح!", "success");
        });
        document.getElementById('close-reward-modal-btn').addEventListener('click', () => {
            playSound('click');
            document.getElementById('reward-modal').classList.add('hidden');
        });

        // --- PRICE & MARKET SIMULATION ---
        priceInterval = setInterval(() => { 
            const assetPriceEl = document.getElementById('asset-price');
            if(!assetPriceEl) return;
            
            const change = (Math.random() - 0.5) * 100;
            assetPrice += change;
            if (assetPrice > highPrice) highPrice = assetPrice;
            if (assetPrice < lowPrice) lowPrice = assetPrice;
            
            assetPriceEl.innerText = `$${assetPrice.toFixed(2)}`;
            assetPriceEl.classList.add('flicker');
            setTimeout(()=> assetPriceEl.classList.remove('flicker'), 200);
            
            if (priceChart && priceChart.data.datasets[0].data.length > 0) {
                const candle = { x: Date.now(), o: openPrice, h: highPrice, l: lowPrice, c: assetPrice };
                priceChart.data.datasets[0].data.push(candle);
                if (priceChart.data.datasets[0].data.length > 40) priceChart.data.datasets[0].data.shift();
                priceChart.update('none');
                openPrice = assetPrice; highPrice = assetPrice; lowPrice = assetPrice;
            }
        }, 2000);
        marketActivityInterval = setInterval(updateOrderBook, 3000);
        initNewsTicker();
        handleUrlParams();

    </script>
</body>
</html>
