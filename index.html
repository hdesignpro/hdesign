<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحدي التداول - اربح 5$</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and required adapters -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Candlestick Chart Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --inv-bg: #0f172a;
            --inv-card: #111827;
            --inv-muted: #94a3b8;
            --inv-text: #e5e7eb;
            --inv-accent: #22d3ee;
            --inv-accent-2: #818cf8;
            --inv-ring: rgba(34, 211, 238, 0.35);
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #0f0c29;
            color: #e5e7eb;
            overflow-x: hidden;
        }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card {
            background-color: rgba(10, 5, 20, 0.75);
            border: 1px solid rgba(192, 132, 252, 0.2);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
        }
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        
        #toast-container { position: fixed; bottom: 60px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 10px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transform: translateX(-120%); animation: slideInToast 0.5s forwards, slideOutToast 0.5s 4.5s forwards; }
        .toast.success { background-color: #22c55e; border-left: 5px solid #16a34a; }
        .toast.error { background-color: #ef4444; border-left: 5px solid #dc2626; }
        .toast.info { background-color: #3b82f6; border-left: 5px solid #2563eb; }
        @keyframes slideInToast { from { transform: translateX(-120%); } to { transform: translateX(0); } }
        @keyframes slideOutToast { from { transform: translateX(0); } to { transform: translateX(-120%); } }

        .glowing-divider { height: 1px; background: linear-gradient(to right, transparent, rgba(192, 132, 252, 0.5), transparent); margin: 1rem 0; }
        @keyframes text-flicker { 0%, 100% { opacity: 1; text-shadow: 0 0 2px currentColor; } 50% { opacity: 0.8; text-shadow: 0 0 5px currentColor; } }
        .flicker { animation: text-flicker 0.2s ease-in-out; }
        .trade-widget button:active { transform: scale(0.95); }
        .market-activity-table { font-size: 0.8rem; }
        .market-activity-table tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.03); }
        .market-activity-table td { padding: 4px 8px; }

        #news-ticker { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.5); white-space: nowrap; overflow: hidden; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 999; }
        #news-ticker-content { display: inline-block; padding-left: 100%; animation: ticker-scroll 40s linear infinite; }
        #news-ticker-content span { margin: 0 2rem; color: #a78bfa; }
        @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        /* Modal Styles */
        .modal-backdrop { animation: fadeIn 0.3s ease-in-out; }
        .modal-content { animation: slideIn 0.3s ease-in-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* New Auth Page Styles */
        .bg-grid-pattern {
            background-image:
                linear-gradient(rgba(192, 132, 252, 0.1) 1px, transparent 1px),
                linear-gradient(to right, rgba(192, 132, 252, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Video Background Styles */
        .video-background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Behind everything */
            overflow: hidden;
        }
        .video-background-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 12, 41, 0.7);
            z-index: -1;
        }
        #app {
            position: relative;
            z-index: 10;
        }

        /* Investment Plan Styles */
        .plan-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            border-color: rgba(192, 132, 252, 0.5);
        }
        .plan-card.selected {
            border-color: #c084fc;
            background-color: rgba(192, 132, 252, 0.1);
            box-shadow: 0 0 20px rgba(192, 132, 252, 0.3);
        }
    </style>
</head>
<body class="text-zinc-200">

    <div class="video-background-container">
        <video autoplay loop muted playsinline>
            <source src="https://videos.pexels.com/video-files/3214449/3214449-hd_1920_1080_25fps.mp4" type="video/mp4">
        </video>
    </div>
    <div class="video-overlay"></div>

    <div id="app" class="container mx-auto p-4 max-w-screen-xl pb-20">

        <header class="text-center mb-6 md:relative card p-4 rounded-xl">
             <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-purple-400 flex items-center justify-center gap-3">
                </h1>
            <div id="user-info" class="hidden relative mt-4 md:absolute md:top-4 md:right-4 md:mt-0 bg-zinc-900/50 p-2 rounded-lg text-sm flex items-center justify-center">
                <span id="username-display"></span>
                <button id="referral-btn" class="text-amber-400 hover:text-amber-500 mx-4 font-bold">[الدعوات]</button>
                <button id="withdrawal-btn" class="text-purple-400 hover:text-purple-500 mx-4 font-bold">[السحب]</button>
                <button id="logout-btn" class="text-red-400 hover:text-red-500 font-bold">[خروج]</button>
            </div>
        </header>
        
        <div id="app-loader" class="section active"><div class="loader"></div></div>
        
        <section id="auth-section" class="section card p-0 rounded-xl shadow-lg max-w-4xl mx-auto overflow-hidden">
            <div class="grid md:grid-cols-2">
                <div class="p-8 md:p-12">
                    <div id="register-form-container" class="auth-form active">
                        <h2 class="text-3xl font-semibold mb-6 text-center">إنشاء حساب جديد</h2>
                        <form id="register-form" class="space-y-4">
                            <input type="text" id="register-username" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="اسم المستخدم (باللغة الإنجليزية)" required>
                            <input type="email" id="register-email" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="البريد الإلكتروني" required>
                            <input type="password" id="register-password" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="كلمة المرور" required>
                            <input type="text" id="register-referral" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none" placeholder="كود الدعوة (اختياري)">
                            <button type="submit" class="w-full btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg">إنشاء حساب</button>
                        </form>
                        <p class="text-center mt-6 text-zinc-500">لديك حساب بالفعل؟ <a href="#" id="show-login" class="text-purple-400 hover:underline">سجل الدخول</a></p>
                    </div>
                    <div id="login-form-container" class="auth-form">
                        <h2 class="text-3xl font-semibold mb-6 text-center">تسجيل الدخول</h2>
                        <form id="login-form" class="space-y-4">
                            <input type="email" id="login-email" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" placeholder="البريد الإلكتروني" required>
                            <input type="password" id="login-password" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white placeholder-zinc-500 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" placeholder="كلمة المرور" required>
                            <button type="submit" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">دخول</button>
                        </form>
                        <p class="text-center mt-6 text-zinc-500">ليس لديك حساب؟ <a href="#" id="show-register" class="text-purple-400 hover:underline">أنشئ حساباً جديداً</a></p>
                    </div>
                    <div id="auth-message" class="text-center text-red-400 mt-4 h-5"></div>
                </div>
                 <div class="hidden md:flex flex-col justify-center p-8 bg-purple-900/20 relative">
                    <div class="absolute inset-0 bg-grid-pattern opacity-10"></div>
                    <h2 class="text-4xl font-bold text-white mb-4 z-10">انضم إلى التحدي</h2>
                    <p class="text-purple-200 z-10">أكمل مهام التداول اليومية واكسب مكافآت حقيقية. ابدأ رحلتك الآن!</p>
                </div>
            </div>
        </section>

        <section id="welcome-section" class="section text-center card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-4">مرحباً بك في التحدي!</h2>
            <p class="text-lg text-zinc-300 mb-6 max-w-2xl mx-auto">أنت على وشك بدء تحدي تداول مثير. أكمل المهام اليومية لمدة 3 أيام متتالية لتحصل على 5$.</p>
            <button id="start-challenge-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg text-lg max-w-xs mx-auto">ابدأ التحدي الآن</button>
        </section>

        <section id="kyc-section" class="section card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-2 text-center">الخطوة الأولى: توثيق الهوية (KYC)</h2>
            <p class="text-center text-zinc-400 mb-8">لإكمال عملية التوثيق، الرجاء اتباع الخطوات التالية بدقة.</p>
            <div class="space-y-4 max-w-lg mx-auto">
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">1</div><div><h3 class="font-bold text-lg">صور الهوية الشخصية</h3><p class="text-zinc-400">أرسل صورة أمامية وخلفية واضحة لهويتك.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">2</div><div><h3 class="font-bold text-lg">صورة شخصية (سيلفي)</h3><p class="text-zinc-400">التقط صورة لنفسك وأنت تحمل الهوية بجانب وجهك.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">3</div><div><h3 class="font-bold text-lg">فيديو قصير</h3><p class="text-zinc-400">سجل فيديو قصير (13 ثانية) وأنت تحمل الهوية.</p></div></div>
                <div class="flex items-start gap-4"><div class="flex-shrink-0 bg-purple-500/20 text-purple-400 rounded-full h-10 w-10 flex items-center justify-center font-bold text-lg">4</div><div><h3 class="font-bold text-lg">البريد الإلكتروني</h3><p class="text-zinc-400">لا تنس إرفاق البريد الإلكتروني الذي سجلت به في الموقع.</p></div></div>
            </div>
            <div class="text-center mt-8"><a id="telegram-link" href="https://t.me/kycverifice" target="_blank" class="inline-block btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg mb-4">إرسال المستندات</a><p class="text-sm text-zinc-500">بعد الضغط على الرابط، سيتم تفعيل الزر أدناه.</p></div>
            <button id="kyc-submitted-btn" class="w-full mt-6 btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>لقد أرسلت المستندات</button>
            <div id="kyc-pending-message" class="hidden text-center mt-4 p-4 bg-yellow-900/50 rounded-lg"><p>شكراً لك. طلبك الآن قيد المراجعة.</p></div>
        </section>

        <section id="trading-section" class="section">
            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-12 lg:col-span-3 space-y-6">
                    <div id="account-summary-card" class="card p-4 rounded-xl shadow-lg">
                        </div>
                    <div class="card p-4 rounded-xl shadow-lg">
                        <h3 class="text-lg font-bold mb-3">تنفيذ صفقة</h3>
                        <div class="space-y-3">
                             <input type="number" id="trade-amount" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-3 text-center text-lg placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none" placeholder="أدخل المبلغ">
                             <div class="grid grid-cols-2 gap-3 trade-widget">
                                <button id="buy-btn" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">شراء</button>
                                <button id="sell-btn" class="w-full btn bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg text-lg">بيع</button>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="col-span-12 lg:col-span-6 card p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="text-xl font-bold">BTC/USD</h3><p class="text-zinc-400 text-sm">مخطط الشموع اليابانية (2ث)</p></div>
                        <div class="text-right">
                            <div id="asset-price-container" class="text-3xl font-bold price-up flex items-center justify-end gap-2">
                                <span id="asset-price-arrow">▲</span><span id="asset-price"></span>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-96"><canvas id="priceChart"></canvas></div>
                </div>
                <div class="col-span-12 lg:col-span-3 space-y-6">
                    <div class="card p-4 rounded-xl shadow-lg h-full flex flex-col">
                        <h3 class="text-lg font-bold mb-2">نشاط السوق</h3>
                        <div class="flex border-b border-zinc-700 mb-2">
                            <button id="order-book-tab" class="px-4 py-2 text-purple-400 border-b-2 border-purple-400">سجل الأوامر</button>
                            <button id="trade-history-tab" class="px-4 py-2 text-zinc-500">سجل صفقاتك</button>
                        </div>
                        <div class="flex-grow overflow-y-auto" style="max-height: 350px;">
                            <div id="order-book-content">
                                <table class="w-full market-activity-table">
                                    <thead><tr class="text-zinc-500"><th class="text-right">السعر</th><th class="text-right">الكمية</th></tr></thead>
                                    <tbody id="order-book-asks"></tbody>
                                </table>
                                <div class="glowing-divider my-1"></div>
                                <table class="w-full market-activity-table"><tbody id="order-book-bids"></tbody></table>
                            </div>
                            <div id="trade-history-content" class="hidden">
                                <table class="w-full market-activity-table">
                                    <thead><tr class="text-zinc-500"><th class="text-right">الوقت</th><th class="text-right">النوع</th><th class="text-right">السعر</th></tr></thead>
                                    <tbody id="trade-history-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-span-12 card p-4 sm:p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">سجل المهام - <span id="challenge-title"></span></h3>
                    <div id="task-container" class="space-y-3"></div>
                    <button id="next-day-btn" class="hidden mt-6 w-full btn btn-primary font-bold py-3 px-4 rounded-lg">انتقل لليوم التالي</button>
                </div>
            </div>
        </section>
        
        <section id="referral-section" class="section card p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-semibold mb-2 text-center text-amber-400">ادعُ أصدقاءك واكسب!</h2>
            <p class="text-center text-zinc-400 mb-8">مقابل كل 3 أصدقاء تقوم بدعوتهم ويكملون توثيق الهوية، ستحصل على مكافأة عشوائية تتراوح من 3$ إلى 50$!</p>
            
            <div class="text-center mb-8">
                <p class="text-zinc-400 mb-2">رابط الدعوة الخاص بك:</p>
                <div class="flex justify-center items-center gap-2">
                    <input id="referral-link-display" type="text" class="bg-zinc-800 border border-zinc-700 text-amber-400 font-bold text-lg text-center p-2 rounded-lg w-full" readonly>
                    <button id="copy-referral-btn" class="btn bg-amber-500 hover:bg-amber-600 text-white p-3 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M216,32H88a8,8,0,0,0-8,8V80H40a8,8,0,0,0-8,8V216a8,8,0,0,0,8,8H168a8,8,0,0,0,8-8V176h40a8,8,0,0,0,8-8V40A8,8,0,0,0,216,32ZM160,208H48V96H160Zm48-48H176V88a8,8,0,0,0-8-8H96V48H208Z"></path></svg>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4">الأصدقاء الذين دعوتهم</h3>
                <div id="referral-list-container" class="space-y-3 max-h-64 overflow-y-auto"></div>
            </div>
            <button id="back-to-trade-from-referral-btn" class="mt-8 w-full btn bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-6 rounded-lg">العودة إلى التداول</button>
        </section>

        <section id="investment-section" class="section card p-6 md:p-8 rounded-xl">
            <div class="text-center">
                <h2 class="text-3xl font-bold mb-2 text-purple-400">🎉 تهانينا على إكمال التحدي! 🎉</h2>
                <p class="text-lg text-zinc-300 mb-6">أنت الآن مؤهل لبدء الاستثمار الحقيقي. اختر خطتك لبدء جني أرباح يومية.</p>
            </div>
            <div class="space-y-4 my-8">
                <div class="text-center text-zinc-400"><span class="bg-purple-500/20 text-purple-300 rounded-full h-10 w-10 inline-flex items-center justify-center font-bold text-lg mb-2">1</span><p>اختر خطتك المفضلة بالأسفل.</p></div>
                <div class="text-center text-zinc-400"><span class="bg-purple-500/20 text-purple-300 rounded-full h-10 w-10 inline-flex items-center justify-center font-bold text-lg mb-2">2</span><p>اضغط على زر "تواصل مع الدعم".</p></div>
                <div class="text-center text-zinc-400"><span class="bg-purple-500/20 text-purple-300 rounded-full h-10 w-10 inline-flex items-center justify-center font-bold text-lg mb-2">3</span><p>أرسل لهم اسم المستخدم والخطة التي اخترتها.</p></div>
            </div>
            <div id="plans-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            <div id="selection-feedback" class="text-center mt-6 h-12 flex items-center justify-center">
                 <p class="text-zinc-500">الرجاء اختيار خطة للبدء.</p>
            </div>
            <div class="mt-4 text-center">
                 <a id="contact-support-btn" href="https://t.me/kycverifice" target="_blank" class="w-full md:w-auto inline-block btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg text-lg">تواصل مع الدعم الفني لتفعيل الخطة</a>
            </div>
        </section>

        <section id="admin-dashboard-section" class="section space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6 rounded-xl flex items-center gap-4"><div class="text-3xl">👥</div><div><p class="text-zinc-400">إجمالي المستخدمين</p><p id="admin-total-users" class="text-2xl font-bold">0</p></div></div>
                <div class="card p-6 rounded-xl flex items-center gap-4"><div class="text-3xl">⏳</div><div><p class="text-zinc-400">توثيق قيد الانتظار</p><p id="admin-pending-kyc" class="text-2xl font-bold text-yellow-400">0</p></div></div>
                <div class="card p-6 rounded-xl flex items-center gap-4"><div class="text-3xl">📈</div><div><p class="text-zinc-400">إجمالي المستثمرين</p><p id="admin-total-investors" class="text-2xl font-bold text-cyan-400">0</p></div></div>
            </div>

            <div class="card p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">كل المستخدمين</h2>
                    <input type="text" id="admin-user-search" class="bg-zinc-800 border border-zinc-700 rounded-lg p-2 placeholder-zinc-500 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="ابحث عن مستخدم...">
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="sticky top-0 bg-gray-900/50 backdrop-blur-sm"><tr><th class="p-2">اسم المستخدم</th><th class="p-2">الحالة</th><th class="p-2">إجراءات</th></tr></thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="card p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4">المستثمرون النشطون</h2>
                <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="sticky top-0 bg-gray-900/50 backdrop-blur-sm"><tr><th class="p-2">اسم المستخدم</th><th class="p-2">الخطة</th><th class="p-2">اليوم</th><th class="p-2">إجراءات</th></tr></thead>
                        <tbody id="investors-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div id="reward-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="card rounded-xl shadow-2xl p-8 text-center max-w-sm mx-auto modal-content">
            <div class="text-amber-400 mb-4"><svg class="w-16 h-16 mx-auto" xmlns="http://www.w3.org/2000/svg" width="192" height="192" fill="currentColor" viewBox="0 0 256 256"><path d="M224,104a32,32,0,0,1-32,32H64a32,32,0,0,1,0-64H192A32,32,0,0,1,224,104Zm-64-32H64a32.06,32.06,0,0,0-31.81,29.33L16,112v48a8,8,0,0,0,16,0V144H224v16a8,8,0,0,0,16,0V112l-16.19-10.67A32.06,32.06,0,0,0,192,72Zm-8,64H152a8,8,0,0,0,0,16h48a8,8,0,0,0,0-16Zm-24-32H128a8,8,0,0,0,0,16h24a8,8,0,0,0,0-16Zm-48,0H80a8,8,0,0,0,0,16h24a8,8,0,0,0,0-16Zm-40,32H56a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Z"></path></svg></div>
            <h3 class="text-2xl font-bold mb-2">🎉 تهانينا! 🎉</h3>
            <p class="text-zinc-300 mb-6">لقد حصلت على مكافأة دعوة بقيمة:</p>
            <p id="reward-amount" class="text-5xl font-bold text-amber-400 mb-6">$0.00</p>
            <button id="close-reward-modal-btn" class="btn bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-8 rounded-lg">رائع!</button>
        </div>
    </div>
    <div id="admin-user-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div id="admin-user-details-content" class="card rounded-xl shadow-2xl p-8 max-w-lg w-full mx-auto modal-content space-y-4"></div>
    </div>

    <div id="toast-container"></div>
    <div id="news-ticker"><div id="news-ticker-content"></div></div>

    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, serverTimestamp, writeBatch, increment, onSnapshot, addDoc, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /*
    *** قواعد الأمان الجديدة - الرجاء النسخ والتطبيق في Firestore ***

    ```javascript
    rules_version = '2';
    service cloud.firestore {

      // --- Functions (Declared at the correct top level) ---
      function isAdmin() {
        // Using a hardcoded UID for the temporary solution.
        return request.auth.uid == "SKZ9pdc5zaNy6kWcUjP65UJWF473";
      }
      function areAllTasksCompleted(tasks) {
        return tasks[0].completed == true && tasks[1].completed == true && tasks[2].completed == true;
      }
      function isTaskProgressionValid(prevTasks, nextTasks) {
        return (
          (prevTasks[0].completed == false && nextTasks[0].completed == true && prevTasks[1] == nextTasks[1] && prevTasks[2] == nextTasks[2]) ||
          (prevTasks[0].completed == true && prevTasks[1].completed == false && nextTasks[0].completed == true && nextTasks[1].completed == true && prevTasks[2] == nextTasks[2]) ||
          (prevTasks[0].completed == true && prevTasks[1].completed == true && prevTasks[2].completed == false && nextTasks[0].completed == true && nextTasks[1].completed == true && nextTasks[2].completed == true) ||
          (areAllTasksCompleted(prevTasks) && prevTasks == nextTasks)
        );
      }

      match /databases/{database}/documents {

        match /usernames/{username} {
          allow read: if true;
          allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        }

        match /users/{userId} {
          allow create: if request.auth.uid == userId;
          allow read: if request.auth.uid == userId || isAdmin();
          allow delete: if isAdmin();
          allow update: if
            isAdmin() ||
            (request.auth.uid == userId &&
              // --- Fields that user can NEVER change ---
              request.resource.data.balance == resource.data.balance &&
              request.resource.data.referralBalance == resource.data.referralBalance &&
              request.resource.data.isBanned == resource.data.isBanned &&
              request.resource.data.referralCode == resource.data.referralCode &&
              request.resource.data.referrals == resource.data.referrals &&
              request.resource.data.email == resource.data.email &&
              request.resource.data.username == resource.data.username &&
              request.resource.data.kycVerified == resource.data.kycVerified &&

              // --- Allowed User Actions ---
              (
                // ACTION 1: Submitting KYC request
                (request.resource.data.kycPending == true && resource.data.kycPending == false &&
                 request.resource.data.days == resource.data.days &&
                 request.resource.data.investmentPlan == resource.data.investmentPlan) ||

                // ACTION 2: Playing the 3-day challenge
                (request.resource.data.kycPending == resource.data.kycPending &&
                 resource.data.investmentPlan.active == false &&
                 request.resource.data.investmentPlan == resource.data.investmentPlan &&
                 (
                    (request.resource.data.currentDay == resource.data.currentDay &&
                     isTaskProgressionValid(resource.data.days[resource.data.currentDay - 1].tasks, request.resource.data.days[resource.data.currentDay - 1].tasks)) ||
                    (request.resource.data.currentDay == resource.data.currentDay + 1 &&
                     areAllTasksCompleted(resource.data.days[resource.data.currentDay - 1].tasks) &&
                     request.time.toMillis() > resource.data.days[resource.data.currentDay - 1].completionTimestamp + (24 * 60 * 60 * 1000))
                 )) ||
                
                // ACTION 3: Playing the investment challenge
                (request.resource.data.kycPending == resource.data.kycPending &&
                 resource.data.investmentPlan.active == true &&
                 request.resource.data.days == resource.data.days &&
                 request.resource.data.currentDay == resource.data.currentDay &&
                 // Only allow task progression within the investment plan
                 isTaskProgressionValid(
                    resource.data.investmentPlan.days[resource.data.investmentPlan.currentDay - 1].tasks,
                    request.resource.data.investmentPlan.days[resource.data.investmentPlan.currentDay - 1].tasks
                 ) &&
                 // Ensure other investment plan properties are not changed by the user
                 request.resource.data.investmentPlan.active == resource.data.investmentPlan.active &&
                 request.resource.data.investmentPlan.planName == resource.data.investmentPlan.planName &&
                 request.resource.data.investmentPlan.amount == resource.data.investmentPlan.amount &&
                 request.resource.data.investmentPlan.dailyProfit == resource.data.investmentPlan.dailyProfit &&
                 request.resource.data.investmentPlan.currentDay == resource.data.investmentPlan.currentDay
                )
              )
            );
        }
        match /withdrawals/{withdrawalId} {
          allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
          allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
          allow update: if isAdmin();
          allow list: if isAdmin();
        }
      }
    }
    ```
    */

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCg8-1mCCdJm_5a3920D9q3IOjezg3-D_Y",
            authDomain: "trading-56231.firebaseapp.com",
            databaseURL: "https://trading-56231.firebaseio.com",
            projectId: "trading-56231",
            storageBucket: "trading-56231.firebasestorage.app",
            messagingSenderId: "158943830558",
            appId: "1:158943830558:web:951042cf11154a3745440f",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & VARS ---
        let state = {};
        let currentUserId = null;
        const ADMIN_UID = "SKZ9pdc5zaNy6kWcUjP65UJWF473"; // ** CORRECTED UID **
        let allUsersCache = []; // For admin search
        let userUnsubscribe = null; 
        let adminUnsubscribeUsers = null;
        let adminUnsubscribeWithdrawals = null;
        let countdownInterval = null;
        let priceInterval = null;
        let marketActivityInterval = null;
        let priceChart = null;
        let assetPrice = 60000.00;
        let openPrice = assetPrice;
        let highPrice = assetPrice;
        let lowPrice = assetPrice;

        const defaultState = {
            username: '', email: '', kycVerified: false, kycPending: false, isBanned: false, currentDay: 1, balance: 1000, referralBalance: 0, tradeHistory: [], referralCode: '', referrals: {}, createdAt: serverTimestamp(),
            days: [
                { tasks: [{ description: "شراء بيتكوين بقيمة 50$", action: 'buy', amount: 50, completed: false },{ description: "بيع بيتكوين بقيمة 75$", action: 'sell', amount: 75, completed: false },{ description: "شراء بيتكوين بقيمة 100$", action: 'buy', amount: 100, completed: false }], allTasksCompleted: false, completionTimestamp: null },
                { tasks: [{ description: "شراء بيتكوين بقيمة 125$", action: 'buy', amount: 125, completed: false },{ description: "شراء بيتكوين بقيمة 150$", action: 'buy', amount: 150, completed: false },{ description: "بيع بيتكوين بقيمة 200$", action: 'sell', amount: 200, completed: false }], allTasksCompleted: false, completionTimestamp: null },
                { tasks: [{ description: "بيع بيتكوين بقيمة 250$", action: 'sell', amount: 250, completed: false },{ description: "شراء بيتكوين بقيمة 300$", action: 'buy', amount: 300, completed: false },{ description: "بيع بيتكوين بقيمة 350$", action: 'sell', amount: 350, completed: false }], allTasksCompleted: false, completionTimestamp: null }
            ],
            investmentPlan: {
                active: false,
                planName: null,
                amount: 0,
                startDate: null,
                dailyProfit: 0,
                currentDay: 1,
                days: [] // Will be populated with 90 days of tasks
            }
        };
        
        // --- DOM ELEMENTS ---
        const allSections = document.querySelectorAll('.section');
        const appLoader = document.getElementById('app-loader');
        const userInfoEl = document.getElementById('user-info');
        const usernameDisplayEl = document.getElementById('username-display');
        const logoutBtn = document.getElementById('logout-btn');
        const withdrawalBtn = document.getElementById('withdrawal-btn');
        const referralBtn = document.getElementById('referral-btn');
        const toastContainer = document.getElementById('toast-container');
        const mainTitle = document.getElementById('main-title');
        
        // --- SOUND ENGINE ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!audioContext || audioContext.state !== 'running') return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
            if (type === 'click') {
                oscillator.type = 'triangle'; oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.1);
            } else if (type === 'success') {
                oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(1046.50, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            } else if (type === 'error') {
                oscillator.type = 'square'; oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(110, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.2);
            }
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        // --- CORE FUNCTIONS ---
        function showSection(sectionId) { allSections.forEach(s => s.classList.toggle('active', s.id === sectionId)); }
        
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            if(!element) return;
            element.classList.add('flicker');
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.innerHTML = `$${(progress * (end - start) + start).toFixed(2)}`;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
            setTimeout(() => element.classList.remove('flicker'), 200);
        }
        
        // --- AUTH FUNCTIONS ---
        async function handleRegister(e) {
            e.preventDefault(); playSound('click');
            const btn = e.target.querySelector('button');
            const authMessageEl = document.getElementById('auth-message');
            btn.disabled = true; btn.textContent = 'جاري الإنشاء...'; authMessageEl.textContent = '';
            
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value.trim();

            if (!username || !/^[a-zA-Z0-9]+$/.test(username)) { authMessageEl.textContent = "اسم المستخدم يجب أن يحتوي على حروف وأرقام إنجليزية فقط."; btn.disabled = false; btn.textContent = 'إنشاء حساب'; playSound('error'); return; }
            
            try {
                const usernameSnap = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameSnap.exists()) {
                    authMessageEl.textContent = "اسم المستخدم هذا مستخدم بالفعل.";
                    throw new Error("Username taken");
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: username });

                const newUserReferralCode = username.toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
                
                const batch = writeBatch(db);
                
                const newUserDocRef = doc(db, "users", user.uid);
                // Use a deep copy of defaultState to avoid mutation issues
                const newUserState = JSON.parse(JSON.stringify(defaultState));
                newUserState.username = username;
                newUserState.email = email;
                newUserState.referralCode = newUserReferralCode;
                newUserState.createdAt = serverTimestamp();
                
                if (referralCode) {
                    newUserState.enteredReferralCode = referralCode;
                }

                batch.set(newUserDocRef, newUserState);
                
                const usernameDocRef = doc(db, "usernames", username.toLowerCase());
                batch.set(usernameDocRef, { userId: user.uid });

                await batch.commit();

            } catch (error) {
                console.error("Registration error: ", error);
                if (!authMessageEl.textContent) {
                    authMessageEl.textContent = error.code === 'auth/email-already-in-use' ? "هذا البريد الإلكتروني مسجل بالفعل." : "حدث خطأ غير متوقع.";
                }
                playSound('error');
            } finally {
                btn.disabled = false; btn.textContent = 'إنشاء حساب';
            }
        }
        async function handleLogin(e) {
            e.preventDefault(); playSound('click');
            const btn = e.target.querySelector('button');
            const authMessageEl = document.getElementById('auth-message');
            btn.disabled = true; btn.textContent = 'جاري الدخول...'; authMessageEl.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch (error) { authMessageEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة."; playSound('error'); }
            finally { btn.disabled = false; btn.textContent = 'دخول'; }
        }
        function handleLogout() { 
            playSound('click'); 
            if (priceInterval) clearInterval(priceInterval); 
            if(marketActivityInterval) clearInterval(marketActivityInterval); 
            if (userUnsubscribe) userUnsubscribe();
            if (adminUnsubscribeUsers) adminUnsubscribeUsers();
            if (adminUnsubscribeWithdrawals) adminUnsubscribeWithdrawals();
            signOut(auth); 
        }

        // --- TASK & TRADE LOGIC ---
        function renderTasks(isInvestment = false) { 
            const taskContainer = document.getElementById('task-container');
            if(!taskContainer) return;

            const challengeData = isInvestment ? state.investmentPlan : state;
            const dayIndex = challengeData.currentDay - 1;

            if (!challengeData?.days?.[dayIndex]) { 
                taskContainer.innerHTML = `<p>جاري تحميل مهام اليوم...</p>`; 
                return; 
            }

            const currentDayData = challengeData.days[dayIndex];
            if (currentDayData.allTasksCompleted) { 
                checkDayCompletion(isInvestment); 
                return; 
            }

            let tasksHtml = '';
            let isCurrentTaskFound = false;
            currentDayData.tasks.forEach(task => {
                let statusClass = '', icon;
                if (task.completed) {
                    statusClass = 'completed';
                    icon = `<div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,77.66l-128,128a8,8,0,0,1-11.32,0l-56-56a8,8,0,0,1,11.32-11.32L96,188.69,218.34,66.34a8,8,0,0,1,11.32,11.32Z"></path></svg></div>`;
                } else if (!isCurrentTaskFound) {
                    statusClass = 'current';
                    icon = `<div class="w-6 h-6 rounded-full bg-purple-500/20 border-2 border-purple-500 flex items-center justify-center"><div class="w-2 h-2 bg-purple-400 rounded-full"></div></div>`;
                    isCurrentTaskFound = true;
                } else {
                    icon = `<div class="w-6 h-6 rounded-full bg-zinc-700 border-2 border-zinc-500"></div>`;
                }
                tasksHtml += `<div class="task-item flex items-center gap-4 p-4 rounded-lg bg-zinc-800 border border-transparent transition-all duration-300 ${statusClass}">${icon}<p class="flex-grow ${task.completed ? 'line-through text-zinc-500' : ''}">${task.description}</p></div>`;
            });
            taskContainer.innerHTML = tasksHtml;
        }

        async function handleTrade(event) { 
            playSound('click');
            const isInvestment = state.investmentPlan.active;
            const tradeAmountInput = document.getElementById('trade-amount');
            
            const challengeData = isInvestment ? state.investmentPlan : state;
            const dayIndex = challengeData.currentDay - 1;
            const taskToComplete = challengeData.days[dayIndex].tasks.find(t => !t.completed);

            if (!taskToComplete) { showToast('لقد أكملت جميع مهام اليوم!', 'success'); return; }
            
            const amount = parseFloat(tradeAmountInput.value);
            const action = event.target.closest('button').id.includes('buy') ? 'buy' : 'sell';
            
            if (isNaN(amount) || amount <= 0) { showToast('مبلغ غير صالح.', 'error'); playSound('error'); return; }
            if (action === 'buy' && amount > state.balance) { showToast('رصيدك غير كافٍ.', 'error'); playSound('error'); return; }
            
            if (action !== taskToComplete.action || amount !== taskToComplete.amount) {
                showToast('صفقة خاطئة! المهمة تتطلب إجراءً أو مبلغاً مختلفًا.', 'error');
                playSound('error');
                return;
            }

            const newState = JSON.parse(JSON.stringify(state));
            const challengeToUpdate = isInvestment ? newState.investmentPlan : newState;
            const dayTasks = challengeToUpdate.days[dayIndex].tasks;
            const taskIndex = dayTasks.findIndex(t => !t.completed);
            
            dayTasks[taskIndex].completed = true;
            newState.tradeHistory.unshift({ time: new Date().toLocaleTimeString('ar-EG'), type: action, price: assetPrice, amount: amount });
            if(newState.tradeHistory.length > 20) newState.tradeHistory.pop();

            try {
                const updatePayload = {
                    tradeHistory: newState.tradeHistory
                };

                if (isInvestment) {
                    updatePayload.investmentPlan = newState.investmentPlan;
                } else {
                    updatePayload.days = newState.days;
                }

                await updateDoc(doc(db, "users", currentUserId), updatePayload);
                
                playSound('success');
                showToast('أحسنت! تم إنجاز المهمة.');
                
                const allDone = dayTasks.every(t => t.completed);
                if (allDone) {
                    const completionPath = isInvestment 
                        ? `investmentPlan.days.${dayIndex}.allTasksCompleted`
                        : `days.${dayIndex}.allTasksCompleted`;
                    const timestampPath = isInvestment
                        ? `investmentPlan.days.${dayIndex}.completionTimestamp`
                        : `days.${dayIndex}.completionTimestamp`;
                    
                    await updateDoc(doc(db, "users", currentUserId), {
                        [completionPath]: true,
                        [timestampPath]: Date.now()
                    });
                }

            } catch (error) {
                console.error("Trade failed:", error);
                showToast("فشل حفظ التقدم. قد يكون بسبب قواعد الأمان.", "error");
                playSound('error');
            }
        }

        async function checkDayCompletion(isInvestment = false) { 
            const taskContainer = document.getElementById('task-container');
            const nextDayBtn = document.getElementById('next-day-btn');
            if(!taskContainer || !nextDayBtn) return;

            const challengeData = isInvestment ? state.investmentPlan : state;
            const dayIndex = challengeData.currentDay - 1;
            if (!challengeData.days?.[dayIndex]) return;
            const currentDayData = challengeData.days[dayIndex];
            
            if (currentDayData.allTasksCompleted) {
                nextDayBtn.classList.add('hidden');
                const timeRemaining = (24 * 3600 * 1000) - (Date.now() - currentDayData.completionTimestamp);
                
                if (timeRemaining <= 0) {
                    let message = `<div class="text-center p-4 bg-zinc-800 rounded-lg"><h4 class="text-lg font-semibold mb-2 text-green-400">✅ اكتمل اليوم ${challengeData.currentDay}!</h4>`;
                    if (isInvestment) {
                        message += `<p>في انتظار موافقة المدير لإضافة أرباح اليوم.</p></div>`;
                    } else {
                        message += `<p>يمكنك الآن الانتقال إلى اليوم التالي.</p></div>`;
                        nextDayBtn.classList.remove('hidden');
                        nextDayBtn.innerText = state.currentDay < 3 ? `انتقل لليوم ${state.currentDay + 1}` : 'إنهاء التحدي والانتقال للاستثمار';
                    }
                    taskContainer.innerHTML = message;
                } else {
                    displayCountdown(timeRemaining, isInvestment);
                }
            } else {
                nextDayBtn.classList.add('hidden');
            }
        }
        function displayCountdown(ms, isInvestment = false) { 
            const taskContainer = document.getElementById('task-container');
            if(!taskContainer) return;
            clearInterval(countdownInterval);
            const challengeData = isInvestment ? state.investmentPlan : state;
            taskContainer.innerHTML = `<div class="text-center p-4 bg-zinc-800 rounded-lg"><h4 class="text-lg font-semibold mb-2 text-purple-400">اليوم ${challengeData.currentDay} مكتمل!</h4><p>سيتم فتح اليوم التالي خلال:</p><div id="countdown" class="text-3xl font-bold my-2"></div></div>`;
            const countdownEl = document.getElementById('countdown');
            countdownInterval = setInterval(() => {
                const totalSeconds = Math.floor(ms / 1000);
                const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const s = String(totalSeconds % 60).padStart(2, '0');
                countdownEl.textContent = `${h}:${m}:${s}`;
                ms -= 1000;
                if (ms < 0) { 
                    clearInterval(countdownInterval); 
                    checkDayCompletion(isInvestment); 
                }
            }, 1000);
        }
        async function handleNextDay() { 
            playSound('click');
            const isInvestment = state.investmentPlan.active;

            if (isInvestment) {
                 if (state.investmentPlan.currentDay < 90) {
                    try {
                        await updateDoc(doc(db, "users", currentUserId), { 'investmentPlan.currentDay': state.investmentPlan.currentDay + 1 });
                    } catch (error) {
                        console.error("Failed to advance investment day:", error);
                        showToast("لا يمكنك الانتقال لليوم التالي بعد.", "error");
                    }
                 } else {
                    showToast('لقد أكملت خطتك الاستثمارية!', 'success');
                 }
            } else {
                if (state.currentDay < 3) {
                    try {
                        await updateDoc(doc(db, "users", currentUserId), { currentDay: state.currentDay + 1 });
                    } catch (error) {
                        console.error("Failed to advance day:", error);
                        showToast("لا يمكنك الانتقال لليوم التالي بعد.", "error");
                    }
                } else {
                    playSound('success');
                    showSection('investment-section');
                }
            }
        }
        
        async function handleKycSubmission(e) { 
            e.preventDefault();
            playSound('click');
            try {
                // Attempt to set kycPending to true. Rules will validate this change.
                await updateDoc(doc(db, "users", currentUserId), { kycPending: true });
            } catch (error) {
                console.error("KYC Submission Error:", error);
                showToast("فشل إرسال الطلب.", "error");
            }
        }
        
        // --- REFERRAL LOGIC ---
        function renderReferralSection() {
            const referralLinkDisplay = document.getElementById('referral-link-display');
            const referralListContainer = document.getElementById('referral-list-container');
            if(!referralLinkDisplay) return;
            
            const baseUrl = window.location.origin + window.location.pathname;
            referralLinkDisplay.value = `${baseUrl}?ref=${state.referralCode}`;

            if (!state.referrals || Object.keys(state.referrals).length === 0) {
                referralListContainer.innerHTML = `<p class="text-zinc-500 text-center">لم تقم بدعوة أي شخص بعد.</p>`;
                return;
            }

            let listHtml = '';
            for (const uid in state.referrals) {
                const referral = state.referrals[uid];
                let statusText, statusColor;
                switch(referral.status) {
                    case 'verified':
                        statusText = 'تم التوثيق';
                        statusColor = 'text-green-400';
                        break;
                    case 'rewarded':
                        statusText = 'تمت المكافأة';
                        statusColor = 'text-amber-400';
                        break;
                    default:
                        statusText = 'مسجل';
                        statusColor = 'text-zinc-400';
                }
                listHtml += `
                    <div class="flex justify-between items-center bg-zinc-800 p-3 rounded-lg">
                        <p>${referral.username}</p>
                        <span class="font-bold ${statusColor}">${statusText}</span>
                    </div>
                `;
            }
            referralListContainer.innerHTML = listHtml;
        }

        function showRewardModal(amount) {
            const modal = document.getElementById('reward-modal');
            const amountEl = document.getElementById('reward-amount');
            amountEl.innerText = `$${amount.toFixed(2)}`;
            modal.classList.remove('hidden');
        }

        // --- MARKET ACTIVITY LOGIC ---
        function renderTradeHistory() { 
            const tradeHistoryBody = document.getElementById('trade-history-body');
            if(!tradeHistoryBody) return;
            tradeHistoryBody.innerHTML = (state.tradeHistory || []).map(trade => `
                <tr>
                    <td>${trade.time}</td>
                    <td class="${trade.type === 'buy' ? 'text-green-500' : 'text-red-500'}">${trade.type === 'buy' ? 'شراء' : 'بيع'}</td>
                    <td>$${trade.price.toFixed(2)}</td>
                </tr>
            `).join('');
        }
        function updateOrderBook() { 
            const orderBookAsks = document.getElementById('order-book-asks');
            const orderBookBids = document.getElementById('order-book-bids');
            if(!orderBookAsks || !orderBookBids) return;
            
            const currentPrice = assetPrice;
            if(isNaN(currentPrice)) return;
            let asksHtml = '';
            let bidsHtml = '';
            for (let i = 0; i < 8; i++) {
                const askPrice = currentPrice + (Math.random() * 10) * (i + 1);
                const askAmount = (Math.random() * 0.5).toFixed(4);
                asksHtml = `<tr><td class="text-red-500">${askPrice.toFixed(2)}</td><td>${askAmount}</td></tr>` + asksHtml;
                
                const bidPrice = currentPrice - (Math.random() * 10) * (i + 1);
                const bidAmount = (Math.random() * 0.5).toFixed(4);
                bidsHtml += `<tr><td class="text-green-500">${bidPrice.toFixed(2)}</td><td>${bidAmount}</td></tr>`;
            }
            orderBookAsks.innerHTML = asksHtml;
            orderBookBids.innerHTML = bidsHtml;
        }

        // --- NEWS TICKER LOGIC ---
        function initNewsTicker() { 
            const newsItems = [ "البنك المركزي يلمح إلى رفع أسعار الفائدة الأسبوع المقبل.", "شركة تكنولوجيا كبرى تعلن عن قبول الدفع بالعملات الرقمية.", "بيانات التضخم تأتي أقل من المتوقع، مما يعزز الأسواق.", "تقارير عن تبني دولي واسع لتقنية البلوك تشين.", "مؤشر ثقة المستهلك يسجل أعلى مستوى له في عامين.", "تحذيرات من تقلبات حادة في أسواق الطاقة العالمية." ];
            document.getElementById('news-ticker-content').innerHTML = newsItems.map(item => `<span>⚡</span> ${item}`).join('');
        }

        // --- CHART LOGIC (CANDLESTICK) ---
        function generateInitialData(count, initialPrice, intervalSeconds) {
            const data = [];
            let price = initialPrice;
            let time = new Date();
            time.setSeconds(time.getSeconds() - count * intervalSeconds);

            for (let i = 0; i < count; i++) {
                const open = price;
                const close = open + (Math.random() - 0.5) * 50;
                const high = Math.max(open, close) + Math.random() * 20;
                const low = Math.min(open, close) - Math.random() * 20;
                data.push({ x: time.getTime(), o: open, h: high, l: low, c: close });
                price = close;
                time.setSeconds(time.getSeconds() + intervalSeconds);
            }
            assetPrice = price;
            openPrice = price;
            highPrice = price;
            lowPrice = price;
            return data;
        }
        function initPriceChart() { 
            const chartCanvas = document.getElementById('priceChart');
            if(!chartCanvas) return;
            if(priceChart) priceChart.destroy();
            const initialData = generateInitialData(39, 60000, 2);
            const ctx = chartCanvas.getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'candlestick',
                data: { 
                    datasets: [{ 
                        label: 'BTC/USD', 
                        data: initialData,
                        color: {
                            up: '#22c55e',
                            down: '#ef4444',
                            unchanged: '#9ca3af',
                        }
                    }] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        x: { type: 'time', time: { unit: 'second' }, display: false }, 
                        y: { ticks: { color: 'rgba(255,255,255,0.3)' }, grid: { color: 'rgba(255,255,255,0.1)' } } 
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: true } }
                }
            });
        }
        
        // --- URL PARAM HANDLER ---
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const refCode = params.get('ref');
            if (refCode) {
                const referralInput = document.getElementById('register-referral');
                if (referralInput) {
                    referralInput.value = refCode;
                }
            }
        }

        // --- ADMIN DASHBOARD LOGIC ---
        function setupAdminDashboardListeners() {
            const usersQuery = query(collection(db, "users"));
            adminUnsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                allUsersCache = users;
                renderUsersTable(users);
                renderInvestorsTable(users);
                renderAdminStats(users);
            });
            
            const withdrawalsQuery = query(collection(db, "withdrawals"), orderBy("requestedAt", "desc"));
            adminUnsubscribeWithdrawals = onSnapshot(withdrawalsQuery, (snapshot) => {
                const withdrawals = [];
                snapshot.forEach(doc => withdrawals.push({ id: doc.id, ...doc.data() }));
                // renderWithdrawalsTable(withdrawals);
                // renderAdminStats(null, withdrawals);
            });
        }

        function renderAdminStats(users) {
            if (users) {
                document.getElementById('admin-total-users').textContent = users.length;
                document.getElementById('admin-pending-kyc').textContent = users.filter(u => u.kycPending && !u.kycVerified).length;
                document.getElementById('admin-total-investors').textContent = users.filter(u => u.investmentPlan?.active).length;
            }
        }

        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            if (!tableBody) return;
            const searchTerm = document.getElementById('admin-user-search').value.toLowerCase();
            const filteredUsers = users.filter(user => user.username && user.username.toLowerCase().includes(searchTerm));

            tableBody.innerHTML = filteredUsers.map(user => {
                let statusHtml = '';
                if (user.isBanned) {
                    statusHtml = `<span class="text-red-500 font-bold">محظور</span>`;
                } else if (user.investmentPlan?.active) {
                    statusHtml = `<span class="text-cyan-400 font-bold">مستثمر</span>`;
                } else if (user.kycVerified) {
                    statusHtml = `<span class="text-green-400 font-bold">موثّق</span>`;
                } else if (user.kycPending) {
                    statusHtml = `<span class="text-yellow-400">قيد المراجعة</span>`;
                } else {
                    statusHtml = `<span class="text-zinc-500">جديد</span>`;
                }
                
                return `
                    <tr class="border-b border-gray-700 ${user.isBanned ? 'opacity-50' : ''}">
                        <td class="p-2">${user.username}</td>
                        <td class="p-2">${statusHtml}</td>
                        <td class="p-2 flex gap-2">
                            <button data-userid="${user.id}" class="view-user-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded">عرض</button>
                        </td>
                    </tr>`;
            }).join('');
        }

        function renderInvestorsTable(users) {
            const tableBody = document.getElementById('investors-table-body');
            if (!tableBody) return;
            const investors = users.filter(u => u.investmentPlan?.active && !u.isBanned);

            tableBody.innerHTML = investors.map(user => {
                const plan = user.investmentPlan;
                return `
                    <tr class="border-b border-gray-700">
                        <td class="p-2">${user.username}</td>
                        <td class="p-2">${plan.planName}</td>
                        <td class="p-2">${plan.currentDay} / 90</td>
                        <td class="p-2 flex gap-2">
                            <button data-userid="${user.id}" class="view-user-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded">إدارة</button>
                        </td>
                    </tr>`;
            }).join('');
        }
        
        async function showUserDetailsModal(userId) {
            const modal = document.getElementById('admin-user-details-modal');
            const content = document.getElementById('admin-user-details-content');
            const userDoc = await getDoc(doc(db, "users", userId));
            if (!userDoc.exists()) { showToast("المستخدم غير موجود", "error"); return; }
            const user = userDoc.data();
            
            let kycActionHtml = '';
            if (user.kycPending && !user.kycVerified) {
                kycActionHtml = `<button id="approve-kyc-btn" class="w-full btn bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">الموافقة على التوثيق</button>`;
            }

            let investmentActionHtml = '';
            if (user.kycVerified && !user.investmentPlan?.active) {
                investmentActionHtml = `
                    <div class="border-t border-zinc-700 pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-2">تفعيل خطة استثمار</h4>
                        <select id="investment-plan-select" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-2 mb-2">
                            <option value="10">خطة 10$</option>
                            <option value="20">خطة 20$</option>
                            <option value="50">خطة 50$</option>
                            <option value="100">خطة 100$</option>
                            <option value="200">خطة 200$</option>
                            <option value="500">خطة 500$</option>
                        </select>
                        <button id="activate-investment-btn" class="w-full btn bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg">تفعيل الخطة</button>
                    </div>`;
            } else if (user.investmentPlan?.active) {
                const currentAmount = user.investmentPlan.amount;
                const higherPlans = [10, 20, 50, 100, 200, 500].filter(p => p > currentAmount);
                if (higherPlans.length > 0) {
                    investmentActionHtml = `
                    <div class="border-t border-zinc-700 pt-4 mt-4">
                        <h4 class="text-lg font-bold mb-2">ترقية الخطة الحالية (${user.investmentPlan.planName})</h4>
                        <select id="upgrade-plan-select" class="w-full bg-zinc-800 border-zinc-700 rounded-lg p-2 mb-2">
                            ${higherPlans.map(p => `<option value="${p}">ترقية إلى خطة ${p}$</option>`).join('')}
                        </select>
                        <button id="upgrade-investment-btn" class="w-full btn bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg">ترقية</button>
                    </div>`;
                }
            }

            let dailyProfitActionHtml = '';
            if (user.investmentPlan?.active) {
                const dayIndex = user.investmentPlan.currentDay - 1;
                const investmentDay = user.investmentPlan.days[dayIndex];
                if (investmentDay?.allTasksCompleted && !investmentDay?.profitPaid) {
                     dailyProfitActionHtml = `<button id="approve-profit-btn" class="w-full btn bg-amber-500 hover:bg-amber-600 text-white py-2 rounded-lg">دفع ربح اليوم ${user.investmentPlan.currentDay}</button>`;
                }
            }

            const banButtonClass = user.isBanned ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';
            const banButtonText = user.isBanned ? 'إلغاء حظر المستخدم' : 'حظر المستخدم';

            content.innerHTML = `
                <h3 class="text-2xl font-bold">${user.username}</h3>
                <p><strong>البريد:</strong> ${user.email}</p>
                <p><strong>رصيد التداول:</strong> $${user.balance.toFixed(2)}</p>
                <p><strong>رصيد الأرباح:</strong> $${(user.referralBalance || 0).toFixed(2)}</p>
                ${kycActionHtml}
                ${dailyProfitActionHtml}
                ${investmentActionHtml}
                <div class="border-t border-zinc-700 pt-4 mt-4">
                    <button id="toggle-ban-btn" class="w-full btn ${banButtonClass} text-white py-2 rounded-lg">${banButtonText}</button>
                </div>
                <button id="close-user-details-modal" class="w-full mt-4 btn bg-zinc-600 hover:bg-zinc-700 text-white py-2 rounded-lg">إغلاق</button>
            `;
            
            modal.classList.remove('hidden');

            document.getElementById('close-user-details-modal').onclick = () => modal.classList.add('hidden');
            if (document.getElementById('approve-kyc-btn')) {
                document.getElementById('approve-kyc-btn').onclick = () => { approveKyc(userId); modal.classList.add('hidden'); };
            }
            if (document.getElementById('activate-investment-btn')) {
                document.getElementById('activate-investment-btn').onclick = () => {
                    const amount = document.getElementById('investment-plan-select').value;
                    activateInvestmentPlan(userId, parseInt(amount));
                    modal.classList.add('hidden');
                };
            }
            if (document.getElementById('upgrade-investment-btn')) {
                document.getElementById('upgrade-investment-btn').onclick = () => {
                    const amount = document.getElementById('upgrade-plan-select').value;
                    upgradeInvestmentPlan(userId, parseInt(amount));
                    modal.classList.add('hidden');
                };
            }
            if (document.getElementById('approve-profit-btn')) {
                document.getElementById('approve-profit-btn').onclick = () => {
                    approveDailyProfit(userId);
                    modal.classList.add('hidden');
                };
            }
            document.getElementById('toggle-ban-btn').onclick = () => { toggleUserBan(userId, user.isBanned); modal.classList.add('hidden'); };
        }

        async function approveKyc(userId) {
            playSound('click');
            const userDocRef = doc(db, "users", userId);
            
            try {
                const userSnap = await getDoc(userDocRef);
                if (!userSnap.exists()) { throw new Error("User not found"); }
                const userData = userSnap.data();

                const batch = writeBatch(db);
                
                batch.update(userDocRef, {
                    kycVerified: true,
                    kycPending: false
                });

                if (userData.enteredReferralCode) {
                    const q = query(collection(db, "users"), where("referralCode", "==", userData.enteredReferralCode), limit(1));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const referrerDoc = querySnapshot.docs[0];
                        const referrerId = referrerDoc.id;
                        const referrerData = referrerDoc.data();
                        const referrerDocRef = doc(db, "users", referrerId);

                        batch.update(referrerDocRef, {
                            [`referrals.${userId}`]: { username: userData.username, status: 'verified' }
                        });

                        const updatedReferrals = { ...(referrerData.referrals || {}), [userId]: { status: 'verified' } };
                        const verifiedRefs = Object.values(updatedReferrals).filter(ref => ref.status === 'verified');
                        
                        if (verifiedRefs.length >= 3) {
                            const rewardAmount = Math.floor(Math.random() * (5 - 3 + 1)) + 3;
                            batch.update(referrerDocRef, {
                                referralBalance: increment(rewardAmount)
                            });
                            
                            const refsToReward = Object.keys(updatedReferrals).filter(uid => updatedReferrals[uid].status === 'verified').slice(0, 3);
                            refsToReward.forEach(refUid => {
                                batch.update(referrerDocRef, {
                                    [`referrals.${refUid}.status`]: 'rewarded'
                                });
                            });
                        }
                    }
                }
                
                await batch.commit();
                showToast("تم توثيق المستخدم بنجاح!", "success");

            } catch (error) {
                console.error("Error approving KYC: ", error);
                showToast("حدث خطأ أثناء الموافقة.", "error");
            }
        }

        async function activateInvestmentPlan(userId, amount) {
            const dailyProfit = amount * 0.04;
            const planName = `خطة ${amount}$`;
            
            const investmentDays = [];
            for(let i = 0; i < 90; i++) {
                investmentDays.push({
                    tasks: [
                        { description: `شراء أصل بقيمة ${50 + i}`, action: 'buy', amount: 50 + i, completed: false },
                        { description: `بيع أصل بقيمة ${75 + i}`, action: 'sell', amount: 75 + i, completed: false },
                        { description: `شراء أصل بقيمة ${100 + i}`, action: 'buy', amount: 100 + i, completed: false },
                    ],
                    allTasksCompleted: false,
                    completionTimestamp: null,
                    profitPaid: false
                });
            }

            const investmentPlan = {
                active: true,
                planName: planName,
                amount: amount,
                startDate: serverTimestamp(),
                dailyProfit: dailyProfit,
                currentDay: 1,
                days: investmentDays
            };

            try {
                await updateDoc(doc(db, "users", userId), { investmentPlan: investmentPlan });
                showToast(`تم تفعيل ${planName} للمستخدم.`, "success");
            } catch(error) {
                console.error("Error activating plan:", error);
                showToast("فشل تفعيل الخطة.", "error");
            }
        }

        async function upgradeInvestmentPlan(userId, newAmount) {
            const dailyProfit = newAmount * 0.04;
            const planName = `خطة ${newAmount}$`;
            try {
                await updateDoc(doc(db, "users", userId), {
                    'investmentPlan.amount': newAmount,
                    'investmentPlan.planName': planName,
                    'investmentPlan.dailyProfit': dailyProfit,
                });
                showToast(`تمت ترقية خطة المستخدم إلى ${planName}.`, "success");
            } catch (error) {
                console.error("Error upgrading plan:", error);
                showToast("فشل ترقية الخطة.", "error");
            }
        }
        
        async function approveDailyProfit(userId) {
            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) return;
            const userData = userSnap.data();
            const plan = userData.investmentPlan;
            const dayIndex = plan.currentDay - 1;

            if (plan.days[dayIndex].allTasksCompleted && !plan.days[dayIndex].profitPaid) {
                try {
                    const batch = writeBatch(db);
                    batch.update(userRef, {
                        referralBalance: increment(plan.dailyProfit),
                        [`investmentPlan.days.${dayIndex}.profitPaid`]: true
                    });
                    
                    if (plan.currentDay < 90) {
                        batch.update(userRef, {
                            'investmentPlan.currentDay': plan.currentDay + 1
                        });
                    }

                    await batch.commit();
                    showToast(`تم دفع ربح اليوم ${plan.currentDay} للمستخدم.`, "success");
                } catch (error) {
                    console.error("Error approving profit:", error);
                    showToast("فشل دفع الربح.", "error");
                }
            }
        }

        async function toggleUserBan(userId, isCurrentlyBanned) {
            playSound('click');
            await updateDoc(doc(db, "users", userId), { isBanned: !isCurrentlyBanned });
            showToast(`تم ${!isCurrentlyBanned ? 'حظر' : 'تفعيل'} المستخدم.`, "success");
        }
      
        // --- UI ROUTING ---
        function updateUserUI(userData) {
            state = userData;
            if (state.isBanned) {
                document.body.innerHTML = `<div class="h-screen w-full flex items-center justify-center text-2xl font-bold text-red-500">تم حظر حسابك.</div>`;
                handleLogout();
                return;
            }
            usernameDisplayEl.textContent = `مرحباً، ${state.username || 'مستخدم'}`;
            userInfoEl.classList.remove('hidden');

            const currentActiveSection = document.querySelector('.section.active');
            const currentActiveSectionId = currentActiveSection ? currentActiveSection.id : '';
            let targetSectionId = '';

            if(state.investmentPlan?.active) {
                targetSectionId = 'trading-section';
                renderInvestmentDashboard();
            } else if (state.days?.[2]?.allTasksCompleted) {
                targetSectionId = 'investment-section';
                renderInvestmentPlans();
            } else if (state.kycVerified) {
                targetSectionId = 'trading-section';
                renderInitialChallengeDashboard();
            } else if (state.kycPending) {
                targetSectionId = 'kyc-section';
                document.getElementById('kyc-submitted-btn').classList.add('hidden');
                document.getElementById('telegram-link').closest('div').classList.add('hidden');
                document.getElementById('kyc-pending-message').classList.remove('hidden');
            } else {
                targetSectionId = 'welcome-section';
            }

            if (currentActiveSectionId !== targetSectionId) {
                showSection(targetSectionId);
                if (targetSectionId === 'trading-section') initPriceChart();
            }
        }

        function renderInitialChallengeDashboard() {
            document.getElementById('challenge-title').innerText = `اليوم ${state.currentDay}`;
            document.getElementById('account-summary-card').innerHTML = `
                <h3 class="text-lg font-bold mb-2">ملخص الحساب</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-zinc-400">رصيد التداول:</span><span id="balance" class="text-xl font-bold text-purple-400">$${state.balance.toFixed(2)}</span></div>
                    <div class="glowing-divider"></div>
                    <div class="flex justify-between items-center"><span class="text-zinc-400">تقدم التحدي:</span><span class="font-bold">اليوم <span id="current-day">${state.currentDay}</span> / 3</span></div>
                    <div class="w-full bg-zinc-700 rounded-full h-2.5"><div id="days-progress-bar" class="bg-purple-500 h-2.5 rounded-full"></div></div>
                </div>`;
            renderTasks(false);
            const completedDays = state.days.filter(d => d.allTasksCompleted).length;
            document.getElementById('days-progress-bar').style.width = `${(completedDays / 3) * 100}%`;
            checkDayCompletion(false);
        }

        function renderInvestmentDashboard() {
            const plan = state.investmentPlan;
            document.getElementById('challenge-title').innerText = `خطة استثمار - يوم ${plan.currentDay}`;
            document.getElementById('account-summary-card').innerHTML = `
                <h3 class="text-lg font-bold mb-2">ملخص الاستثمار</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-zinc-400">رصيد التداول:</span><span class="text-xl font-bold text-purple-400">$${state.balance.toFixed(2)}</span></div>
                    <div class="flex justify-between items-center"><span class="text-zinc-400">الأرباح الحقيقية:</span><span class="text-xl font-bold text-green-400">$${state.referralBalance.toFixed(2)}</span></div>
                    <div class="glowing-divider"></div>
                    <div class="flex justify-between items-center"><span class="text-zinc-400">تقدم الخطة:</span><span class="font-bold">اليوم <span id="current-day">${plan.currentDay}</span> / 90</span></div>
                    <div class="w-full bg-zinc-700 rounded-full h-2.5"><div id="days-progress-bar" class="bg-cyan-500 h-2.5 rounded-full"></div></div>
                </div>`;
            renderTasks(true);
            document.getElementById('days-progress-bar').style.width = `${(plan.currentDay / 90) * 100}%`;
            checkDayCompletion(true);
        }

        function renderInvestmentPlans() {
            const plans = [
                { amount: 10, daily: 0.40 }, { amount: 20, daily: 0.80 },
                { amount: 50, daily: 2.00 }, { amount: 100, daily: 4.00 },
                { amount: 200, daily: 8.00 }, { amount: 500, daily: 20.00 }
            ];
            const container = document.getElementById('plans-container');
            container.innerHTML = plans.map(plan => `
                <button class="plan-card text-right p-4 rounded-lg cursor-pointer" data-amount="${plan.amount}">
                    <p class="text-2xl font-bold text-purple-400">$${plan.amount}</p>
                    <p class="text-zinc-400">مبلغ الإيداع</p>
                    <div class="glowing-divider my-2"></div>
                    <p class="text-lg font-semibold text-cyan-400">$${plan.daily.toFixed(2)}</p>
                    <p class="text-zinc-400 text-sm">ربح يومي</p>
                </button>
            `).join('');
        }


        // --- MAIN APP LISTENER ---
        onAuthStateChanged(auth, (user) => {
            if (userUnsubscribe) userUnsubscribe();
            if (adminUnsubscribeUsers) adminUnsubscribeUsers();
            if (adminUnsubscribeWithdrawals) adminUnsubscribeWithdrawals();

            if (user) {
                currentUserId = user.uid;
                
                if (user.uid === ADMIN_UID) {
                    mainTitle.innerText = 'لوحة التحكم';
                    showSection('admin-dashboard-section');
                    setupAdminDashboardListeners();
                    userInfoEl.classList.remove('hidden');
                    usernameDisplayEl.textContent = `مرحباً، Admin`;
                    appLoader.classList.remove('active');
                } else {
                    userUnsubscribe = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                        if (docSnap.exists()) {
                            const userData = docSnap.data();
                            updateUserUI(userData);
                        } else {
                            console.log(`User document not found for UID: ${user.uid}. It might be creating.`);
                        }
                        appLoader.classList.remove('active');
                    }, (error) => {
                        console.error("Firestore snapshot error:", error);
                        showToast("لا يمكن الوصول إلى بيانات الحساب.", "error");
                        handleLogout();
                        appLoader.classList.remove('active');
                    });
                }
            } else {
                currentUserId = null; state = {};
                userInfoEl.classList.add('hidden');
                showSection('auth-section');
                appLoader.classList.remove('active');
            }
        });

        // --- GLOBAL EVENT LISTENERS ---
        document.body.addEventListener('click', (e) => { if (audioContext && audioContext.state === 'suspended') audioContext.resume(); });
        logoutBtn.addEventListener('click', handleLogout);
        withdrawalBtn.addEventListener('click', () => { playSound('click'); window.open('https://t.me/kycverifice', '_blank'); });
        referralBtn.addEventListener('click', () => { playSound('click'); renderReferralSection(); showSection('referral-section'); });
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); playSound('click'); document.getElementById('register-form-container').classList.remove('active'); document.getElementById('login-form-container').classList.add('active'); document.getElementById('auth-message').textContent = ''; });
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); playSound('click'); document.getElementById('login-form-container').classList.remove('active'); document.getElementById('register-form-container').classList.add('active'); document.getElementById('auth-message').textContent = ''; });
        document.getElementById('start-challenge-btn').addEventListener('click', () => { playSound('click'); showSection('kyc-section'); });
        document.getElementById('telegram-link').addEventListener('click', () => { playSound('click'); document.getElementById('kyc-submitted-btn').disabled = false; });
        document.getElementById('kyc-submitted-btn').addEventListener('click', handleKycSubmission);
        document.getElementById('buy-btn').addEventListener('click', handleTrade);
        document.getElementById('sell-btn').addEventListener('click', handleTrade);
        document.getElementById('next-day-btn').addEventListener('click', handleNextDay);
        document.getElementById('back-to-trade-from-referral-btn').addEventListener('click', () => { playSound('click'); showSection('trading-section'); });
        document.getElementById('order-book-tab').addEventListener('click', () => { /* tab logic */ });
        document.getElementById('trade-history-tab').addEventListener('click', () => { /* tab logic */ });
        document.getElementById('copy-referral-btn').addEventListener('click', () => {
            playSound('click');
            const referralLinkDisplay = document.getElementById('referral-link-display');
            referralLinkDisplay.select();
            document.execCommand('copy');
            showToast("تم نسخ الرابط بنجاح!", "success");
        });
        document.getElementById('close-reward-modal-btn').addEventListener('click', () => {
            playSound('click');
            document.getElementById('reward-modal').classList.add('hidden');
        });
        document.getElementById('plans-container').addEventListener('click', (e) => {
            const card = e.target.closest('.plan-card');
            if (!card) return;
            playSound('click');
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            const amount = card.dataset.amount;
            document.getElementById('selection-feedback').innerHTML = `<p class="text-green-400 font-bold">لقد اخترت خطة ${amount}$</p>`;
        });
        
        // --- ADMIN LISTENERS ---
        document.getElementById('admin-user-search').addEventListener('input', () => renderUsersTable(allUsersCache));
        document.getElementById('admin-dashboard-section').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('view-user-btn')) showUserDetailsModal(target.dataset.userid);
        });

        // --- PRICE & MARKET SIMULATION ---
        priceInterval = setInterval(() => { 
            const assetPriceEl = document.getElementById('asset-price');
            if(!assetPriceEl) return;
            
            const change = (Math.random() - 0.5) * 100;
            const oldPrice = assetPrice;
            assetPrice += change;
            if (assetPrice > highPrice) highPrice = assetPrice;
            if (assetPrice < lowPrice) lowPrice = assetPrice;
            
            assetPriceEl.innerText = `$${assetPrice.toFixed(2)}`;
            assetPriceEl.parentElement.className = `text-3xl font-bold flex items-center justify-end gap-2 ${assetPrice >= oldPrice ? 'price-up' : 'price-down'}`;
            document.getElementById('asset-price-arrow').innerText = assetPrice >= oldPrice ? '▲' : '▼';

            assetPriceEl.classList.add('flicker');
            setTimeout(()=> assetPriceEl.classList.remove('flicker'), 200);
            
            if (priceChart && priceChart.data.datasets[0].data.length > 0) {
                const candle = { x: Date.now(), o: openPrice, h: highPrice, l: lowPrice, c: assetPrice };
                priceChart.data.datasets[0].data.push(candle);
                if (priceChart.data.datasets[0].data.length > 40) priceChart.data.datasets[0].data.shift();
                priceChart.update('none');
                openPrice = assetPrice; highPrice = assetPrice; lowPrice = assetPrice;
            }
        }, 2000);
        marketActivityInterval = setInterval(updateOrderBook, 3000);
        initNewsTicker();
        handleUrlParams();

    </script>
</body>
</html>
