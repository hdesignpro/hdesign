<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOOSTIFY</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Tajawal for Arabic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Tajawal', sans-serif; scroll-behavior: smooth; }
        
        /* --- 1. Animated Gradient Background --- */
        .gradient-bg { 
            background: linear-gradient(135deg, #1e3a8a, #3b82f6, #2563eb, #60a5fa);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- 2. Card Glow Effect --- */
        .card-hover:hover { 
            transform: translateY(-10px); 
            /* The --glow-color variable is set via JavaScript */
            box-shadow: 0 0 25px 5px var(--glow-color, rgba(59, 130, 246, 0.3)); 
        }

        .modal-overlay, .notification { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-link.active { color: #3b82f6; font-weight: 700; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; color: white; }
        .message-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 1.5rem; }
        .message-bubble.sent { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.5rem; }
        .message-bubble.received { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.5rem; }
        .dark .message-bubble.received { background-color: #374151; color: #f3f4f6; }
        #broadcast-banner { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col min-h-screen">

    <!-- Broadcast Message Banner -->
    <div id="broadcast-banner" class="hidden bg-blue-600 text-white text-center p-3 relative transform -translate-y-full">
        <p id="broadcast-message-text" class="font-semibold"></p>
        <button id="close-broadcast-banner" class="absolute top-1/2 -translate-y-1/2 left-4 text-2xl">&times;</button>
    </div>

    <!-- Full Page Loader -->
    <div id="full-page-loader" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-[100]">
        <i class="fas fa-spinner fa-spin text-blue-500 text-5xl"></i>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center flex-wrap">
            <!-- Logo -->
            <a href="#" id="home-link" class="nav-link active text-3xl font-bold text-blue-600 dark:text-blue-400">
                <i class="fas fa-rocket mr-2"></i>BOOSTIFY
            </a>

            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobile-menu-toggle" class="text-gray-800 dark:text-gray-200 focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>

            <!-- Navigation Links Container -->
            <div id="nav-links-container" class="w-full md:w-auto md:flex md:items-center hidden mt-4 md:mt-0">
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6 md:space-x-reverse space-y-4 md:space-y-0">
                    <!-- Auth buttons -->
                    <div id="auth-links" class="flex flex-col md:flex-row md:items-center md:space-x-4 md:space-x-reverse space-y-2 md:space-y-0">
                        <button id="login-btn" class="hover:text-blue-500 text-right md:text-center p-2">تسجيل الدخول</button>
                        <button id="signup-btn" class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition duration-300">حساب جديد</button>
                    </div>
                    <!-- User profile -->
                    <div id="user-profile" class="hidden items-stretch md:items-center flex-col md:flex-row md:space-x-4 md:space-x-reverse space-y-4 md:space-y-0">
                        <button id="admin-link" class="nav-link hidden hover:text-blue-500 font-semibold text-right md:text-center p-2">لوحة التحكم</button>
                        <button id="tickets-link" class="nav-link hover:text-blue-500 font-semibold text-right md:text-center p-2">الدعم الفني</button>
                        <button id="profile-link" class="nav-link hover:text-blue-500 font-semibold text-right md:text-center p-2">ملفي الشخصي</button>
                        <div class="flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-full justify-between">
                             <span class="font-semibold text-sm" id="wallet-balance">رصيدك: 0.00 د.ج</span>
                             <div class="flex items-center">
                                <i class="fas fa-wallet text-gray-500 ml-2 mr-2"></i>
                                <button id="topup-btn" class="bg-green-500 text-white w-6 h-6 rounded-full hover:bg-green-600 flex items-center justify-center text-sm" title="شحن الرصيد">
                                    <i class="fas fa-plus"></i>
                                 </button>
                             </div>
                        </div>
                        <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 transition duration-300">
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <section class="gradient-bg text-white py-20 md:py-32">
                <div class="container mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight">عزز تواجدك على وسائل التواصل الاجتماعي</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto">نقدم خدمات عالية الجودة لزيادة المتابعين، الإعجابات، والمشاهدات لمساعدتك على النمو والانتشار.</p>
                </div>
            </section>
            
            <section id="services" class="py-20">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">باقات متابعين انستغرام</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="services-grid"></div>
                </div>
            </section>

            <section id="likes-views-services" class="py-20 bg-gray-50 dark:bg-gray-800">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">باقات الإعجابات والمشاهدات</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="likes-views-services-grid"></div>
                </div>
            </section>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page container mx-auto p-6">
            <h1 class="text-3xl font-bold mb-6">ملفي الشخصي</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Account Management -->
                <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">إدارة الحساب</h2>
                    <form id="update-name-form" class="space-y-4">
                        <div>
                            <label for="profile-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label>
                            <input type="email" id="profile-email" class="w-full p-3 bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label for="profile-name" class="block mb-2 text-sm font-medium">الاسم الكامل</label>
                            <input type="text" id="profile-name" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required>
                        </div>
                        <p id="update-name-error" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">تحديث الاسم</button>
                    </form>
                    <hr class="my-6 border-gray-200 dark:border-gray-700">
                    <form id="update-password-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">تغيير كلمة المرور</h3>
                        <div>
                            <label for="profile-new-password" class="block mb-2 text-sm font-medium">كلمة المرور الجديدة</label>
                            <input type="password" id="profile-new-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required>
                        </div>
                         <div>
                            <label for="profile-confirm-password" class="block mb-2 text-sm font-medium">تأكيد كلمة المرور</label>
                            <input type="password" id="profile-confirm-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required>
                        </div>
                        <p id="update-password-error" class="text-red-500 text-sm hidden"></p>
                        <button type="submit" class="w-full bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition duration-300 disabled:opacity-50">تغيير كلمة المرور</button>
                    </form>
                </div>

                <!-- History Section -->
                <div class="lg:col-span-2 grid grid-cols-1 gap-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">سجل طلبات الشحن</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">المبلغ</th><th class="px-4 py-3">الحالة</th><th class="px-4 py-3">التاريخ</th></tr></thead>
                                <tbody id="user-requests-table">
                                    <tr><td colspan="3" class="text-center p-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">سجل طلبات الخدمات</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">الخدمة</th><th class="px-4 py-3">الحالة</th><th class="px-4 py-3">التاريخ</th><th class="px-4 py-3">إجراء</th></tr></thead>
                                <tbody id="user-orders-table">
                                    <tr><td colspan="4" class="text-center p-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets Page (User) -->
        <div id="tickets-page" class="page container mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">تذاكر الدعم الفني</h1>
                <button id="open-new-ticket-modal-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-plus mr-2"></i>فتح تذكرة جديدة
                </button>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th class="px-4 py-3">الموضوع</th>
                                <th class="px-4 py-3">الحالة</th>
                                <th class="px-4 py-3">آخر تحديث</th>
                                <th class="px-4 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="user-tickets-table">
                            <tr><td colspan="4" class="text-center p-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page container mx-auto p-6">
            <h1 class="text-3xl font-bold mb-6">لوحة تحكم المدير</h1>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4 space-x-reverse">
                    <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full"><i class="fas fa-wallet text-3xl text-blue-500"></i></div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-400">إجمالي الإيرادات</p>
                        <p id="stats-total-revenue" class="text-2xl font-bold">0 د.ج</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4 space-x-reverse">
                    <div class="bg-green-100 dark:bg-green-900 p-4 rounded-full"><i class="fas fa-users text-3xl text-green-500"></i></div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-400">إجمالي المستخدمين</p>
                        <p id="stats-total-users" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4 space-x-reverse">
                    <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-full"><i class="fas fa-shopping-cart text-3xl text-purple-500"></i></div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-400">إجمالي الطلبات</p>
                        <p id="stats-total-orders" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4 space-x-reverse">
                    <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-full"><i class="fas fa-hourglass-half text-3xl text-yellow-500"></i></div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-400">الطلبات المعلقة</p>
                        <p id="stats-pending-orders" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>

            <!-- Management Tabs -->
            <div class="mb-8">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-8 space-x-reverse" aria-label="Tabs">
                        <button id="admin-tab-orders" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">إدارة الطلبات</button>
                        <button id="admin-tab-users" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300">إدارة المستخدمين</button>
                        <button id="admin-tab-tickets" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300">تذاكر الدعم</button>
                        <button id="admin-tab-refills" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300">إعادة التعبئة</button>
                        <button id="admin-tab-broadcast" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300">الرسائل الجماعية</button>
                        <button id="admin-tab-settings" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300">الإعدادات</button>
                    </nav>
                </div>
            </div>

            <!-- Orders Management Panel -->
            <div id="admin-panel-orders" class="admin-panel active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">طلبات الشحن المعلقة</h2>
                            <input type="text" id="search-requests" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث بالبريد الإلكتروني...">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">البريد الإلكتروني</th><th class="px-4 py-3">المبلغ</th><th class="px-4 py-3">التواصل</th><th class="px-4 py-3">إجراء</th></tr></thead>
                                <tbody id="admin-requests-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">طلبات الخدمات النشطة</h2>
                            <input type="text" id="search-orders" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث بالبريد الإلكتروني...">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">البريد</th><th class="px-4 py-3">الخدمة</th><th class="px-4 py-3">الرابط</th><th class="px-4 py-3">تغيير الحالة</th></tr></thead>
                                <tbody id="admin-orders-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Management Panel -->
            <div id="admin-panel-users" class="admin-panel hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">قائمة المستخدمين</h2>
                        <input type="text" id="search-users" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث بالبريد الإلكتروني...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th class="px-4 py-3">البريد الإلكتروني</th>
                                    <th class="px-4 py-3">الاسم</th>
                                    <th class="px-4 py-3">الرصيد</th>
                                    <th class="px-4 py-3">الحالة</th>
                                    <th class="px-4 py-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

             <!-- Tickets Management Panel -->
            <div id="admin-panel-tickets" class="admin-panel hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">جميع تذاكر الدعم</h2>
                        <input type="text" id="search-tickets" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث ببريد المستخدم...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th class="px-4 py-3">المستخدم</th>
                                    <th class="px-4 py-3">الموضوع</th>
                                    <th class="px-4 py-3">الحالة</th>
                                    <th class="px-4 py-3">آخر تحديث</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="admin-tickets-table">
                                <tr><td colspan="5" class="text-center p-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Refills Management Panel -->
            <div id="admin-panel-refills" class="admin-panel hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">طلبات إعادة التعبئة المعلقة</h2>
                        <input type="text" id="search-refills" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث ببريد المستخدم...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th class="px-4 py-3">المستخدم</th>
                                    <th class="px-4 py-3">الخدمة</th>
                                    <th class="px-4 py-3">الرابط</th>
                                    <th class="px-4 py-3">تاريخ الطلب</th>
                                    <th class="px-4 py-3">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="admin-refills-table">
                                <tr><td colspan="5" class="text-center p-8"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Broadcast Management Panel -->
            <div id="admin-panel-broadcast" class="admin-panel hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">إرسال رسالة جماعية</h2>
                    <form id="broadcast-form" class="space-y-4">
                        <div>
                            <label for="broadcast-message-input" class="block mb-2 text-sm font-medium">نص الرسالة</label>
                            <textarea id="broadcast-message-input" rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="مثال: عرض خاص على جميع الخدمات لمدة 24 ساعة!" required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300">إرسال الرسالة</button>
                    </form>
                    <hr class="my-6 border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold mb-4">الرسالة النشطة حالياً</h2>
                    <div id="current-broadcast-container" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <p id="current-broadcast-text" class="text-gray-500 dark:text-gray-400">لا توجد رسالة نشطة حالياً.</p>
                        <button id="delete-broadcast-btn" class="hidden mt-4 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">حذف الرسالة</button>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="admin-panel-settings" class="admin-panel hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">إعدادات خطيرة</h2>
                    <div class="border-2 border-red-500 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-red-600 dark:text-red-400">إعادة تعيين بيانات الطلبات والإيرادات</h3>
                        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                            تحذير: هذا الإجراء سيقوم بحذف جميع سجلات الطلبات، طلبات الشحن، وطلبات إعادة التعبئة بشكل نهائي. سيؤدي هذا إلى تصفير عدادات "إجمالي الإيرادات" و "إجمالي الطلبات". لا يمكن التراجع عن هذا الإجراء.
                        </p>
                        <button id="reset-stats-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">
                            إعادة التعيين الآن
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white dark:bg-gray-900 mt-auto">
        <div class="container mx-auto px-6 py-8">
            <div class="flex flex-col items-center text-center">
                <a href="#" class="text-2xl font-bold text-white hover:text-gray-300">BOOSTIFY</a>
                <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6 sm:space-x-reverse mt-4">
                    <div class="flex items-center">
                        <i class="fas fa-phone ml-2"></i>
                        <span>0799016419</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-envelope ml-2"></i>
                        <span>support@hdesign.pro</span>
                    </div>
                </div>
                <p class="mt-8 text-sm text-gray-400">&copy; 2025 BOOSTIFY. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>


    <!-- Modals -->
    <div id="auth-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">مرحباً بك</h2><button id="close-auth-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><div class="flex border-b border-gray-200 dark:border-gray-700 mb-6"><button id="login-tab" class="py-2 px-4 border-b-2 tab-active w-1/2 text-center font-semibold">تسجيل الدخول</button><button id="signup-tab" class="py-2 px-4 border-b-2 border-transparent w-1/2 text-center font-semibold text-gray-500">حساب جديد</button></div><form id="login-form" class="space-y-4"><div><label for="login-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="login-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><div><label for="login-password" class="block mb-2 text-sm font-medium">كلمة المرور</label><input type="password" id="login-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><div class="text-sm text-left"><a href="#" id="forgot-password-link" class="font-medium text-blue-600 hover:underline dark:text-blue-500">نسيت كلمة المرور؟</a></div><p id="login-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">دخول</button></form><form id="signup-form" class="space-y-4 hidden"><div><label for="signup-name" class="block mb-2 text-sm font-medium">الاسم الكامل</label><input type="text" id="signup-name" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><div><label for="signup-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="signup-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><div><label for="signup-password" class="block mb-2 text-sm font-medium">كلمة المرور</label><input type="password" id="signup-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><p id="signup-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إنشاء حساب</button></form></div></div></div>
    <div id="topup-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">طلب شحن الرصيد</h2><button id="close-topup-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">أدخل المبلغ المطلوب ومعلومات التواصل. سنتواصل معك لإتمام عملية الدفع وتأكيد شحن الرصيد.</p><form id="topup-form" class="space-y-4"><div><label for="topup-amount" class="block mb-2 text-sm font-medium">المبلغ (بالدينار الجزائري)</label><input type="number" id="topup-amount" min="1" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="مثال: 1000" required></div><div><label for="contact-info" class="block mb-2 text-sm font-medium">معلومات التواصل (واتساب، تيليجرام، الخ)</label><input type="text" id="contact-info" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="مثال: 9665xxxxxxx+" required></div><p id="topup-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-300 disabled:opacity-50">إرسال الطلب</button></form></div></div></div>
    <div id="order-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">تأكيد الطلب</h2><button id="close-order-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><div id="order-details" class="mb-4"></div><form id="order-form" class="space-y-4"><div><label for="service-link" class="block mb-2 text-sm font-medium">رابط الحساب أو المنشور</label><input type="url" id="service-link" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="https://..." required></div><div id="drip-feed-container" class="hidden space-y-4 pt-4 border-t dark:border-gray-700"><div class="flex items-center"><input id="drip-feed-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="drip-feed-checkbox" class="ml-2 mr-2 block text-sm font-medium">تفعيل التزويد التدريجي (Drip-Feed)</label></div><div id="drip-feed-options" class="hidden space-y-4"><div><label for="drip-feed-quantity" class="block mb-2 text-sm font-medium">الكمية في كل مرة</label><input type="number" id="drip-feed-quantity" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="مثال: 100"></div><div><label for="drip-feed-interval" class="block mb-2 text-sm font-medium">الفاصل الزمني (بالدقائق)</label><input type="number" id="drip-feed-interval" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="مثال: 60"></div><div><p class="text-sm">إجمالي الدفعات: <span id="drip-feed-runs" class="font-bold">0</span></p></div></div></div><p id="order-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">تأكيد وشراء</button></form></div></div></div>
    <div id="reset-password-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">إعادة تعيين كلمة المرور</h2><button id="close-reset-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">أدخل بريدك الإلكتروني المسجل وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.</p><form id="reset-password-form" class="space-y-4"><div><label for="reset-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="reset-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><p id="reset-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إرسال الرابط</button></form></div></div></div>
    <div id="adjust-balance-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">تعديل الرصيد</h2><button id="close-adjust-balance-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p id="adjust-balance-user-email" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p><form id="adjust-balance-form" class="space-y-4"><div><label for="adjust-balance-amount" class="block mb-2 text-sm font-medium">المبلغ المراد إضافته أو خصمه</label><input type="number" id="adjust-balance-amount" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="استخدم - للخصم (مثال: -50)" required></div><p id="adjust-balance-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">تأكيد التعديل</button></form></div></div></div>
    <div id="new-ticket-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">فتح تذكرة دعم جديدة</h2><button id="close-new-ticket-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><form id="new-ticket-form" class="space-y-4"><div><label for="ticket-subject" class="block mb-2 text-sm font-medium">الموضوع</label><input type="text" id="ticket-subject" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></div><div><label for="ticket-message" class="block mb-2 text-sm font-medium">الرسالة</label><textarea id="ticket-message" rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" required></textarea></div><p id="new-ticket-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إرسال التذكرة</button></form></div></div></div>
    <div id="view-ticket-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-2xl mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full flex flex-col h-[90vh]"><div class="p-6 flex-shrink-0 border-b dark:border-gray-700"><div class="flex justify-between items-center"><div class="space-y-1"><h2 id="view-ticket-subject" class="text-2xl font-bold"></h2><p id="view-ticket-user" class="text-sm text-gray-500"></p></div><button id="close-view-ticket-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><div id="admin-ticket-actions" class="mt-4 hidden"><label for="ticket-status-select" class="text-sm font-medium">تغيير الحالة:</label><select id="ticket-status-select" class="ml-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-xs p-1"></select></div></div><div id="ticket-messages-container" class="flex-grow p-6 overflow-y-auto space-y-4"></div><div class="p-6 flex-shrink-0 border-t dark:border-gray-700"><form id="reply-ticket-form" class="flex items-center space-x-2 space-x-reverse"><input type="text" id="reply-message-input" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-white" placeholder="اكتب ردك هنا..." required><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إرسال</button></form></div></div></div>
    <div id="reset-stats-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-red-600">تأكيد إعادة التعيين</h2><button id="close-reset-stats-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">هل أنت متأكد من أنك تريد حذف جميع بيانات الطلبات والإيرادات بشكل نهائي؟ لا يمكن التراجع عن هذا الإجراء.</p><div class="flex justify-end space-x-4 space-x-reverse mt-6"><button id="cancel-reset-stats-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">إلغاء</button><button id="confirm-reset-stats-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">نعم، قم بإعادة التعيين</button></div></div></div></div>

    <!-- Success Notification -->
    <div id="success-notification" class="notification fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-full opacity-0"><i class="fas fa-check-circle mr-2"></i><span id="notification-message"></span></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, updateDoc, increment, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // **مهم:** الصق إعدادات Firebase الخاصة بك هنا
        const firebaseConfig = {
            apiKey: "AIzaSyBlmRUBMkPZAwRKcESiyTsBD9XAN_eukwM",
            authDomain: "hdesign-4c4e4.firebaseapp.com",
            projectId: "hdesign-4c4e4",
            storageBucket: "hdesign-4c4e4.appspot.com",
            messagingSenderId: "518290616043",
            appId: "1:518290616043:web:1627ed9072bcc27b7498ae",
            measurementId: "G-B5G6TX2DDJ"
        };
        const ADMIN_UID = "2bZAxqRdQWYyNFdBeO6Wr5FiiyU2"; 

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId; // Use projectId from your config

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const notification = document.getElementById('success-notification');
        const notificationMessage = document.getElementById('notification-message');
        const fullPageLoader = document.getElementById('full-page-loader');
        const profileEmailInput = document.getElementById('profile-email');
        const profileNameInput = document.getElementById('profile-name');
        const statsTotalRevenueEl = document.getElementById('stats-total-revenue');
        const statsTotalUsersEl = document.getElementById('stats-total-users');
        const statsTotalOrdersEl = document.getElementById('stats-total-orders');
        const statsPendingOrdersEl = document.getElementById('stats-pending-orders');
        const adjustBalanceModal = document.getElementById('adjust-balance-modal');
        const adjustBalanceForm = document.getElementById('adjust-balance-form');
        const adjustBalanceUserEmailEl = document.getElementById('adjust-balance-user-email');
        const newTicketModal = document.getElementById('new-ticket-modal');
        const viewTicketModal = document.getElementById('view-ticket-modal');
        const broadcastBanner = document.getElementById('broadcast-banner');
        const resetStatsModal = document.getElementById('reset-stats-modal');

        // --- STATE ---
        let currentUserData = null;
        const allServicesData = [
            // Followers
            { id: 'insta1k', type: 'followers', name: 'باقة 1,000 متابع', price: 650, icon: 'fab fa-instagram', color: 'text-pink-500', features: ['متابعين بجودة عالية', 'ضمان تعويض النقص 30 يوم', 'تنفيذ سريع خلال 24 ساعة'], refillable: true, dripFeedEnabled: true, quantity: 1000 },
            { id: 'insta5k', type: 'followers', name: 'باقة 5,000 متابع', price: 2000, icon: 'fab fa-instagram', color: 'text-pink-500', features: ['متابعين بجودة عالية', 'ضمان تعويض النقص 30 يوم', 'تنفيذ سريع خلال 24 ساعة'], refillable: true, dripFeedEnabled: true, quantity: 5000 },
            { id: 'insta10k', type: 'followers', name: 'باقة 10,000 متابع', price: 3700, icon: 'fab fa-instagram', color: 'text-pink-500', popular: true, features: ['متابعين بجودة عالية وحقيقيين', 'ضمان تعويض النقص 30 يوم', 'تنفيذ فوري', '+250 لايك هدية'], refillable: true, dripFeedEnabled: true, quantity: 10000 },
            { id: 'insta20k', type: 'followers', name: 'باقة 20,000 متابع', price: 7000, icon: 'fab fa-instagram', color: 'text-pink-500', features: ['متابعين بجودة عالية وحقيقيين', 'ضمان تعويض النقص 30 يوم', 'تنفيذ فوري', '+500 لايك هدية'], refillable: true, dripFeedEnabled: true, quantity: 20000 },
            { id: 'insta50k', type: 'followers', name: 'باقة 50,000 متابع', price: 15000, icon: 'fab fa-instagram', color: 'text-pink-500', features: ['متابعين VIP جودة ممتازة', 'ضمان تعويض النقص 30 يوم', 'تنفيذ فوري', '+1000 لايك هدية'], refillable: true, dripFeedEnabled: true, quantity: 50000 },
            // Likes & Views
            { id: 'lv10k10k', type: 'likes-views', name: '10 آلاف إعجاب + 10 آلاف مشاهدة', price: 1000, icon: 'fas fa-heart', color: 'text-red-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'lv10k20k', type: 'likes-views', name: '10 آلاف إعجاب + 20 ألف مشاهدة', price: 1400, icon: 'fas fa-heart', color: 'text-red-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'lv20k20k', type: 'likes-views', name: '20 ألف إعجاب + 20 ألف مشاهدة', price: 1900, icon: 'fas fa-heart', color: 'text-red-500', popular: true, features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'lv20k30k', type: 'likes-views', name: '20 ألف إعجاب + 30 ألف مشاهدة', price: 2400, icon: 'fas fa-heart', color: 'text-red-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'lv50k100k', type: 'likes-views', name: '50 ألف إعجاب + 100 ألف مشاهدة', price: 7500, icon: 'fas fa-heart', color: 'text-red-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'l10k', type: 'likes-views', name: '10 آلاف إعجاب', price: 500, icon: 'fas fa-thumbs-up', color: 'text-blue-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] },
            { id: 'v10k', type: 'likes-views', name: '10 آلاف مشاهدة', price: 500, icon: 'fas fa-eye', color: 'text-purple-500', features: ['جودة عالية', 'تنفيذ فوري', 'آمن 100%'] }
        ];
        const orderStatuses = {
            pending: { text: 'معلق', color: 'bg-yellow-500' },
            processing: { text: 'قيد التنفيذ', color: 'bg-blue-500' },
            partial: { text: 'مكتمل جزئياً', color: 'bg-orange-500' },
            completed: { text: 'مكتمل', color: 'bg-green-500' },
            canceled: { text: 'ملغي', color: 'bg-red-500' }
        };
        const ticketStatuses = {
            open: { text: 'مفتوحة', color: 'bg-green-500' },
            answered: { text: 'تم الرد', color: 'bg-blue-500' },
            closed: { text: 'مغلقة', color: 'bg-gray-500' }
        };
        let allAdminRequests = [];
        let allAdminOrders = [];
        let allAdminUsers = [];
        let allAdminTickets = [];
        let allAdminRefills = [];
        let currentTicketListener = null;

        // --- RENDER FUNCTIONS ---
        const renderServices = () => {
            const followersGrid = document.getElementById('services-grid');
            const likesViewsGrid = document.getElementById('likes-views-services-grid');
            const followersServices = allServicesData.filter(s => s.type === 'followers');
            const likesViewsServices = allServicesData.filter(s => s.type === 'likes-views');
            const createCardHTML = (service) => {
                const colorMap = {
                    'text-pink-500': 'rgba(236, 72, 153, 0.3)',
                    'text-red-500': 'rgba(239, 68, 68, 0.3)',
                    'text-blue-500': 'rgba(59, 130, 246, 0.3)',
                    'text-purple-500': 'rgba(139, 92, 246, 0.3)',
                };
                const glowColor = colorMap[service.color] || 'rgba(59, 130, 246, 0.3)';

                return `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center transition duration-300 card-hover flex flex-col ${service.popular ? 'border-4 border-blue-500' : ''} relative" style="--glow-color: ${glowColor};">
                    ${service.popular ? `<span class="absolute top-0 right-1/2 transform translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full">${service.type === 'followers' ? 'الأكثر مبيعاً' : 'عرض خاص'}</span>` : ''}
                    <div class="flex-grow">
                        <i class="${service.icon} ${service.color} text-5xl mb-6"></i>
                        <h3 class="text-2xl font-bold mb-4">${service.name}</h3>
                        <p class="text-4xl font-extrabold mb-4">${service.price}<span class="text-lg font-normal text-gray-500 dark:text-gray-400"> د.ج</span></p>
                        <ul class="text-gray-600 dark:text-gray-400 mb-6 space-y-2 text-right">
                            ${service.features.map(feature => `<li class="flex items-center justify-end"><span class="mr-2">${feature}</span><i class="fas fa-check-circle text-green-500"></i></li>`).join('')}
                        </ul>
                    </div>
                    <button data-service-id="${service.id}" class="order-btn w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700 transition duration-300 mt-auto">اطلب الآن</button>
                </div>
            `;
            }
            if (followersGrid) followersGrid.innerHTML = followersServices.map(createCardHTML).join('');
            if (likesViewsGrid) likesViewsGrid.innerHTML = likesViewsServices.map(createCardHTML).join('');
        };

        // --- UI & NAVIGATION ---
        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[id$="${pageId.replace('-page', '-link')}"]`)?.classList.add('active');
            
            // **BUG FIX:** Dynamically update the page title
            const pageTitles = {
                'home-page': 'BOOSTIFY | الرئيسية',
                'profile-page': 'BOOSTIFY | ملفي الشخصي',
                'tickets-page': 'BOOSTIFY | الدعم الفني',
                'admin-page': 'BOOSTIFY | لوحة التحكم'
            };
            document.title = pageTitles[pageId] || 'BOOSTIFY';

            window.scrollTo(0, 0);
        };
        
        const setupNavigationAndMenu = () => {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const navLinksContainer = document.getElementById('nav-links-container');
            const toggleIcon = mobileMenuToggle.querySelector('i');

            const closeMobileMenu = () => {
                if (window.innerWidth < 768) { 
                    navLinksContainer.classList.add('hidden');
                    toggleIcon.classList.replace('fa-times', 'fa-bars');
                }
            };

            mobileMenuToggle.addEventListener('click', () => {
                navLinksContainer.classList.toggle('hidden');
                toggleIcon.classList.toggle('fa-bars', navLinksContainer.classList.contains('hidden'));
                toggleIcon.classList.toggle('fa-times', !navLinksContainer.classList.contains('hidden'));
            });

            const handleNavClick = (e) => {
                const target = e.target.closest('button, a');
                if (!target) return;

                let shouldCloseMenu = true;

                switch(target.id) {
                    case 'home-link': e.preventDefault(); showPage('home-page'); break;
                    case 'profile-link': e.preventDefault(); showPage('profile-page'); break;
                    case 'admin-link': e.preventDefault(); showPage('admin-page'); break;
                    case 'tickets-link': e.preventDefault(); showPage('tickets-page'); break;
                    case 'logout-btn': signOut(auth); break;
                    case 'login-btn': case 'signup-btn': case 'topup-btn': break; 
                    default: shouldCloseMenu = false;
                }
                
                if (shouldCloseMenu) closeMobileMenu();
            };
            
            navLinksContainer.addEventListener('click', handleNavClick);
            document.getElementById('home-link').addEventListener('click', handleNavClick);
        };

        const openModal = (modal) => {
            if (!modal) return;
            const container = modal.querySelector('.modal-container');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                container?.classList.remove('-translate-y-full');
            }, 10);
        };

        const closeModal = (modal) => {
            if (!modal) return;
            const container = modal.querySelector('.modal-container');
            modal.classList.add('opacity-0');
            container?.classList.add('-translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
                // Detach listener if it's the view ticket modal
                if (modal.id === 'view-ticket-modal' && currentTicketListener) {
                    currentTicketListener(); // This is the unsubscribe function
                    currentTicketListener = null;
                }
            }, 300);
        };

        const showNotification = (message, isError = false) => {
            if (!notificationMessage || !notification) return;
            notificationMessage.textContent = message;
            notification.classList.toggle('bg-green-500', !isError);
            notification.classList.toggle('bg-red-500', isError);
            notification.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        };

        // --- Firebase & App Logic ---
        let unsubscribeListeners = [];
        const cleanupListeners = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
             if (currentTicketListener) {
                currentTicketListener();
                currentTicketListener = null;
            }
        };
        
        onAuthStateChanged(auth, (user) => {
            cleanupListeners();
            const authLinks = document.getElementById('auth-links');
            const userProfile = document.getElementById('user-profile');

            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const unsubUser = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = { id: docSnap.id, ...docSnap.data() };
                        
                        if (currentUserData.status === 'banned') {
                            showNotification("تم تعليق حسابك. يرجى التواصل مع الإدارة.", true);
                            signOut(auth);
                            return;
                        }

                        document.getElementById('wallet-balance').textContent = `رصيدك: ${currentUserData.wallet.toFixed(2)} د.ج`;
                        profileEmailInput.value = currentUserData.email;
                        profileNameInput.value = currentUserData.name;
                    } else {
                        signOut(auth);
                    }
                });
                
                const broadcastRef = doc(db, `artifacts/${appId}/broadcast/current_message`);
                const unsubBroadcast = onSnapshot(broadcastRef, (docSnap) => {
                    const banner = document.getElementById('broadcast-banner');
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const messageId = `broadcast_${data.createdAt.seconds}`;
                        if (localStorage.getItem(messageId) !== 'dismissed') {
                            document.getElementById('broadcast-message-text').textContent = data.message;
                            banner.dataset.messageId = messageId;
                            banner.classList.remove('hidden');
                            setTimeout(() => banner.classList.remove('-translate-y-full'), 10);
                        }
                    } else {
                        banner.classList.add('-translate-y-full');
                        setTimeout(() => banner.classList.add('hidden'), 300);
                    }
                });

                unsubscribeListeners.push(unsubUser, unsubBroadcast);
                
                authLinks.classList.add('hidden');
                userProfile.classList.remove('hidden'); userProfile.classList.add('flex');
                
                document.getElementById('admin-link').classList.toggle('hidden', user.uid !== ADMIN_UID);
                if (user.uid === ADMIN_UID) {
                    loadAdminData();
                }
                
                loadUserData(user.uid);
                closeModal(authModal);
            } else {
                currentUserData = null;
                authLinks.classList.remove('hidden'); authLinks.classList.add('flex');
                userProfile.classList.add('hidden'); userProfile.classList.remove('flex');
                showPage('home-page');
            }
            fullPageLoader.classList.add('hidden');
        });

        const getStatusBadge = (statusKey, statuses) => {
            const statusInfo = statuses[statusKey] || { text: statusKey, color: 'bg-gray-500' };
            return `<span class="status-badge ${statusInfo.color}">${statusInfo.text}</span>`;
        };

        const loadUserData = (userId) => {
            const requestsQuery = query(collection(db, `artifacts/${appId}/requests`), where("userId", "==", userId));
            const ordersQuery = query(collection(db, `artifacts/${appId}/orders`), where("userId", "==", userId));
            const ticketsQuery = query(collection(db, `artifacts/${appId}/tickets`), where("userId", "==", userId));
            
            const unsubRequests = onSnapshot(requestsQuery, (snapshot) => {
                const table = document.getElementById('user-requests-table');
                let docs = snapshot.docs.map(doc => doc.data()).sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                if (docs.length === 0) {
                    table.innerHTML = `<tr><td colspan="3" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد طلبات شحن</h3><p class="text-sm text-gray-500">ابدأ بشحن رصيدك لطلب الخدمات.</p></div></td></tr>`;
                    return;
                }
                table.innerHTML = docs.map(data => {
                    const statusText = data.status === 'pending' ? 'قيد الانتظار' : (data.status === 'confirmed' ? 'مؤكد' : data.status);
                    return `<tr><td class="px-4 py-2">${data.amount} د.ج</td><td class="px-4 py-2">${statusText}</td><td class="px-4 py-2">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</td></tr>`;
                }).join('');
            });

            const unsubOrders = onSnapshot(ordersQuery, (snapshot) => {
                const table = document.getElementById('user-orders-table');
                let docs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                if (docs.length === 0) {
                    table.innerHTML = `<tr><td colspan="4" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-rocket text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لم تقم بأي طلب بعد</h3><p class="text-sm text-gray-500">تصفح خدماتنا وابدأ رحلتك نحو النمو!</p></div></td></tr>`;
                    return;
                }
                table.innerHTML = docs.map(data => {
                    const serviceInfo = allServicesData.find(s => s.id === data.serviceId);
                    let actionHtml = '<td></td>'; // Empty cell by default
                    if (serviceInfo && serviceInfo.refillable && data.status === 'completed') {
                        const twentyFourHours = 24 * 60 * 60 * 1000;
                        const now = new Date();
                        const lastRefill = data.lastRefillRequestAt ? data.lastRefillRequestAt.toDate() : null;
                        let buttonDisabled = false;
                        let buttonText = 'طلب إعادة تعبئة';

                        if (lastRefill && (now - lastRefill < twentyFourHours)) {
                            buttonDisabled = true;
                            const remainingTime = twentyFourHours - (now - lastRefill);
                            const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                            const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                            buttonText = `انتظر ${hours} س و ${minutes} د`;
                        }
                        
                        actionHtml = `
                            <td class="px-4 py-2">
                                <button data-order-id="${data.id}" class="refill-btn bg-orange-500 text-white px-2 py-1 rounded text-xs ${buttonDisabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-orange-600'}" ${buttonDisabled ? 'disabled' : ''}>
                                    ${buttonText}
                                </button>
                            </td>`;
                    }
                    
                    let statusText = getStatusBadge(data.status, orderStatuses);
                    if (data.isDripFeed && data.status === 'processing') {
                        statusText += ` <span class="text-xs">(${data.dripFeedRunsCompleted || 0}/${data.dripFeedTotalRuns})</span>`;
                    }


                    return `<tr>
                        <td class="px-4 py-2">${data.serviceName}</td>
                        <td class="px-4 py-2">${statusText}</td>
                        <td class="px-4 py-2">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</td>
                        ${actionHtml}
                    </tr>`;
                }).join('');
            });

            const unsubTickets = onSnapshot(ticketsQuery, (snapshot) => {
                const table = document.getElementById('user-tickets-table');
                let docs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a, b) => b.lastUpdatedAt.seconds - a.lastUpdatedAt.seconds);
                if (docs.length === 0) {
                    table.innerHTML = `<tr><td colspan="4" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-life-ring text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد تذاكر دعم</h3><p class="text-sm text-gray-500">إذا واجهت مشكلة، لا تتردد في فتح تذكرة جديدة.</p></div></td></tr>`;
                    return;
                }
                table.innerHTML = docs.map(data => `<tr>
                    <td class="px-4 py-2 font-semibold">${data.subject}</td>
                    <td class="px-4 py-2">${getStatusBadge(data.status, ticketStatuses)}</td>
                    <td class="px-4 py-2">${new Date(data.lastUpdatedAt?.seconds * 1000).toLocaleString()}</td>
                    <td class="px-4 py-2"><button data-ticket-id="${data.id}" class="view-ticket-btn text-blue-500 hover:underline">عرض</button></td>
                </tr>`).join('');
            });

            unsubscribeListeners.push(unsubRequests, unsubOrders, unsubTickets);
        };

        const renderAdminRequests = (requests) => {
            const table = document.getElementById('admin-requests-table');
            if (requests.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-check-circle text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد طلبات شحن معلقة</h3><p class="text-sm text-gray-500">كل شيء على ما يرام!</p></div></td></tr>`;
            } else {
                table.innerHTML = requests.map(req => `<tr>
                    <td class="px-4 py-2">${req.userEmail}</td>
                    <td class="px-4 py-2">${req.amount} د.ج</td>
                    <td class="px-4 py-2">${req.contactInfo}</td>
                    <td class="px-4 py-2"><button data-req-id="${req.id}" data-user-id="${req.userId}" data-amount="${req.amount}" class="confirm-topup-btn bg-green-500 text-white px-2 py-1 rounded text-xs">تأكيد</button></td>
                </tr>`).join('');
            }
        };

        const renderAdminOrders = (orders) => {
            const table = document.getElementById('admin-orders-table');
            if (orders.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-check-circle text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد طلبات نشطة</h3><p class="text-sm text-gray-500">كل شيء على ما يرام!</p></div></td></tr>`;
            } else {
                table.innerHTML = orders.map(order => {
                    let serviceDetails = order.serviceName;
                    let dripFeedControls = '';
                    if(order.isDripFeed) {
                        const runsCompleted = order.dripFeedRunsCompleted || 0;
                        serviceDetails += `<br><span class="text-xs text-blue-400">تزويد تدريجي: ${order.dripFeedQuantityPerRun} كل ${order.dripFeedInterval} دقيقة (${runsCompleted}/${order.dripFeedTotalRuns} دفعات)</span>`;
                        
                        if (runsCompleted < order.dripFeedTotalRuns) {
                            dripFeedControls = `
                                <button data-order-id="${order.id}" class="increment-drip-feed-btn bg-green-500 text-white p-1 rounded text-xs" title="إضافة دفعة">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `;
                        }
                    }

                    return `<tr>
                        <td class="px-4 py-2 text-xs">${order.userEmail}</td>
                        <td class="px-4 py-2">${serviceDetails}</td>
                        <td class="px-4 py-2"><a href="${order.link}" target="_blank" class="text-blue-400 hover:underline">الرابط</a></td>
                        <td class="px-4 py-2 flex items-center space-x-2 space-x-reverse">
                            <select data-order-id="${order.id}" class="admin-order-status-select bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-xs p-1">
                                ${Object.keys(orderStatuses).map(key => `<option value="${key}" ${order.status === key ? 'selected' : ''}>${orderStatuses[key].text}</option>`).join('')}
                            </select>
                            <button data-order-id="${order.id}" class="update-order-status-btn bg-blue-500 text-white p-1 rounded text-xs"><i class="fas fa-save"></i></button>
                            ${dripFeedControls}
                        </td>
                    </tr>`;
                }).join('');
            }
        };

        const renderAdminUsers = (users) => {
            const table = document.getElementById('admin-users-table');
            if (users.length === 0) {
                table.innerHTML = `<tr><td colspan="5" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-user-plus text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا يوجد مستخدمون بعد</h3><p class="text-sm text-gray-500">في انتظار أول مستخدم يسجل في الموقع.</p></div></td></tr>`;
            } else {
                table.innerHTML = users.map(user => {
                    const isBanned = user.status === 'banned';
                    return `<tr>
                        <td class="px-4 py-2 text-sm">${user.email}</td>
                        <td class="px-4 py-2">${user.name}</td>
                        <td class="px-4 py-2">${user.wallet.toFixed(2)} د.ج</td>
                        <td class="px-4 py-2">
                            <span class="status-badge ${isBanned ? 'bg-red-500' : 'bg-green-500'}">
                                ${isBanned ? 'محظور' : 'نشط'}
                            </span>
                        </td>
                        <td class="px-4 py-2 flex space-x-2 space-x-reverse">
                            <button data-user-id="${user.id}" data-user-email="${user.email}" class="adjust-balance-btn bg-blue-500 text-white px-2 py-1 rounded text-xs">تعديل الرصيد</button>
                            <button data-user-id="${user.id}" data-status="${user.status || 'active'}" class="ban-unban-btn ${isBanned ? 'bg-green-500' : 'bg-red-500'} text-white px-2 py-1 rounded text-xs">
                                ${isBanned ? 'تفعيل' : 'حظر'}
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            }
        };
        
        const renderAdminTickets = (tickets) => {
            const table = document.getElementById('admin-tickets-table');
            if (tickets.length === 0) {
                table.innerHTML = `<tr><td colspan="5" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-check-circle text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد تذاكر دعم</h3><p class="text-sm text-gray-500">كل شيء على ما يرام!</p></div></td></tr>`;
            } else {
                table.innerHTML = tickets.map(data => `<tr>
                    <td class="px-4 py-2 text-sm">${data.userEmail}</td>
                    <td class="px-4 py-2 font-semibold">${data.subject}</td>
                    <td class="px-4 py-2">${getStatusBadge(data.status, ticketStatuses)}</td>
                    <td class="px-4 py-2">${new Date(data.lastUpdatedAt?.seconds * 1000).toLocaleString()}</td>
                    <td class="px-4 py-2"><button data-ticket-id="${data.id}" class="view-ticket-btn text-blue-500 hover:underline">عرض</button></td>
                </tr>`).join('');
            }
        };

        const renderAdminRefills = (refills) => {
            const table = document.getElementById('admin-refills-table');
            if (refills.length === 0) {
                table.innerHTML = `<tr><td colspan="5" class="text-center p-8"><div class="flex flex-col items-center"><i class="fas fa-check-circle text-4xl text-gray-400 mb-4"></i><h3 class="font-bold text-lg">لا توجد طلبات إعادة تعبئة</h3><p class="text-sm text-gray-500">كل شيء على ما يرام!</p></div></td></tr>`;
            } else {
                table.innerHTML = refills.map(data => `<tr>
                    <td class="px-4 py-2 text-sm">${data.userEmail}</td>
                    <td class="px-4 py-2">${data.serviceName}</td>
                    <td class="px-4 py-2"><a href="${data.link}" target="_blank" class="text-blue-400 hover:underline">الرابط</a></td>
                    <td class="px-4 py-2">${new Date(data.createdAt?.seconds * 1000).toLocaleString()}</td>
                    <td class="px-4 py-2 flex space-x-2 space-x-reverse">
                        <button data-refill-id="${data.id}" class="complete-refill-btn bg-green-500 text-white px-2 py-1 rounded text-xs">إكمال</button>
                        <button data-refill-id="${data.id}" class="reject-refill-btn bg-red-500 text-white px-2 py-1 rounded text-xs">رفض</button>
                    </td>
                </tr>`).join('');
            }
        };

        const loadAdminData = () => {
            const pendingRequestsQuery = query(collection(db, `artifacts/${appId}/requests`), where("status", "==", "pending"));
            const activeOrdersQuery = query(collection(db, `artifacts/${appId}/orders`), where("status", "in", ["pending", "processing", "partial"]));
            const allUsersQuery = collection(db, `artifacts/${appId}/users`);
            const allTicketsQuery = query(collection(db, `artifacts/${appId}/tickets`));
            const pendingRefillsQuery = query(collection(db, `artifacts/${appId}/refill_requests`), where("status", "==", "pending"));
            const confirmedRequestsQuery = query(collection(db, `artifacts/${appId}/requests`), where("status", "==", "confirmed"));
            const allOrdersQuery = collection(db, `artifacts/${appId}/orders`);
            const broadcastRef = doc(db, `artifacts/${appId}/broadcast/current_message`);

            const unsubAdminRequests = onSnapshot(pendingRequestsQuery, (snapshot) => {
                allAdminRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminRequests(allAdminRequests);
            });

            const unsubAdminOrders = onSnapshot(activeOrdersQuery, (snapshot) => {
                allAdminOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.createdAt.seconds - b.createdAt.seconds);
                renderAdminOrders(allAdminOrders);
                if (statsPendingOrdersEl) statsPendingOrdersEl.textContent = snapshot.size;
            });

            const unsubAdminUsers = onSnapshot(allUsersQuery, (snapshot) => {
                allAdminUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminUsers(allAdminUsers);
                 if (statsTotalUsersEl) statsTotalUsersEl.textContent = snapshot.size;
            });

            const unsubAdminTickets = onSnapshot(allTicketsQuery, (snapshot) => {
                allAdminTickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.lastUpdatedAt.seconds - a.lastUpdatedAt.seconds);
                renderAdminTickets(allAdminTickets);
            });

            const unsubAdminRefills = onSnapshot(pendingRefillsQuery, (snapshot) => {
                allAdminRefills = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.createdAt.seconds - b.createdAt.seconds);
                renderAdminRefills(allAdminRefills);
            });

            const unsubRevenue = onSnapshot(confirmedRequestsQuery, (snapshot) => {
                const totalRevenue = snapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
                if (statsTotalRevenueEl) statsTotalRevenueEl.textContent = `${totalRevenue.toFixed(2)} د.ج`;
            });

            const unsubOrders = onSnapshot(allOrdersQuery, (snapshot) => {
                if (statsTotalOrdersEl) statsTotalOrdersEl.textContent = snapshot.size;
            });

            const unsubBroadcast = onSnapshot(broadcastRef, (docSnap) => {
                const textEl = document.getElementById('current-broadcast-text');
                const deleteBtn = document.getElementById('delete-broadcast-btn');
                if (docSnap.exists()) {
                    textEl.textContent = docSnap.data().message;
                    textEl.classList.remove('text-gray-500', 'dark:text-gray-400');
                    deleteBtn.classList.remove('hidden');
                } else {
                    textEl.textContent = 'لا توجد رسالة نشطة حالياً.';
                    textEl.classList.add('text-gray-500', 'dark:text-gray-400');
                    deleteBtn.classList.add('hidden');
                }
            });

            unsubscribeListeners.push(unsubAdminRequests, unsubAdminOrders, unsubRevenue, unsubAdminUsers, unsubOrders, unsubAdminTickets, unsubAdminRefills, unsubBroadcast);
        };

        // --- Event Handlers for page content ---
        document.body.addEventListener('click', async (e) => {
            // Order Button
            if (e.target.matches('.order-btn')) {
                if (!currentUserData) {
                    showNotification("الرجاء تسجيل الدخول أولاً لتقديم طلب.");
                    openModal(document.getElementById('auth-modal')); return;
                }
                const serviceId = e.target.dataset.serviceId;
                const service = allServicesData.find(s => s.id === serviceId);
                if (currentUserData.wallet < service.price) {
                    showNotification(`رصيدك غير كافٍ. تكلفة هذه الخدمة ${service.price} د.ج.`); return; 
                }
                document.getElementById('order-details').innerHTML = `<p>الخدمة: <span class="font-bold">${service.name}</span></p><p>السعر: <span class="font-bold">${service.price} د.ج</span></p>`;
                document.getElementById('order-form').dataset.serviceId = serviceId;
                
                // Drip-Feed UI Logic
                const dripFeedContainer = document.getElementById('drip-feed-container');
                if (service.dripFeedEnabled) {
                    dripFeedContainer.classList.remove('hidden');
                } else {
                    dripFeedContainer.classList.add('hidden');
                }

                openModal(document.getElementById('order-modal'));
            }

            // Confirm Top-up Button
            if (e.target.matches('.confirm-topup-btn')) {
                const btn = e.target;
                const originalContent = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                const { reqId, userId, amount } = btn.dataset;
                try {
                    await Promise.all([
                        updateDoc(doc(db, `artifacts/${appId}/users`, userId), { wallet: increment(parseFloat(amount)) }),
                        updateDoc(doc(db, `artifacts/${appId}/requests`, reqId), { status: 'confirmed' })
                    ]);
                    showNotification("تم تأكيد الرصيد بنجاح!");
                } catch (err) {
                    console.error("Error confirming topup:", err);
                    showNotification("خطأ في تأكيد الرصيد.", true);
                    btn.disabled = false; btn.innerHTML = originalContent;
                }
            }

            // Update Order Status Button
            if (e.target.matches('.update-order-status-btn')) {
                const btn = e.target;
                const originalContent = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                const { orderId } = btn.dataset;
                const newStatus = document.querySelector(`select[data-order-id='${orderId}']`).value;
                
                try {
                    const orderRef = doc(db, `artifacts/${appId}/orders`, orderId);
                    const orderSnap = await getDoc(orderRef); // Get the latest state
                    
                    if (orderSnap.exists()) {
                        const order = orderSnap.data();
                        if (newStatus === 'canceled' && order.status !== 'canceled') {
                            const userDocRef = doc(db, `artifacts/${appId}/users`, order.userId);
                            await updateDoc(userDocRef, { wallet: increment(order.price) });
                            await updateDoc(orderRef, { status: newStatus });
                            showNotification("تم إلغاء الطلب وإعادة المبلغ للمستخدم!");
                        } else {
                            await updateDoc(orderRef, { status: newStatus });
                            showNotification("تم تحديث حالة الطلب بنجاح!");
                        }
                    } else {
                        throw new Error("Order not found");
                    }
                } catch (err) {
                    console.error("Error updating order status:", err);
                    showNotification("خطأ في تحديث الحالة.", true);
                } finally {
                    btn.disabled = false; btn.innerHTML = originalContent;
                }
            }

            // Adjust Balance Button
            if (e.target.matches('.adjust-balance-btn')) {
                const { userId, userEmail } = e.target.dataset;
                adjustBalanceForm.dataset.userId = userId;
                adjustBalanceUserEmailEl.textContent = `تعديل رصيد المستخدم: ${userEmail}`;
                openModal(adjustBalanceModal);
            }

            // Ban/Unban Button
            if (e.target.matches('.ban-unban-btn')) {
                const btn = e.target;
                btn.disabled = true;
                const { userId, status } = btn.dataset;
                const newStatus = status === 'banned' ? 'active' : 'banned';
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/users`, userId), { status: newStatus });
                    showNotification(`تم ${newStatus === 'banned' ? 'حظر' : 'تفعيل'} المستخدم بنجاح!`);
                } catch (err) {
                    console.error("Error updating user status:", err);
                    showNotification("خطأ في تحديث حالة المستخدم.", true);
                } finally {
                    btn.disabled = false;
                }
            }
            
            // View Ticket Button
            if (e.target.matches('.view-ticket-btn')) {
                const { ticketId } = e.target.dataset;
                openTicketView(ticketId);
            }

            // Refill Button
            if (e.target.matches('.refill-btn')) {
                const btn = e.target;
                btn.disabled = true;
                const { orderId } = btn.dataset;
                try {
                    const orderRef = doc(db, `artifacts/${appId}/orders`, orderId);
                    const orderSnap = await getDoc(orderRef);
                    if (orderSnap.exists()) {
                        const orderData = orderSnap.data();
                        await addDoc(collection(db, `artifacts/${appId}/refill_requests`), {
                            originalOrderId: orderId,
                            userId: orderData.userId,
                            userEmail: orderData.userEmail,
                            serviceName: orderData.serviceName,
                            link: orderData.link,
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        await updateDoc(orderRef, { lastRefillRequestAt: serverTimestamp() });
                        showNotification("تم إرسال طلب إعادة التعبئة بنجاح!");
                    } else {
                         showNotification("لم يتم العثور على الطلب الأصلي.", true);
                    }
                } catch (error) {
                    showNotification("حدث خطأ أثناء إرسال الطلب.", true);
                    console.error("Refill request error:", error);
                    btn.disabled = false;
                }
            }

            // Admin Refill Actions
            const completeRefillBtn = e.target.closest('.complete-refill-btn');
            if(completeRefillBtn) {
                const { refillId } = completeRefillBtn.dataset;
                await updateDoc(doc(db, `artifacts/${appId}/refill_requests`, refillId), { status: 'completed' });
                showNotification("تم إكمال طلب إعادة التعبئة.");
            }
            const rejectRefillBtn = e.target.closest('.reject-refill-btn');
            if(rejectRefillBtn) {
                const { refillId } = rejectRefillBtn.dataset;
                await updateDoc(doc(db, `artifacts/${appId}/refill_requests`, refillId), { status: 'rejected' });
                showNotification("تم رفض طلب إعادة التعبئة.");
            }

            // Increment Drip-Feed Button
            const incrementDripFeedBtn = e.target.closest('.increment-drip-feed-btn');
            if (incrementDripFeedBtn) {
                const btn = incrementDripFeedBtn;
                btn.disabled = true;
                const { orderId } = btn.dataset;
                try {
                    const orderRef = doc(db, `artifacts/${appId}/orders`, orderId);
                    await updateDoc(orderRef, {
                        dripFeedRunsCompleted: increment(1)
                    });
                    showNotification("تم تسجيل الدفعة بنجاح!");
                } catch (err) {
                    console.error("Error incrementing drip feed run:", err);
                    showNotification("خطأ في تسجيل الدفعة.", true);
                } finally {
                    btn.disabled = false;
                }
            }
        });

        // --- Form Submissions (Explicit Listeners) ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الدخول...`;
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            const errorEl = document.getElementById('signup-error');
            errorEl.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإنشاء...`;

            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, `artifacts/${appId}/users`, userCredential.user.uid), { name, email, wallet: 0, status: 'active', createdAt: serverTimestamp() });
                await updateProfile(userCredential.user, { displayName: name });
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') errorEl.textContent = "هذا البريد الإلكتروني مسجل بالفعل.";
                else if (error.code === 'auth/weak-password') errorEl.textContent = "يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.";
                else errorEl.textContent = "حدث خطأ أثناء إنشاء الحساب.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('topup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإرسال...`;

            const amount = parseFloat(document.getElementById('topup-amount').value);
            const contactInfo = document.getElementById('contact-info').value;
            const user = auth.currentUser;

            if (!user) {
                showNotification("يجب تسجيل الدخول أولاً.", true);
            } else if (isNaN(amount) || amount <= 0 || !contactInfo.trim()) {
                showNotification("بيانات غير صحيحة.", true);
            } else {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/requests`), { userId: user.uid, userEmail: user.email, amount, contactInfo, status: 'pending', createdAt: serverTimestamp() });
                    closeModal(document.getElementById('topup-modal'));
                    e.target.reset();
                    showNotification("تم إرسال طلبك بنجاح!");
                } catch (error) {
                    showNotification("خطأ في إرسال الطلب.", true);
                    console.error("Top-up error:", error);
                }
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            const errorEl = document.getElementById('order-error');
            errorEl.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري التأكيد...`;

            const serviceId = e.target.dataset.serviceId;
            const service = allServicesData.find(s => s.id === serviceId);
            const link = document.getElementById('service-link').value;
            
            const isDripFeed = document.getElementById('drip-feed-checkbox').checked;
            let orderData = {};

            if (isDripFeed) {
                const quantityPerRun = parseInt(document.getElementById('drip-feed-quantity').value);
                const interval = parseInt(document.getElementById('drip-feed-interval').value);
                const totalQuantity = service.quantity;
                
                if (!quantityPerRun || !interval || quantityPerRun <= 0 || interval <= 0) {
                    errorEl.textContent = "الرجاء إدخال قيم صحيحة للتزويد التدريجي.";
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
                if (quantityPerRun > totalQuantity) {
                    errorEl.textContent = `الكمية في كل مرة لا يمكن أن تتجاوز إجمالي كمية الباقة (${totalQuantity}).`;
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                const totalRuns = Math.ceil(totalQuantity / quantityPerRun);
                orderData = { isDripFeed: true, dripFeedQuantityPerRun: quantityPerRun, dripFeedInterval: interval, dripFeedTotalRuns: totalRuns, dripFeedRunsCompleted: 0 };
            } else {
                orderData = { isDripFeed: false };
            }

            if (currentUserData.wallet < service.price) {
                errorEl.textContent = "رصيدك غير كافٍ لإتمام هذه العملية.";
                errorEl.classList.remove('hidden');
            } else {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/orders`), {
                        userId: currentUserData.id, 
                        userEmail: currentUserData.email, 
                        serviceId: service.id, 
                        serviceName: service.name, 
                        price: service.price, 
                        link, 
                        status: 'pending', 
                        createdAt: serverTimestamp(),
                        ...orderData
                    });
                    await updateDoc(doc(db, `artifacts/${appId}/users`, currentUserData.id), { wallet: increment(-service.price) });
                    closeModal(document.getElementById('order-modal'));
                    e.target.reset();
                    showNotification("تم تقديم طلبك بنجاح!");
                } catch (error) {
                    errorEl.textContent = "حدث خطأ أثناء تقديم الطلب.";
                    errorEl.classList.remove('hidden');
                    console.error("Order submission error:", error);
                }
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            const errorEl = document.getElementById('reset-error');
            errorEl.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإرسال...`;

            const email = document.getElementById('reset-email').value;
            try {
                await sendPasswordResetEmail(auth, email);
                closeModal(document.getElementById('reset-password-modal'));
                showNotification("تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني.");
            } catch (error) {
                errorEl.textContent = "لا يوجد حساب مسجل بهذا البريد الإلكتروني.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('update-name-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري التحديث...`;

            const newName = profileNameInput.value.trim();
            const user = auth.currentUser;
            if (user && newName) {
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/users`, user.uid), { name: newName });
                    await updateProfile(user, { displayName: newName });
                    showNotification("تم تحديث الاسم بنجاح!");
                } catch (error) {
                    showNotification("حدث خطأ أثناء تحديث الاسم.", true);
                    console.error("Update name error:", error);
                }
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('update-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            const errorEl = document.getElementById('update-password-error');
            errorEl.classList.add('hidden');
            
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;

            if (newPassword !== confirmPassword) {
                errorEl.textContent = "كلمتا المرور غير متطابقتين.";
                errorEl.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                errorEl.textContent = "يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.";
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري التغيير...`;
            const user = auth.currentUser;
            if (user) {
                try {
                    await updatePassword(user, newPassword);
                    showNotification("تم تحديث كلمة المرور بنجاح!");
                    e.target.reset();
                } catch (error) {
                    if (error.code === 'auth/requires-recent-login') {
                        errorEl.textContent = "هذه العملية تتطلب تسجيل دخول حديث. الرجاء تسجيل الخروج ثم الدخول مرة أخرى.";
                    } else {
                        errorEl.textContent = "حدث خطأ أثناء تحديث كلمة المرور.";
                    }
                    errorEl.classList.remove('hidden');
                    console.error("Update password error:", error);
                }
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        adjustBalanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري التعديل...`;

            const userId = adjustBalanceForm.dataset.userId;
            const amountInput = document.getElementById('adjust-balance-amount');
            const amount = parseFloat(amountInput.value);

            if (userId && !isNaN(amount)) {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
                    await updateDoc(userDocRef, { wallet: increment(amount) });
                    showNotification("تم تعديل الرصيد بنجاح!");
                    closeModal(adjustBalanceModal);
                    e.target.reset();
                } catch (err) {
                    showNotification("خطأ في تعديل الرصيد.", true);
                    console.error("Adjust balance error:", err);
                }
            } else {
                showNotification("الرجاء إدخال مبلغ صحيح.", true);
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('new-ticket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإرسال...`;

            const subject = document.getElementById('ticket-subject').value.trim();
            const message = document.getElementById('ticket-message').value.trim();
            const user = auth.currentUser;

            if (user && user.displayName && subject && message) {
                try {
                    const ticketRef = await addDoc(collection(db, `artifacts/${appId}/tickets`), {
                        userId: user.uid,
                        userEmail: user.email,
                        subject: subject,
                        status: 'open',
                        createdAt: serverTimestamp(),
                        lastUpdatedAt: serverTimestamp()
                    });
                    
                    await addDoc(collection(db, `artifacts/${appId}/tickets/${ticketRef.id}/messages`), {
                        senderId: user.uid,
                        senderName: user.displayName,
                        text: message,
                        createdAt: serverTimestamp()
                    });

                    showNotification("تم فتح التذكرة بنجاح!");
                    closeModal(newTicketModal);
                    e.target.reset();
                } catch (err) {
                    showNotification("خطأ في فتح التذكرة.", true);
                    console.error("New ticket error:", err);
                }
            } else {
                showNotification("الرجاء ملء جميع الحقول.", true);
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('reply-ticket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
            
            const ticketId = e.target.dataset.ticketId;
            const messageInput = document.getElementById('reply-message-input');
            const message = messageInput.value.trim();
            const user = auth.currentUser;

            if (user && ticketId && message) {
                try {
                    const ticketRef = doc(db, `artifacts/${appId}/tickets`, ticketId);
                    const messagesRef = collection(db, `artifacts/${appId}/tickets/${ticketId}/messages`);
                    
                    const isUserAdmin = user.uid === ADMIN_UID;
                    const newStatus = isUserAdmin ? 'answered' : 'open';
                    
                    const senderName = isUserAdmin ? 'الدعم الفني' : user.displayName;

                    await addDoc(messagesRef, {
                        senderId: user.uid,
                        senderName: senderName,
                        text: message,
                        createdAt: serverTimestamp()
                    });

                    await updateDoc(ticketRef, {
                        status: newStatus,
                        lastUpdatedAt: serverTimestamp()
                    });
                    
                    messageInput.value = '';
                } catch (err) {
                    showNotification("خطأ في إرسال الرد.", true);
                    console.error("Reply error:", err);
                }
            }

            btn.disabled = false;
            btn.innerHTML = originalText;
        });
        
        document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإرسال...`;

            const message = document.getElementById('broadcast-message-input').value.trim();
            if (message) {
                try {
                    const broadcastRef = doc(db, `artifacts/${appId}/broadcast/current_message`);
                    await setDoc(broadcastRef, {
                        message: message,
                        createdAt: serverTimestamp()
                    });
                    showNotification("تم إرسال الرسالة الجماعية بنجاح!");
                    e.target.reset();
                } catch (error) {
                    showNotification("خطأ في إرسال الرسالة.", true);
                    console.error("Broadcast error:", error);
                }
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        });

        document.getElementById('delete-broadcast-btn').addEventListener('click', async () => {
            try {
                const broadcastRef = doc(db, `artifacts/${appId}/broadcast/current_message`);
                await deleteDoc(broadcastRef);
                showNotification("تم حذف الرسالة الجماعية بنجاح!");
            } catch (error) {
                showNotification("خطأ في حذف الرسالة.", true);
                console.error("Delete broadcast error:", error);
            }
        });

        // --- Ticket View Logic ---
        const openTicketView = async (ticketId) => {
            if (currentTicketListener) currentTicketListener(); // Unsubscribe from previous listener

            const ticketRef = doc(db, `artifacts/${appId}/tickets`, ticketId);
            const messagesRef = collection(db, `artifacts/${appId}/tickets/${ticketId}/messages`);
            const messagesQuery = query(messagesRef, orderBy("createdAt", "asc"));

            const ticketDoc = await getDoc(ticketRef);
            if (!ticketDoc.exists()) {
                showNotification("لم يتم العثور على التذكرة.", true);
                return;
            }

            const ticketData = ticketDoc.data();
            document.getElementById('view-ticket-subject').textContent = ticketData.subject;
            document.getElementById('view-ticket-user').textContent = `للمستخدم: ${ticketData.userEmail}`;
            document.getElementById('reply-ticket-form').dataset.ticketId = ticketId;
            
            const isAdmin = auth.currentUser.uid === ADMIN_UID;
            const adminActions = document.getElementById('admin-ticket-actions');
            adminActions.classList.toggle('hidden', !isAdmin);

            if(isAdmin) {
                const statusSelect = document.getElementById('ticket-status-select');
                statusSelect.innerHTML = Object.keys(ticketStatuses).map(key => `<option value="${key}" ${ticketData.status === key ? 'selected' : ''}>${ticketStatuses[key].text}</option>`).join('');
                statusSelect.onchange = async () => {
                    await updateDoc(ticketRef, { status: statusSelect.value });
                    showNotification("تم تحديث حالة التذكرة.");
                };
            }

            const messagesContainer = document.getElementById('ticket-messages-container');
            
            currentTicketListener = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isSent = msg.senderId === auth.currentUser.uid;
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
                    messageDiv.innerHTML = `
                        <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                            <p class="font-bold text-sm">${msg.senderName}</p>
                            <p>${msg.text}</p>
                            <p class="text-xs opacity-70 text-right mt-1">${new Date(msg.createdAt?.seconds * 1000).toLocaleTimeString()}</p>
                        </div>
                    `;
                    messagesContainer.appendChild(messageDiv);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });

            openModal(viewTicketModal);
        };


        // --- Search ---
        const setupSearch = () => {
            document.getElementById('search-requests').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderAdminRequests(allAdminRequests.filter(req => req.userEmail.toLowerCase().includes(searchTerm)));
            });
            document.getElementById('search-orders').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderAdminOrders(allAdminOrders.filter(order => order.userEmail.toLowerCase().includes(searchTerm)));
            });
            document.getElementById('search-users').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderAdminUsers(allAdminUsers.filter(user => user.email.toLowerCase().includes(searchTerm)));
            });
            document.getElementById('search-tickets').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderAdminTickets(allAdminTickets.filter(ticket => ticket.userEmail.toLowerCase().includes(searchTerm)));
            });
             document.getElementById('search-refills').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                renderAdminRefills(allAdminRefills.filter(refill => refill.userEmail.toLowerCase().includes(searchTerm)));
            });
        };
        
        // --- Modal Setup ---
        const setupModalListeners = () => {
            const authModal = document.getElementById('auth-modal');
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            const switchTab = (isLogin) => {
                loginTab.classList.toggle('tab-active', isLogin);
                signupTab.classList.toggle('tab-active', !isLogin);
                loginForm.classList.toggle('hidden', !isLogin);
                signupForm.classList.toggle('hidden', isLogin);
            };

            loginTab.addEventListener('click', () => switchTab(true));
            signupTab.addEventListener('click', () => switchTab(false));
            document.getElementById('login-btn').addEventListener('click', () => { switchTab(true); openModal(authModal); });
            document.getElementById('signup-btn').addEventListener('click', () => { switchTab(false); openModal(authModal); });
            document.getElementById('topup-btn').addEventListener('click', () => openModal(document.getElementById('topup-modal')));
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); closeModal(authModal); openModal(document.getElementById('reset-password-modal')); });
            document.getElementById('open-new-ticket-modal-btn').addEventListener('click', () => openModal(newTicketModal));
            
            document.querySelectorAll('[id^="close-"]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay'))));
            
            document.getElementById('close-broadcast-banner').addEventListener('click', (e) => {
                const banner = e.target.closest('#broadcast-banner');
                if (banner && banner.dataset.messageId) {
                    localStorage.setItem(banner.dataset.messageId, 'dismissed');
                    banner.classList.add('-translate-y-full');
                    setTimeout(() => banner.classList.add('hidden'), 300);
                }
            });

            // Drip-Feed Logic
            const dripFeedCheckbox = document.getElementById('drip-feed-checkbox');
            const dripFeedOptions = document.getElementById('drip-feed-options');
            const dripFeedQuantityInput = document.getElementById('drip-feed-quantity');
            const dripFeedRunsSpan = document.getElementById('drip-feed-runs');

            dripFeedCheckbox.addEventListener('change', () => {
                dripFeedOptions.classList.toggle('hidden', !dripFeedCheckbox.checked);
            });

            dripFeedQuantityInput.addEventListener('input', () => {
                const serviceId = document.getElementById('order-form').dataset.serviceId;
                const service = allServicesData.find(s => s.id === serviceId);
                const quantityPerRun = parseInt(dripFeedQuantityInput.value);
                if (service && quantityPerRun > 0) {
                    const totalRuns = Math.ceil(service.quantity / quantityPerRun);
                    dripFeedRunsSpan.textContent = totalRuns;
                } else {
                    dripFeedRunsSpan.textContent = '0';
                }
            });

            // Reset Stats Logic
            document.getElementById('reset-stats-btn').addEventListener('click', () => {
                openModal(resetStatsModal);
            });
            document.getElementById('cancel-reset-stats-btn').addEventListener('click', () => {
                closeModal(resetStatsModal);
            });
            document.getElementById('confirm-reset-stats-btn').addEventListener('click', async () => {
                const btn = document.getElementById('confirm-reset-stats-btn');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الحذف...`;

                const deleteAllFromCollection = async (collectionName) => {
                    const q = query(collection(db, `artifacts/${appId}/${collectionName}`));
                    const snapshot = await getDocs(q);
                    const deletePromises = [];
                    snapshot.forEach(doc => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                };

                try {
                    await Promise.all([
                        deleteAllFromCollection('orders'),
                        deleteAllFromCollection('requests'),
                        deleteAllFromCollection('refill_requests')
                    ]);
                    showNotification("تم إعادة تعيين بيانات الطلبات والإيرادات بنجاح!");
                } catch (err) {
                    showNotification("حدث خطأ أثناء إعادة التعيين.", true);
                    console.error("Error resetting stats:", err);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'نعم، قم بإعادة التعيين';
                    closeModal(resetStatsModal);
                }
            });
        };

        // --- Admin Panel Tabs ---
        const setupAdminTabs = () => {
            const tabs = document.querySelectorAll('.admin-tab');
            const panels = document.querySelectorAll('.admin-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('tab-active');
                        t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    panels.forEach(p => p.classList.add('hidden'));
                    
                    tab.classList.add('tab-active');
                    tab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                    const panelId = tab.id.replace('tab', 'panel');
                    document.getElementById(panelId)?.classList.remove('hidden');
                });
            });
        };

        // --- Initial Load ---
        renderServices();
        setupNavigationAndMenu();
        setupModalListeners();
        setupSearch();
        setupAdminTabs();
        showPage('home-page');
    </script>
</body>
</html>
