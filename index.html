<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سوشيال بوست | لوحة التحكم</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Tajawal for Arabic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Tajawal', sans-serif; scroll-behavior: smooth; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #2563eb 100%); }
        .card-hover:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-overlay, .notification { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-link.active { color: #3b82f6; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" id="home-link" class="nav-link active text-2xl font-bold text-blue-600 dark:text-blue-400">
                <i class="fas fa-rocket mr-2"></i>سوشيال بوست
            </a>
            <div class="hidden md:flex items-center space-x-6 space-x-reverse">
                <!-- Auth buttons -->
                <div id="auth-links" class="flex items-center space-x-4 space-x-reverse">
                    <button id="login-btn" class="hover:text-blue-500">تسجيل الدخول</button>
                    <button id="signup-btn" class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition duration-300">حساب جديد</button>
                </div>
                <!-- User profile -->
                <div id="user-profile" class="hidden items-center space-x-4 space-x-reverse">
                    <button id="admin-link" class="nav-link hidden hover:text-blue-500 font-semibold">لوحة التحكم</button>
                    <button id="profile-link" class="nav-link hover:text-blue-500 font-semibold">ملفي الشخصي</button>
                    <div class="flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-full">
                         <span class="font-semibold text-sm" id="wallet-balance">رصيدك: $0.00</span>
                         <i class="fas fa-wallet text-gray-500 ml-2 mr-2"></i>
                         <button id="topup-btn" class="bg-green-500 text-white w-6 h-6 rounded-full hover:bg-green-600 flex items-center justify-center text-sm" title="شحن الرصيد">
                            <i class="fas fa-plus"></i>
                         </button>
                    </div>
                    <button id="logout-btn" class="bg-red-500 text-white px-3 py-2 rounded-full hover:bg-red-600 transition duration-300" title="تسجيل الخروج">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="md:hidden"><button class="text-gray-800 dark:text-gray-200 focus:outline-none"><i class="fas fa-bars text-2xl"></i></button></div>
        </nav>
    </header>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <section class="gradient-bg text-white py-20 md:py-32">
                <div class="container mx-auto px-6 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight">عزز تواجدك على وسائل التواصل الاجتماعي</h1>
                    <p class="text-lg md:text-xl mb-8 max-w-3xl mx-auto">نقدم خدمات عالية الجودة لزيادة المتابعين، الإعجابات، والمشاهدات لمساعدتك على النمو والانتشار.</p>
                </div>
            </section>
            <section id="services" class="py-20">
                <div class="container mx-auto px-6">
                    <h2 class="text-3xl font-bold text-center mb-12">باقاتنا المميزة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="services-grid">
                        <!-- Service cards will be injected here by JS -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page container mx-auto p-6">
            <h1 class="text-3xl font-bold mb-6">ملفي الشخصي</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top-up Requests -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">سجل طلبات الشحن</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">المبلغ</th><th class="px-4 py-3">الحالة</th><th class="px-4 py-3">التاريخ</th></tr></thead>
                            <tbody id="user-requests-table">
                                <!-- User requests will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Service Orders -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4">سجل طلبات الخدمات</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">الخدمة</th><th class="px-4 py-3">السعر</th><th class="px-4 py-3">الحالة</th><th class="px-4 py-3">التاريخ</th></tr></thead>
                            <tbody id="user-orders-table">
                                <!-- User orders will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page container mx-auto p-6">
            <h1 class="text-3xl font-bold mb-6">لوحة تحكم المدير</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <!-- Pending Top-up Requests -->
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">طلبات الشحن المعلقة</h2>
                        <input type="text" id="search-requests" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث بالبريد الإلكتروني...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">البريد الإلكتروني</th><th class="px-4 py-3">المبلغ</th><th class="px-4 py-3">معلومات التواصل</th><th class="px-4 py-3">إجراء</th></tr></thead>
                            <tbody id="admin-requests-table">
                                <!-- Admin requests will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Pending Service Orders -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">طلبات الخدمات المعلقة</h2>
                        <input type="text" id="search-orders" class="w-1/2 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm" placeholder="بحث بالبريد الإلكتروني...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"><tr><th class="px-4 py-3">البريد الإلكتروني</th><th class="px-4 py-3">الخدمة</th><th class="px-4 py-3">الرابط</th><th class="px-4 py-3">إجراء</th></tr></thead>
                            <tbody id="admin-orders-table">
                                <!-- Admin orders will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="auth-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">مرحباً بك</h2><button id="close-auth-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><div class="flex border-b border-gray-200 dark:border-gray-700 mb-6"><button id="login-tab" class="py-2 px-4 border-b-2 tab-active w-1/2 text-center font-semibold">تسجيل الدخول</button><button id="signup-tab" class="py-2 px-4 border-b-2 border-transparent w-1/2 text-center font-semibold text-gray-500">حساب جديد</button></div><form id="login-form" class="space-y-4"><div><label for="login-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="login-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><div><label for="login-password" class="block mb-2 text-sm font-medium">كلمة المرور</label><input type="password" id="login-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><div class="text-sm text-left"><a href="#" id="forgot-password-link" class="font-medium text-blue-600 hover:underline dark:text-blue-500">نسيت كلمة المرور؟</a></div><p id="login-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">دخول</button></form><form id="signup-form" class="space-y-4 hidden"><div><label for="signup-name" class="block mb-2 text-sm font-medium">الاسم الكامل</label><input type="text" id="signup-name" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><div><label for="signup-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="signup-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><div><label for="signup-password" class="block mb-2 text-sm font-medium">كلمة المرور</label><input type="password" id="signup-password" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><p id="signup-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إنشاء حساب</button></form></div></div></div>
    <div id="topup-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">طلب شحن الرصيد</h2><button id="close-topup-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">أدخل المبلغ المطلوب ومعلومات التواصل. سنتواصل معك لإتمام عملية الدفع وتأكيد شحن الرصيد.</p><form id="topup-form" class="space-y-4"><div><label for="topup-amount" class="block mb-2 text-sm font-medium">المبلغ (بالدولار)</label><input type="number" id="topup-amount" min="1" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="مثال: 10" required></div><div><label for="contact-info" class="block mb-2 text-sm font-medium">معلومات التواصل (واتساب، تيليجرام، الخ)</label><input type="text" id="contact-info" class="w-full p-3 bg-gray-100 dark:bg-gamma-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="مثال: 9665xxxxxxx+" required></div><p id="topup-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-300 disabled:opacity-50">إرسال الطلب</button></form></div></div></div>
    <div id="order-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">تأكيد الطلب</h2><button id="close-order-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><div id="order-details" class="mb-4"></div><form id="order-form" class="space-y-4"><div><label for="service-link" class="block mb-2 text-sm font-medium">رابط الحساب أو المنشور</label><input type="url" id="service-link" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" placeholder="https://..." required></div><p id="order-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">تأكيد وشراء</button></form></div></div></div>
    <div id="reset-password-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden"><div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-lg z-50 transform -translate-y-full"><div class="p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">إعادة تعيين كلمة المرور</h2><button id="close-reset-modal-btn" class="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">أدخل بريدك الإلكتروني المسجل وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.</p><form id="reset-password-form" class="space-y-4"><div><label for="reset-email" class="block mb-2 text-sm font-medium">البريد الإلكتروني</label><input type="email" id="reset-email" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" required></div><p id="reset-error" class="text-red-500 text-sm hidden"></p><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50">إرسال الرابط</button></form></div></div></div>

    <!-- Success Notification -->
    <div id="success-notification" class="notification fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-full opacity-0"><i class="fas fa-check-circle mr-2"></i><span id="notification-message"></span></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBlmRUBMkPZAwRKcESiyTsBD9XAN_eukwM",
            authDomain: "hdesign-4c4e4.firebaseapp.com",
            projectId: "hdesign-4c4e4",
            storageBucket: "hdesign-4c4e4.appspot.com",
            messagingSenderId: "518290616043",
            appId: "1:518290616043:web:1627ed9072bcc27b7498ae",
        };
        const ADMIN_UID = "2bZAxqRdQWYyNFdBeO6Wr5FiiyU2"; 

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "hdesign-4c4e4";

        // --- DOM Elements ---
        const authModal = document.getElementById('auth-modal');
        const notification = document.getElementById('success-notification');
        const notificationMessage = document.getElementById('notification-message');
        const servicesGrid = document.getElementById('services-grid');

        // --- STATE ---
        let currentUserData = null;
        let servicesData = [
            { id: 'insta1k', name: 'باقة انستغرام الذهبية', price: 25, icon: 'fab fa-instagram', color: 'text-pink-500', description: '/ 1000 متابع' },
            { id: 'tiktok10k', name: 'باقة تيك توك للمشاهير', price: 50, icon: 'fab fa-tiktok', color: 'text-cyan-400', description: '/ 10,000 مشاهدة', popular: true },
            { id: 'youtube500', name: 'باقة يوتيوب الاحترافية', price: 40, icon: 'fab fa-youtube', color: 'text-red-500', description: '/ 500 مشترك' }
        ];
        let allAdminRequests = [];
        let allAdminOrders = [];

        // --- RENDER FUNCTIONS ---
        const renderServices = () => {
            if (!servicesGrid) return;
            servicesGrid.innerHTML = servicesData.map(service => `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center transition duration-300 card-hover ${service.popular ? 'border-4 border-blue-500' : ''} relative">
                    ${service.popular ? '<span class="absolute top-0 right-1/2 transform translate-x-1/2 -translate-y-1/2 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full">الأكثر مبيعاً</span>' : ''}
                    <i class="${service.icon} ${service.color} text-5xl mb-6"></i>
                    <h3 class="text-2xl font-bold mb-4">${service.name}</h3>
                    <p class="text-4xl font-extrabold mb-6">$${service.price}<span class="text-lg font-normal text-gray-500 dark:text-gray-400">${service.description}</span></p>
                    <button data-service-id="${service.id}" class="order-btn w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700 transition duration-300">اطلب الآن</button>
                </div>
            `).join('');
        };

        // --- UI & NAVIGATION ---
        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`[id="${pageId.replace('-page', '-link')}"]`);
            if (activeLink) activeLink.classList.add('active');
            window.scrollTo(0, 0);
        };

        const setupNavLinks = () => {
            document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); showPage('home-page'); });
            document.getElementById('profile-link').addEventListener('click', (e) => { e.preventDefault(); showPage('profile-page'); });
            document.getElementById('admin-link').addEventListener('click', (e) => { e.preventDefault(); showPage('admin-page'); });
        };
        
        const openModal = (modal) => {
            if (!modal) return;
            const container = modal.querySelector('.modal-container');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if(container) container.classList.remove('-translate-y-full');
            }, 10);
        };

        const closeModal = (modal) => {
            if (!modal) return;
            const container = modal.querySelector('.modal-container');
            modal.classList.add('opacity-0');
            if(container) container.classList.add('-translate-y-full');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        const showNotification = (message) => {
            if (!notificationMessage || !notification) return;
            notificationMessage.textContent = message;
            notification.classList.remove('translate-x-full', 'opacity-0');
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
            }, 4000);
        };

        // --- Firebase & App Logic ---
        let unsubscribeListeners = [];

        const cleanupListeners = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        };
        
        onAuthStateChanged(auth, (user) => {
            cleanupListeners();
            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const unsubUser = onSnapshot(userDocRef, (docSnap) => {
                    const userEmailSpan = document.getElementById('user-email');
                    const walletBalanceSpan = document.getElementById('wallet-balance');
                    if (docSnap.exists()) {
                        currentUserData = { id: docSnap.id, ...docSnap.data() };
                        if(userEmailSpan) userEmailSpan.textContent = currentUserData.name || user.email;
                        if(walletBalanceSpan) walletBalanceSpan.textContent = `رصيدك: $${currentUserData.wallet.toFixed(2)}`;
                    }
                    document.getElementById('auth-links').classList.add('hidden');
                    const userProfile = document.getElementById('user-profile');
                    if (userProfile) {
                        userProfile.classList.remove('hidden');
                        userProfile.classList.add('flex');
                    }
                    if (user.uid === ADMIN_UID) {
                        const adminLink = document.getElementById('admin-link');
                        if(adminLink) adminLink.classList.remove('hidden');
                        loadAdminData();
                    }
                });
                unsubscribeListeners.push(unsubUser);
                loadUserData(user.uid);
                closeModal(authModal);
            } else {
                currentUserData = null;
                document.getElementById('auth-links').classList.remove('hidden');
                document.getElementById('user-profile').classList.add('hidden');
                document.getElementById('admin-link').classList.add('hidden');
                showPage('home-page');
            }
        });

        const loadUserData = (userId) => {
            const requestsQuery = query(collection(db, `artifacts/${appId}/requests`), where("userId", "==", userId));
            const ordersQuery = query(collection(db, `artifacts/${appId}/orders`), where("userId", "==", userId));
            
            const unsubRequests = onSnapshot(requestsQuery, (snapshot) => {
                const table = document.getElementById('user-requests-table');
                if (!table) return;
                let docs = snapshot.docs.map(doc => doc.data());
                docs.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                if (docs.length === 0) {
                    table.innerHTML = `<tr><td colspan="3" class="text-center p-4">لا توجد طلبات شحن.</td></tr>`;
                    return;
                }
                table.innerHTML = docs.map(data => {
                    return `<tr><td class="px-4 py-2">$${data.amount}</td><td class="px-4 py-2">${data.status}</td><td class="px-4 py-2">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</td></tr>`;
                }).join('');
            }, error => console.error("Error fetching user requests:", error));

            const unsubOrders = onSnapshot(ordersQuery, (snapshot) => {
                const table = document.getElementById('user-orders-table');
                if (!table) return;
                let docs = snapshot.docs.map(doc => doc.data());
                docs.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                if (docs.length === 0) {
                    table.innerHTML = `<tr><td colspan="4" class="text-center p-4">لا توجد طلبات خدمات.</td></tr>`;
                    return;
                }
                table.innerHTML = docs.map(data => {
                    return `<tr><td class="px-4 py-2">${data.serviceName}</td><td class="px-4 py-2">$${data.price}</td><td class="px-4 py-2">${data.status}</td><td class="px-4 py-2">${new Date(data.createdAt?.seconds * 1000).toLocaleDateString()}</td></tr>`;
                }).join('');
            }, error => console.error("Error fetching user orders:", error));
            unsubscribeListeners.push(unsubRequests, unsubOrders);
        };

        const renderAdminRequests = (requests) => {
            const table = document.getElementById('admin-requests-table');
            if (!table) return;
            if (requests.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center p-4">لا توجد طلبات مطابقة.</td></tr>`;
                return;
            }
            table.innerHTML = requests.map(req => `<tr>
                <td class="px-4 py-2">${req.userEmail}</td>
                <td class="px-4 py-2">$${req.amount}</td>
                <td class="px-4 py-2">${req.contactInfo}</td>
                <td class="px-4 py-2"><button data-req-id="${req.id}" data-user-id="${req.userId}" data-amount="${req.amount}" class="confirm-topup-btn bg-green-500 text-white px-2 py-1 rounded text-xs">تأكيد</button></td>
            </tr>`).join('');
        };

        const renderAdminOrders = (orders) => {
            const table = document.getElementById('admin-orders-table');
            if (!table) return;
            if (orders.length === 0) {
                table.innerHTML = `<tr><td colspan="4" class="text-center p-4">لا توجد طلبات مطابقة.</td></tr>`;
                return;
            }
            table.innerHTML = orders.map(order => `<tr>
                <td class="px-4 py-2">${order.userEmail}</td>
                <td class="px-4 py-2">${order.serviceName}</td>
                <td class="px-4 py-2"><a href="${order.link}" target="_blank" class="text-blue-400 hover:underline">الرابط</a></td>
                <td class="px-4 py-2"><button data-order-id="${order.id}" class="complete-order-btn bg-green-500 text-white px-2 py-1 rounded text-xs">إكمال</button></td>
            </tr>`).join('');
        };

        const loadAdminData = () => {
            const pendingRequestsQuery = query(collection(db, `artifacts/${appId}/requests`), where("status", "==", "pending"));
            const pendingOrdersQuery = query(collection(db, `artifacts/${appId}/orders`), where("status", "==", "pending"));

            const unsubAdminRequests = onSnapshot(pendingRequestsQuery, (snapshot) => {
                allAdminRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminRequests(allAdminRequests);
            }, error => console.error("Error fetching admin requests:", error));

            const unsubAdminOrders = onSnapshot(pendingOrdersQuery, (snapshot) => {
                allAdminOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminOrders(allAdminOrders);
            }, error => console.error("Error fetching admin orders:", error));
            unsubscribeListeners.push(unsubAdminRequests, unsubAdminOrders);
        };

        // --- Event Handlers ---
        document.addEventListener('click', async (e) => {
            if (e.target.matches('.order-btn')) {
                if (!currentUserData) {
                    showNotification("الرجاء تسجيل الدخول أولاً لتقديم طلب.");
                    openModal(document.getElementById('auth-modal'));
                    return;
                }
                const serviceId = e.target.dataset.serviceId;
                const service = servicesData.find(s => s.id === serviceId);
                if (currentUserData.wallet < service.price) {
                    showNotification(`رصيدك غير كافٍ. تكلفة هذه الخدمة $${service.price}.`);
                    return; 
                }
                const orderDetails = document.getElementById('order-details');
                orderDetails.innerHTML = `<p>الخدمة: <span class="font-bold">${service.name}</span></p><p>السعر: <span class="font-bold">$${service.price}</span></p>`;
                document.getElementById('order-form').dataset.serviceId = serviceId;
                openModal(document.getElementById('order-modal'));
            }
            if (e.target.matches('.confirm-topup-btn')) {
                e.target.disabled = true;
                const { reqId, userId, amount } = e.target.dataset;
                const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
                const reqDocRef = doc(db, `artifacts/${appId}/requests`, reqId);
                try {
                    await Promise.all([
                        updateDoc(userDocRef, { wallet: increment(parseFloat(amount)) }),
                        updateDoc(reqDocRef, { status: 'confirmed' })
                    ]);
                    showNotification("تم تأكيد الرصيد بنجاح!");
                } catch (err) {
                    console.error("Error confirming topup:", err);
                    showNotification("خطأ في تأكيد الرصيد.");
                    e.target.disabled = false;
                }
            }
            if (e.target.matches('.complete-order-btn')) {
                e.target.disabled = true;
                const { orderId } = e.target.dataset;
                const orderDocRef = doc(db, `artifacts/${appId}/orders`, orderId);
                try {
                    await updateDoc(orderDocRef, { status: 'completed' });
                    showNotification("تم إكمال الطلب بنجاح!");
                } catch (err) {
                    console.error("Error completing order:", err);
                    showNotification("خطأ في إكمال الطلب.");
                    e.target.disabled = false;
                }
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => { 
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الدخول...`;
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            try {
                if (!emailInput || !passwordInput) throw new Error("Form elements not found");
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                console.error("Login Error Details:", error);
                errorEl.textContent = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => { 
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإنشاء...`;
            const nameInput = document.getElementById('signup-name');
            const emailInput = document.getElementById('signup-email');
            const passwordInput = document.getElementById('signup-password');
            const errorEl = document.getElementById('signup-error');
            errorEl.classList.add('hidden');
            try {
                 if (!nameInput || !emailInput || !passwordInput) throw new Error("Form elements not found");
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                await setDoc(doc(db, `artifacts/${appId}/users`, userCredential.user.uid), {
                    name: nameInput.value, email: emailInput.value, wallet: 0, createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Signup Error Details:", error);
                switch (error.code) {
                    case 'auth/email-already-in-use': errorEl.textContent = "هذا البريد الإلكتروني مسجل بالفعل."; break;
                    case 'auth/invalid-email': errorEl.textContent = "البريد الإلكتروني الذي أدخلته غير صالح."; break;
                    case 'auth/weak-password': errorEl.textContent = "يجب أن تتكون كلمة المرور من 6 أحرف على الأقل."; break;
                    default: errorEl.textContent = "حدث خطأ. يرجى التحقق من Console لمزيد من التفاصيل.";
                }
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => { await signOut(auth); });
        
        document.getElementById('topup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            const amount = parseFloat(document.getElementById('topup-amount').value);
            const contactInfo = document.getElementById('contact-info').value;
            const user = auth.currentUser;
            if (!user) { showNotification("يجب تسجيل الدخول أولاً."); btn.disabled = false; return; }
            if (isNaN(amount) || amount <= 0 || !contactInfo.trim()) { showNotification("بيانات غير صحيحة."); btn.disabled = false; return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/requests`), {
                    userId: user.uid, userEmail: user.email, amount, contactInfo, status: 'pending', createdAt: serverTimestamp()
                });
                closeModal(document.getElementById('topup-modal'));
                e.target.reset();
                showNotification("تم إرسال طلبك بنجاح!");
            } catch (error) {
                console.error("Top-up Request Error:", error);
                showNotification("خطأ في إرسال الطلب.");
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            const serviceId = e.target.dataset.serviceId;
            const service = servicesData.find(s => s.id === serviceId);
            const link = document.getElementById('service-link').value;
            const errorEl = document.getElementById('order-error');
            errorEl.classList.add('hidden');
            if (currentUserData.wallet < service.price) {
                errorEl.textContent = "رصيدك غير كافٍ لإتمام هذه العملية.";
                errorEl.classList.remove('hidden');
                btn.disabled = false;
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users`, currentUserData.id);
                await addDoc(collection(db, `artifacts/${appId}/orders`), {
                    userId: currentUserData.id, userEmail: currentUserData.email, serviceId: service.id, serviceName: service.name, price: service.price, link: link, status: 'pending', createdAt: serverTimestamp()
                });
                await updateDoc(userDocRef, { wallet: increment(-service.price) });
                
                closeModal(document.getElementById('order-modal'));
                e.target.reset();
                showNotification("تم تقديم طلبك بنجاح!");
            } catch (error) {
                console.error("Order submission error:", error);
                errorEl.textContent = "حدث خطأ أثناء تقديم الطلب.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const emailInput = document.getElementById('reset-email');
            const errorEl = document.getElementById('reset-error');
            errorEl.classList.add('hidden');
            btn.disabled = true;
            try {
                await sendPasswordResetEmail(auth, emailInput.value);
                closeModal(document.getElementById('reset-password-modal'));
                showNotification("تم إرسال رابط إعادة التعيين إلى بريدك الإلكتروني.");
            } catch (error) {
                console.error("Password Reset Error:", error);
                errorEl.textContent = "لا يوجد حساب مسجل بهذا البريد الإلكتروني.";
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        });

        document.getElementById('search-requests').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allAdminRequests.filter(req => req.userEmail.toLowerCase().includes(searchTerm));
            renderAdminRequests(filtered);
        });

        document.getElementById('search-orders').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allAdminOrders.filter(order => order.userEmail.toLowerCase().includes(searchTerm));
            renderAdminOrders(filtered);
        });
        
        // --- Modal Setup ---
        const setupModalListeners = () => {
            const authModal = document.getElementById('auth-modal');
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            const switchTab = (isLogin) => {
                if (isLogin) {
                    loginTab.classList.add('tab-active');
                    signupTab.classList.remove('tab-active');
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                } else {
                    signupTab.classList.add('tab-active');
                    loginTab.classList.remove('tab-active');
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                }
            };

            loginTab.addEventListener('click', () => switchTab(true));
            signupTab.addEventListener('click', () => switchTab(false));

            document.getElementById('login-btn').addEventListener('click', () => {
                switchTab(true);
                openModal(authModal);
            });
            document.getElementById('signup-btn').addEventListener('click', () => {
                switchTab(false);
                openModal(authModal);
            });

            document.getElementById('close-auth-modal-btn').addEventListener('click', () => closeModal(authModal));
            document.getElementById('close-topup-modal-btn').addEventListener('click', () => closeModal(document.getElementById('topup-modal')));
            document.getElementById('close-order-modal-btn').addEventListener('click', () => closeModal(document.getElementById('order-modal')));
            document.getElementById('close-reset-modal-btn').addEventListener('click', () => closeModal(document.getElementById('reset-password-modal')));

            document.getElementById('topup-btn').addEventListener('click', () => openModal(document.getElementById('topup-modal')));
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                closeModal(authModal);
                openModal(document.getElementById('reset-password-modal'));
            });
        };

        // --- Initial Load ---
        renderServices();
        setupNavLinks();
        setupModalListeners();
        showPage('home-page');

    </script>
</body>
</html>
